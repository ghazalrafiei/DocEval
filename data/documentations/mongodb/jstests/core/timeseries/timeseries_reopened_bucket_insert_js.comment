['text':'*
 * Inserts time-series measurements into closed buckets identified by query-based reopening method.
 *
 * @tags: [
 *   # This test depends on certain writes ending up in the same bucket. Stepdowns and tenant
 *   # migrations may result in writes splitting between two primaries, and thus different buckets.
 *   does_not_support_stepdowns,
 *   tenant_migration_incompatible,
 *   # This test inserts uncompressed buckets directly into the buckets collection. This may cause
 *   # intermittent failures on tenant migration passthroughs when validation checks that all
 *   # buckets are compressed.
 *   tenant_migration_incompatible,
 *   # We need a timeseries collection.
 *   requires_timeseries,
 *   # This test depends on stats read from the primary node in replica sets.
 *   assumes_read_preference_unchanged,
 * ]
 ','line_number':1,'multiline':True]
['text':' When there are no open buckets available and none to reopen, we expect to create a new one.','line_number':66,'multiline':False]
['text':' willCreateBucket ','line_number':67,'multiline':True]
['text':' willReopenBucket ','line_number':67,'multiline':True]
['text':' We don't expect buckets to be created or reopened when a suitable, open bucket exists.','line_number':68,'multiline':False]
['text':' willCreateBucket ','line_number':69,'multiline':True]
['text':' willReopenBucket ','line_number':69,'multiline':True]
['text':' Insert closed bucket into the system.buckets collection.','line_number':131,'multiline':False]
['text':' willCreateBucket ','line_number':134,'multiline':True]
['text':' willReopenBucket ','line_number':134,'multiline':True]
['text':' Now that we reopened 'bucketDoc' we shouldn't have to open a new bucket.','line_number':135,'multiline':False]
['text':' willCreateBucket ','line_number':136,'multiline':True]
['text':' willReopenBucket ','line_number':136,'multiline':True]
['text':' Insert closed bucket into the system.buckets collection.','line_number':138,'multiline':False]
['text':' We expect to reopen buckets with missing 'closed' flags (this means the buckets are open for','line_number':140,'multiline':False]
['text':' inserts).','line_number':141,'multiline':False]
['text':' willCreateBucket ','line_number':142,'multiline':True]
['text':' willReopenBucket ','line_number':142,'multiline':True]
['text':' Insert closed bucket into the system.buckets collection.','line_number':178,'multiline':False]
['text':' Can reopen bucket with complex metadata, even if field order in measurement is different.','line_number':181,'multiline':False]
['text':' willCreateBucket ','line_number':182,'multiline':True]
['text':' willReopenBucket ','line_number':182,'multiline':True]
['text':' Does not reopen bucket with different complex metadata value.','line_number':183,'multiline':False]
['text':' willCreateBucket ','line_number':184,'multiline':True]
['text':' willReopenBucket ','line_number':184,'multiline':True]
['text':' willCreateBucket ','line_number':206,'multiline':True]
['text':' willReopenBucket ','line_number':206,'multiline':True]
['text':' Archive the original bucket due to time forward.','line_number':207,'multiline':False]
['text':' willCreateBucket ','line_number':208,'multiline':True]
['text':' willReopenBucket ','line_number':208,'multiline':True]
['text':' Reopen original bucket.','line_number':209,'multiline':False]
['text':' willCreateBucket ','line_number':210,'multiline':True]
['text':' willReopenBucket ','line_number':210,'multiline':True]
['text':' willCreateBucket= ','line_number':242,'multiline':True]
['text':' willReopenBucket= ','line_number':242,'multiline':True]
['text':' Time forwards will open a new bucket, and close and compress the old one.','line_number':244,'multiline':False]
['text':' willCreateBucket ','line_number':245,'multiline':True]
['text':' willReopenBucket ','line_number':245,'multiline':True]
['text':' We expect to reopen the compressed bucket with time backwards.','line_number':251,'multiline':False]
['text':' willCreateBucket= ','line_number':252,'multiline':True]
['text':' willReopenBucket= ','line_number':252,'multiline':True]
['text':' If an otherwise suitable bucket has the closed flag set, we expect to open a new bucket.','line_number':378,'multiline':False]
['text':' willCreateBucket ','line_number':379,'multiline':True]
['text':' willReopenBucket ','line_number':379,'multiline':True]
['text':' If an otherwise suitable bucket is compressed, we expect to open a new bucket.','line_number':382,'multiline':False]
['text':' willCreateBucket ','line_number':383,'multiline':True]
['text':' willReopenBucket ','line_number':383,'multiline':True]
['text':' If an otherwise suitable bucket is compressed and closed, we expect to open a new bucket.','line_number':386,'multiline':False]
['text':' willCreateBucket ','line_number':387,'multiline':True]
['text':' willReopenBucket ','line_number':387,'multiline':True]
['text':' If an otherwise suitable bucket has an incompatible time range with the measurement, we','line_number':390,'multiline':False]
['text':' expect to open a new bucket.','line_number':391,'multiline':False]
['text':' willCreateBucket ','line_number':392,'multiline':True]
['text':' willReopenBucket ','line_number':392,'multiline':True]
['text':' If an otherwise suitable bucket has a mismatching meta field, we expect to open a new bucket.','line_number':395,'multiline':False]
['text':' willCreateBucket ','line_number':396,'multiline':True]
['text':' willReopenBucket ','line_number':396,'multiline':True]
['text':' We expect to reopen the suitable bucket when inserting the first measurement.','line_number':485,'multiline':False]
['text':' willCreateBucket ','line_number':486,'multiline':True]
['text':' willReopenBucket ','line_number':486,'multiline':True]
['text':' Drop the meta time index.','line_number':488,'multiline':False]
['text':' We have a suitable bucket for the second measurement but it is only visible via query-based','line_number':496,'multiline':False]
['text':' reopening which is not supported without the meta and time index.','line_number':497,'multiline':False]
['text':' willCreateBucket ','line_number':498,'multiline':True]
['text':' willReopenBucket ','line_number':498,'multiline':True]
['text':' Create a meta and time index for query-based reopening.','line_number':500,'multiline':False]
['text':' Creating an index on meta and time will re-enable us to perform query-based reopening to','line_number':505,'multiline':False]
['text':' insert measurement 3 into a suitable bucket.','line_number':506,'multiline':False]
['text':' willCreateBucket ','line_number':507,'multiline':True]
['text':' willReopenBucket ','line_number':507,'multiline':True]
['text':' Drop the meta time index.','line_number':614,'multiline':False]
['text':' Create a partial index on meta and time.','line_number':621,'multiline':False]
['text':' We expect no buckets to be reopened because a partial index on meta and time cannot be used','line_number':627,'multiline':False]
['text':' for query based reopening.','line_number':628,'multiline':False]
['text':' willCreateBucket ','line_number':629,'multiline':True]
['text':' willReopenBucket ','line_number':629,'multiline':True]
['text':' Create an index on an arbitrary field.','line_number':631,'multiline':False]
['text':' We expect no buckets to be reopened because the index created cannot be used for query-based','line_number':635,'multiline':False]
['text':' reopening.','line_number':636,'multiline':False]
['text':' willCreateBucket ','line_number':637,'multiline':True]
['text':' willReopenBucket ','line_number':637,'multiline':True]
['text':' Create an index on an arbitrary field in addition to the meta and time fields.','line_number':639,'multiline':False]
['text':' We expect no buckets to be reopened because the index created cannot be used for','line_number':644,'multiline':False]
['text':' query-based reopening.','line_number':645,'multiline':False]
['text':' willCreateBucket ','line_number':646,'multiline':True]
['text':' willReopenBucket ','line_number':646,'multiline':True]
['text':' Create a meta and time index with an additional key on another arbitrary, data field.','line_number':648,'multiline':False]
['text':' We expect to be able to reopen the suitable bucket when inserting the measurement because as','line_number':653,'multiline':False]
['text':' long as an index covers the meta and time field, it can have additional keys.','line_number':654,'multiline':False]
['text':' willCreateBucket ','line_number':655,'multiline':True]
['text':' willReopenBucket ','line_number':655,'multiline':True]
['text':' Since the collection was created without a meta field, the index on meta and time shouldn't','line_number':728,'multiline':False]
['text':' exist.','line_number':729,'multiline':False]
['text':' If the collection is sharded, there will be an index on control.min.time that can satisfy the','line_number':735,'multiline':False]
['text':' reopening query, otherwise we can do some further tests.','line_number':736,'multiline':False]
['text':' Create a partial index on time.','line_number':738,'multiline':False]
['text':' We expect no buckets to be reopened because a partial index on time cannot be used  for','line_number':743,'multiline':False]
['text':' query based reopening.','line_number':744,'multiline':False]
['text':' willCreateBucket ','line_number':746,'multiline':True]
['text':' willReopenBucket ','line_number':746,'multiline':True]
['text':' Create an index on an arbitrary field.','line_number':748,'multiline':False]
['text':' We expect no buckets to be reopened because the index created cannot be used for','line_number':752,'multiline':False]
['text':' query-based reopening.','line_number':753,'multiline':False]
['text':' willCreateBucket ','line_number':755,'multiline':True]
['text':' willReopenBucket ','line_number':755,'multiline':True]
['text':' Create an index on time.','line_number':757,'multiline':False]
['text':' We expect to be able to reopen the suitable bucket when inserting the measurement because','line_number':761,'multiline':False]
['text':' as long as an index covers time field (when the collection has no metaField), it can have','line_number':762,'multiline':False]
['text':' additional keys.','line_number':763,'multiline':False]
['text':' willCreateBucket ','line_number':765,'multiline':True]
['text':' willReopenBucket ','line_number':765,'multiline':True]
