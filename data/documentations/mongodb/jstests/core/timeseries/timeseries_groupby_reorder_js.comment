['text':'*
 * Test the behavior of $group on time-series collections. Specifically, we are targeting rewrites
 * that replace bucket unpacking with $group over the buckets collection. Currently, only $min/$max
 * are supported for the rewrites.
 *
 * @tags: [
 *   directly_against_shardsvrs_incompatible,
 *   does_not_support_stepdowns,
 *   does_not_support_transactions,
 *   requires_fcv_61,
 * ]
 ','line_number':1,'multiline':True]
['text':' We will only check correctness of the results here as checking the plan in JSTests is brittle and','line_number':17,'multiline':False]
['text':' is better done in document_source_internal_unpack_bucket_test/group_reorder_test.cpp. For the','line_number':18,'multiline':False]
['text':' cases when the re-write isn't applicable, the used datasets should yield wrong result if the','line_number':19,'multiline':False]
['text':' re-write is applied.','line_number':20,'multiline':False]
['text':' Test with measurement group key -- a rewrite in this situation would be wrong.','line_number':35,'multiline':False]
['text':' global min','line_number':39,'multiline':False]
['text':' min for key = 1','line_number':40,'multiline':False]
['text':' max for key = 1','line_number':41,'multiline':False]
['text':' global max','line_number':42,'multiline':False]
['text':' Test with a constant group key. The $group rewrite applies.','line_number':52,'multiline':False]
['text':' Test with a group key that is optimized to a constant. The $group rewrite applies.','line_number':66,'multiline':False]
['text':' Test with a null group key and the collection has no metaField. The $group rewrite applies.','line_number':80,'multiline':False]
['text':' excludeMeta ','line_number':91,'multiline':True]
['text':' With a filter on meta the group re-write does apply if the group key is const.','line_number':94,'multiline':False]
['text':' In presence of a non-meta filter the group re-write doesn't apply even if the group key is const.','line_number':111,'multiline':False]
['text':' Test with meta group key. The group re-write applies.','line_number':127,'multiline':False]
['text':' Test with meta group key preceeded by a filter on the meta key. The re-write still applies.','line_number':144,'multiline':False]
['text':' Test with meta group key preceeded by a filter on a measurement key. The re-write doesn't apply.','line_number':161,'multiline':False]
['text':' Test SERVER-73822 fix: complex $min and $max (i.e. not just straight field refs) work correctly.','line_number':179,'multiline':False]
['text':' min(a+b) != min(a) + min(b) and max(a+b) != max(a) + max(b)','line_number':182,'multiline':False]
['text':' max(a + b)','line_number':184,'multiline':False]
['text':' min(a + b)','line_number':186,'multiline':False]
['text':' Test with meta group key and a non-min/max accumulator that uses only the meta field. This query','line_number':196,'multiline':False]
['text':' is _not_ eligible for the re-write w/o bucket unpacking because while it doesn't depend on any','line_number':197,'multiline':False]
['text':' fields of the individual events it still depends on the number of events in a bucket.','line_number':198,'multiline':False]
['text':' In presence of a filter $min and $max on the meta field cannot be re-written because a filter','line_number':211,'multiline':False]
['text':' might end up selecting nothing in buckets with a particular meta.','line_number':212,'multiline':False]
['text':' Test min on the time field (cannot rewrite $min because the control.time.min is rounded','line_number':222,'multiline':False]
['text':' down).','line_number':223,'multiline':False]
['text':' Test max on the time field (can rewrite $max because the control.time.max is not rounded','line_number':233,'multiline':False]
['text':' down).','line_number':234,'multiline':False]
['text':' Test a group key that is a list of fields that are just referencing the metaField. The $group','line_number':244,'multiline':False]
['text':' rewrite applies.','line_number':245,'multiline':False]
['text':' Test a group key that is a list of fields with some fields referencing the metaField and some','line_number':262,'multiline':False]
['text':' fields are not. The $group rewrite does not apply.','line_number':263,'multiline':False]
['text':' Test a group key that is a list of fields and the collection does not have a metaField. The','line_number':282,'multiline':False]
['text':' rewrite does not apply, since no fields are referencing the metaField.','line_number':283,'multiline':False]
['text':' excludeMeta ','line_number':300,'multiline':True]
['text':'','line_number':303,'multiline':False]
['text':' The following tests validate the behavior of the $group rewrite with the $count accumulator.','line_number':304,'multiline':False]
['text':'','line_number':305,'multiline':False]
['text':' Test with a meta group key, and the $count accumulator. The rewrite should apply.','line_number':307,'multiline':False]
['text':' Test with a meta group key, and {$sum: 1}. Since $count desugars to {$sum:1}, the rewrite should','line_number':324,'multiline':False]
['text':' apply.','line_number':325,'multiline':False]
['text':' Test with a meta group key, and {$sum: 7}. The group rewrite doesn't apply in this case but we','line_number':337,'multiline':False]
['text':' do a different optimization that takes into account that no fields should be unpacked.','line_number':338,'multiline':False]
['text':' Test with a constant group key with the $count accumulator when there is no metaField. The','line_number':351,'multiline':False]
['text':' rewrite should apply.','line_number':352,'multiline':False]
['text':' excludeMeta ','line_number':363,'multiline':True]
['text':' Test with a meta group key with the $sum accumulator. Even though the rewrite applies for $count','line_number':366,'multiline':False]
['text':' which desugars to {$sum: 1}, for accumulators like {$sum: "$fieldPath"} the rewrite does not','line_number':367,'multiline':False]
['text':' apply.','line_number':368,'multiline':False]
['text':' Test the $count aggregation stage. Since this stage is rewritten to a $group and $project, the','line_number':381,'multiline':False]
['text':' rewrite will apply.','line_number':382,'multiline':False]
['text':' excludeMeta ','line_number':393,'multiline':True]
