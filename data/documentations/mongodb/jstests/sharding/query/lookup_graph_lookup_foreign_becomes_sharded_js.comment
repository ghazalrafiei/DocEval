['text':'*
 * Tests that $lookup and $graphLookup correctly succeed if the foreign collection is sharded, or if
 * it becomes sharded mid-iteration.
 *
 *@tags: [
 *   requires_persistence
 * ]
 ','line_number':1,'multiline':True]
['text':' Enable sharding on the test database, but do not shard any collections yet.','line_number':20,'multiline':False]
['text':' Batch size used for all requests issued during this test.','line_number':23,'multiline':False]
['text':' Helper function to recreate and repopulate the source and foreign collections.','line_number':26,'multiline':False]
['text':' Make sure the number of documents inserted is greater than the batchSize, to ensure the','line_number':28,'multiline':False]
['text':' results cannot all fit in one batch.','line_number':29,'multiline':False]
['text':' Drop the source and foreign collections.','line_number':32,'multiline':False]
['text':' Insert some test documents into both collections. Alternate the insertions between the fresh','line_number':36,'multiline':False]
['text':' and stale mongos so that both have a view of the foreign collection as unsharded.','line_number':37,'multiline':False]
['text':' Set up the test cases. We use the 'localField / foreignField' form of $lookup because it creates','line_number':48,'multiline':False]
['text':' a pipeline whose $match stage is correlated with the foreign collection; this means that we','line_number':49,'multiline':False]
['text':' cannot cache any results, and so each getMore must consult the foreign collection directly.','line_number':50,'multiline':False]
['text':' Similarly, we make sure the documents in the $graphLookup match 1:1. Otherwise, the results for','line_number':51,'multiline':False]
['text':' getMore will be taken from the cache and the operation will remain unaware that the foreign','line_number':52,'multiline':False]
['text':' collection has became sharded mid-iteration.','line_number':53,'multiline':False]
['text':' Drop and recreate both collections, so that both mongos know the foreign collection is unsharded.','line_number':87,'multiline':False]
['text':' Verify that the 'aggregate' command works and produces (batchSize) results, indicating that the','line_number':90,'multiline':False]
['text':' $lookup or $graphLookup succeeded on the unsharded foreign collection.','line_number':91,'multiline':False]
['text':' Use freshMongos to shard the foreignCollection, so staleMongos still thinks it is unsharded.','line_number':98,'multiline':False]
['text':' Now run a getMore for each of the test cases. The foreign collection has become sharded mid-','line_number':102,'multiline':False]
['text':' iteration, but we can recover from this and continue execution.','line_number':103,'multiline':False]
['text':' In the classic lookup, when we compile an internal $match stage for $lookup local','line_number':105,'multiline':False]
['text':' document match against the foreign collection, we try to get a lock on the foreign','line_number':106,'multiline':False]
['text':' collection as the MAIN collection and in the SBE lookup, we try to get a lock on both the','line_number':107,'multiline':False]
['text':' local (MAIN) and foreign (secondary) collection. The thing is we go through different','line_number':108,'multiline':False]
['text':' checks for the main collection and secondary namespaces. For the main collection, we','line_number':109,'multiline':False]
['text':' check the shard version explicitly. For the secondary namespaces, we check sharding','line_number':110,'multiline':False]
['text':' changes based on the snapshot. So, SBE lookup succeeds at getMore request.','line_number':111,'multiline':False]
['text':'','line_number':112,'multiline':False]
['text':' This is a similar situation as SERVER-64128 though it's not exactly same. Until SERVER-64128','line_number':113,'multiline':False]
['text':' is resolved, the expected behavior is not exactly clear and we need to revisit this scenario','line_number':114,'multiline':False]
['text':' after SERVER-64128 is resolved. Until then, just checks whether this scenario succeeds.','line_number':115,'multiline':False]
['text':' Run both test cases again. The fresh mongos knows that the foreign collection is sharded now,','line_number':122,'multiline':False]
['text':' and the query should still work.','line_number':123,'multiline':False]
['text':' Run the test cases through the stale mongos. It should still believe that the foreign collection','line_number':131,'multiline':False]
['text':' is unsharded, but it should recover from this, and the query should still work.','line_number':132,'multiline':False]
['text':' Reset both collections to unsharded and make sure both mongos know.','line_number':140,'multiline':False]
['text':' Ensure the replication recover process isn't needed after restarting the shard. The recovery','line_number':143,'multiline':False]
['text':' process can cause shards to reload their metadata and view the collections as unsharded rather','line_number':144,'multiline':False]
['text':' than unknown.','line_number':145,'multiline':False]
['text':' Now restart the shard's Primary. This will have no metadata loaded on startup, and so we expect','line_number':149,'multiline':False]
['text':' that the first attempt to run $lookup or $graphLookup should produce a stale shard exception for','line_number':150,'multiline':False]
['text':' both the source and foreign collections.','line_number':151,'multiline':False]
['text':' Enable profiling on shard0 to capture stale shard version exceptions.','line_number':154,'multiline':False]
['text':' Wait until both mongos have refreshed their view of the new Primary.','line_number':158,'multiline':False]
['text':' Verify that the 'aggregate' command works and produces (batchSize) results, indicating that the','line_number':164,'multiline':False]
['text':' $lookup or $graphLookup succeeded on the unsharded foreign collection.','line_number':165,'multiline':False]
['text':' ... and a single StaleConfig error for the foreign namespace. These StaleConfig errors are not','line_number':174,'multiline':False]
['text':' always reported in the profiler, but they are reflected in the serverStatus StaleConfig error','line_number':175,'multiline':False]
['text':' counter.','line_number':176,'multiline':False]
