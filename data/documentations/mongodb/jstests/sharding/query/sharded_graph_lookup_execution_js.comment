['text':'*
 * Tests the behavior of a $graphLookup on a sharded 'from' collection in various situations. These
 * include when the local collection is sharded and unsharded, when the $graphLookup can target
 * shards or is scatter-gather, and when the $graphLookup is not top-level.
 *
 * Shard targeting logic for $lookup changed in 7.3 and may not match the expected behavior in a
 * multiversion environment.
 * @tags: [
 *   requires_fcv_73,
 * ]
 ','line_number':1,'multiline':True]
['text':' Turn on the profiler for both shards.','line_number':26,'multiline':False]
['text':' If the primary delegates the $graphLookup merging functionality to a random shard,','line_number':67,'multiline':False]
['text':' confirm the expected behavior here.','line_number':68,'multiline':False]
['text':' Confirm that top-level execution is as expected. In the nested cases, the top level','line_number':85,'multiline':False]
['text':' is a $lookup, so we check either for $lookup or $graphLookup as appropriate.','line_number':86,'multiline':False]
['text':' Confirm that the $graphLookup recursive $match execution is as expected. In the','line_number':100,'multiline':False]
['text':' nested cases, we need to check the $lookup subpipeline execution instead. In either','line_number':101,'multiline':False]
['text':' case, the command is either dispatched as aggregate or is a local read.','line_number':102,'multiline':False]
['text':' Test unsharded local collection and sharded foreign collection, with a targeted $graphLookup.','line_number':128,'multiline':False]
['text':' Because the local collection is unsharded, the $graphLookup stage is executed on the','line_number':160,'multiline':False]
['text':' primary shard of the database.','line_number':161,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the node executing it will','line_number':163,'multiline':False]
['text':' target the shard that holds the relevant data for the sharded foreign collection. Note:','line_number':164,'multiline':False]
['text':' Since $graphLookup maintains a cache of foreign documents, there is only one query per','line_number':165,'multiline':False]
['text':' unique document that we need to look up in the foreign collection.','line_number':166,'multiline':False]
['text':' Test unsharded local collection and sharded foreign collection, with an untargeted $graphLookup.','line_number':170,'multiline':False]
['text':' Because the local collection is unsharded, the $graphLookup stage','line_number':173,'multiline':False]
['text':' is executed on the primary shard of the database.','line_number':174,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the','line_number':176,'multiline':False]
['text':' node executing it will perform a scatter-gather query and open a','line_number':177,'multiline':False]
['text':' cursor on every shard that contains the foreign collection.','line_number':178,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection, with a targeted $graphLookup.','line_number':182,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $graphLookup stage is executed in parallel','line_number':188,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':189,'multiline':False]
['text':' Each node executing the $graphLookup will, for every document that flows through the','line_number':191,'multiline':False]
['text':' stage, target the shard(s) that holds the relevant data for the sharded foreign','line_number':192,'multiline':False]
['text':' collection. The parallel $graphLookups do not share the same cache, so 'ORD' does not','line_number':193,'multiline':False]
['text':' need to be queried for twice, but 'LHR' does.','line_number':194,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection, with an untargeted $graphLookup.','line_number':198,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $graphLookup stage is executed in parallel','line_number':204,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':205,'multiline':False]
['text':' Each node executing the $graphLookup will, for every document that flows through it,','line_number':207,'multiline':False]
['text':' perform a scatter-gather query and open a cursor on every shard that contains the foreign','line_number':208,'multiline':False]
['text':' collection.','line_number':209,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection, with a targeted $graphLookup','line_number':213,'multiline':False]
['text':' including a 'restrictSearchWithMatch' field.','line_number':214,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $graphLookup stage is executed in parallel','line_number':251,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':252,'multiline':False]
['text':' As in the sharded_to_sharded_targeted case, each node targets the shard(s) that holds the','line_number':254,'multiline':False]
['text':' relevant data. As expected, there are queries from both parallel $graphLookup executions','line_number':255,'multiline':False]
['text':' for the LHR airport, and these are filtered out by the 'restrictSearchWithMatch' filter.','line_number':256,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection with a targeted top-level $lookup','line_number':260,'multiline':False]
['text':' and a nested $graphLookup on an unsharded foreign collection.','line_number':261,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $lookup stage is executed in parallel on','line_number':305,'multiline':False]
['text':' every shard that contains the local collection.','line_number':306,'multiline':False]
['text':' Each node executing the $lookup will, for every document that flows through the $lookup','line_number':308,'multiline':False]
['text':' stage, target the shard that holds the relevant data for the sharded foreign collection.','line_number':309,'multiline':False]
['text':' When executing the subpipeline, the nested $graphLookup stage will stay on the merging','line_number':316,'multiline':False]
['text':' half of the pipeline and execute on the merging node, sending requests to execute the','line_number':317,'multiline':False]
['text':' nested $matches on the primary shard (where the unsharded 'airfields' collection is).','line_number':318,'multiline':False]
['text':' Only the $graphLookup on the non-primary shard needs to send requests over the network;','line_number':319,'multiline':False]
['text':' the rest can be done via a local read. The $graphLookups cannot share a cache because','line_number':320,'multiline':False]
['text':' they run indepedently.','line_number':321,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection with a targeted top-level $lookup','line_number':327,'multiline':False]
['text':' and a nested targeted $graphLookup on a sharded foreign collection.','line_number':328,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $lookup stage is executed in parallel','line_number':337,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':338,'multiline':False]
['text':' Each node executing the $lookup will, for every document that flows through the','line_number':340,'multiline':False]
['text':' $lookup stage, target the shard that holds the relevant data for the sharded foreign','line_number':341,'multiline':False]
['text':' collection.','line_number':342,'multiline':False]
['text':' When executing the subpipeline, the nested $graphLookup stage will stay on the','line_number':348,'multiline':False]
['text':' merging half of the pipeline and execute on the merging node, targeting shards to','line_number':349,'multiline':False]
['text':' execute the nested $matches.','line_number':350,'multiline':False]
['text':' Test sharded local collection and sharded foreign collection with a targeted top-level $lookup','line_number':356,'multiline':False]
['text':' and a nested untargeted $graphLookup on a sharded foreign collection.','line_number':357,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $lookup stage is executed in parallel','line_number':365,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':366,'multiline':False]
['text':' Each node executing the $lookup will, for every document that flows through the','line_number':368,'multiline':False]
['text':' $lookup stage, target the shard that holds the relevant data for the sharded foreign','line_number':369,'multiline':False]
['text':' collection.','line_number':370,'multiline':False]
['text':' When executing the subpipeline, the nested $graphLookup stage will stay on the','line_number':376,'multiline':False]
['text':' merging half of the pipeline and execute on the merging node, performing a','line_number':377,'multiline':False]
['text':' scatter-gather query to execute the nested $matches.','line_number':378,'multiline':False]
['text':' Test sharded local collection where the foreign namespace is a sharded view with another','line_number':384,'multiline':False]
['text':' $graphLookup against a sharded collection. Note that the $graphLookup in the view should be','line_number':385,'multiline':False]
['text':' treated as a "nested" $graphLookup and should execute on the merging node.','line_number':386,'multiline':False]
['text':' The 'travelers' collection is sharded, however, the 'from' namespace is a view, so the','line_number':418,'multiline':False]
['text':' $graphLookup stage is executed as a merger.','line_number':419,'multiline':False]
['text':' TODO SERVER-83902: Update this once this pipeline can run in parallel on shards again.','line_number':420,'multiline':False]
['text':' Each node executing the $graphLookup will, for every document that flows through the','line_number':422,'multiline':False]
['text':' stage, target the shard(s) that holds the relevant data for the sharded foreign view.','line_number':423,'multiline':False]
['text':' When executing the subpipeline, the "nested" $graphLookup stage contained in the view','line_number':429,'multiline':False]
['text':' pipeline will stay on the merging half of the pipeline and execute on the merging node,','line_number':430,'multiline':False]
['text':' targeting shards to execute the nested $matches.','line_number':431,'multiline':False]
['text':' Test top-level $lookup on a sharded local collection where the foreign namespace is a sharded','line_number':438,'multiline':False]
['text':' view with a $graphLookup against a sharded collection. Note that the $graphLookup in the view','line_number':439,'multiline':False]
['text':' should be treated as a "nested" $graphLookup and should execute on the merging node.','line_number':440,'multiline':False]
['text':' The 'travelers' collection is sharded, but mongos does not know that the foreign','line_number':471,'multiline':False]
['text':' namespace is a view on a sharded collection. It is instead treated as an unsharded','line_number':472,'multiline':False]
['text':' collection, and the top-level $lookup is only on the primary.','line_number':473,'multiline':False]
['text':' Each node executing the $lookup will, for every document that flows through the stage','line_number':475,'multiline':False]
['text':' target the shard(s) that holds the relevant data for the sharded foreign view.','line_number':476,'multiline':False]
['text':' When executing the subpipeline, the "nested" $graphLookup stage contained in the view','line_number':482,'multiline':False]
['text':' pipeline will stay on the merging half of the pipeline and execute on the merging','line_number':483,'multiline':False]
['text':' node, targeting shards to execute the nested $matches.','line_number':484,'multiline':False]
['text':' Test sharded local collection where the foreign namespace is a sharded view with a $lookup','line_number':491,'multiline':False]
['text':' against a sharded collection. Note that the $lookup in the view should be treated as a "nested"','line_number':492,'multiline':False]
['text':' $lookup and should execute on the merging node.','line_number':493,'multiline':False]
['text':' The 'travelers' collection is sharded, however, the 'from' namespace is a view, so','line_number':541,'multiline':False]
['text':' the $graphLookup stage is executed as a merger.','line_number':542,'multiline':False]
['text':' TODO SERVER-83902: Update this once this pipeline can run in parallel on shards','line_number':543,'multiline':False]
['text':' again.','line_number':544,'multiline':False]
['text':' Each node executing the $graphLookup will, for every document that flows through the','line_number':546,'multiline':False]
['text':' stage, target the shard(s) that holds the relevant data for the sharded foreign view.','line_number':547,'multiline':False]
['text':' When executing the subpipeline, the "nested" $lookup stage contained in the view','line_number':553,'multiline':False]
['text':' pipeline will stay on the merging half of the pipeline and execute on the merging','line_number':554,'multiline':False]
['text':' node, targeting shards to execute the nested subpipelines.','line_number':555,'multiline':False]
['text':' Test that a targeted $graphLookup on a sharded collection can execute correctly on mongos.','line_number':562,'multiline':False]
['text':' Because the $graphLookup is after a $group that requires merging, it is executed on','line_number':604,'multiline':False]
['text':' mongos.','line_number':605,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the mongos executing it','line_number':608,'multiline':False]
['text':' will target the shard that holds the relevant data for the sharded foreign collection.','line_number':609,'multiline':False]
['text':' This time, the query has only one cache for the $graphLookup, so four queries suffice.','line_number':610,'multiline':False]
['text':' Test that an untargeted $graphLookup on a sharded collection can execute correctly on mongos.','line_number':614,'multiline':False]
['text':' Because the $graphLookup is after a $group that requires merging, it is executed on','line_number':623,'multiline':False]
['text':' mongos.','line_number':624,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the mongos executing it','line_number':627,'multiline':False]
['text':' will perform a scatter-gather query and open a cursor on every shard that contains the','line_number':628,'multiline':False]
['text':' foreign collection.','line_number':629,'multiline':False]
['text':' Test that a targeted $graphLookup on a sharded collection can execute correctly when mongos','line_number':633,'multiline':False]
['text':' delegates to a merging shard.','line_number':634,'multiline':False]
['text':' Because the $graphLookup is after a $group that requires merging, but 'allowDiskUse' is','line_number':643,'multiline':False]
['text':' true, the mongos delegates a merging shard to perform the $graphLookup execution.','line_number':644,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the node executing it','line_number':646,'multiline':False]
['text':' will target the shard that holds the relevant data for the sharded foreign collection.','line_number':647,'multiline':False]
['text':' Test that an untargeted $graphLookup on a sharded collection can execute correctly when mongos','line_number':651,'multiline':False]
['text':' delegates to a merging shard.','line_number':652,'multiline':False]
['text':' Because the $graphLookup is after a $group that requires merging, but 'allowDiskUse' is','line_number':661,'multiline':False]
['text':' true, the mongos delegates a merging shard to perform the $graphLookup execution.','line_number':662,'multiline':False]
['text':' For every document that flows through the $graphLookup stage, the node executing it','line_number':664,'multiline':False]
['text':' will perform a scatter-gather query and open a cursor on every shard that contains the','line_number':665,'multiline':False]
['text':'  foreign collection.','line_number':666,'multiline':False]
['text':' Test that multiple top-level $graphLookup stages are able to be run in parallel.','line_number':670,'multiline':False]
['text':' The 'travelers' collection is sharded, so the $graphLookup stage is executed in parallel','line_number':717,'multiline':False]
['text':' on every shard that contains the local collection.','line_number':718,'multiline':False]
['text':' Each node executing the $graphLookup will, for every document that flows through the','line_number':720,'multiline':False]
['text':' stage, target the shard(s) that holds the relevant data for the sharded foreign','line_number':721,'multiline':False]
['text':' collection.','line_number':722,'multiline':False]
['text':' The second $graphLookup stage's expected execution behavior is similar to the first,','line_number':728,'multiline':False]
['text':' executing in parallel on every shard that contains the 'airfields' collection and, for','line_number':729,'multiline':False]
['text':' each node, targeting shards to execute the subpipeline.','line_number':730,'multiline':False]
