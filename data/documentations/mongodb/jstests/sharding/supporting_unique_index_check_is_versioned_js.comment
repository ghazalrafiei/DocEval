['text':' Tests that $merge's enforcement of a unique index on mongos includes a shard and/or database','line_number':1,'multiline':False]
['text':' version.','line_number':2,'multiline':False]
['text':' Creates the source collection and target collection as unsharded collections on shard0.','line_number':25,'multiline':False]
['text':' Creates the source collection as an unsharded collection on shard0 and the target collection as a','line_number':36,'multiline':False]
['text':' sharded collection with one chunk on shard0.','line_number':37,'multiline':False]
['text':'','line_number':85,'multiline':False]
['text':' Verify database versions are used to detect when the primary shard changes for an unsharded','line_number':86,'multiline':False]
['text':' target collection.','line_number':87,'multiline':False]
['text':'','line_number':88,'multiline':False]
['text':' Move the primary from shard0 to shard1 and create an index required for the merge only on the','line_number':96,'multiline':False]
['text':' new primary. Because of database versioning, the stale router should discover the primary has','line_number':97,'multiline':False]
['text':' changed when checking indexes for the merge and load them from the new primary.','line_number':98,'multiline':False]
['text':' Run $merge and expect it to succeed because the stale router refreshes and is able to find','line_number':104,'multiline':False]
['text':' the correct indexes. Enable the profiler to verify shard/db versions later.','line_number':105,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':109,'multiline':False]
['text':' versions.','line_number':110,'multiline':False]
['text':' Create the index necessary for the merge below.','line_number':125,'multiline':False]
['text':' Move the primary from shard0 to shard1 and drop the index required for the merge only on the','line_number':129,'multiline':False]
['text':' new primary. Note that the collection will be dropped from the old primary when the','line_number':130,'multiline':False]
['text':' movePrimary completes, so this case would pass without versioning, but is included for','line_number':131,'multiline':False]
['text':' completeness.','line_number':132,'multiline':False]
['text':' Run $merge and expect it to fail because the router refreshes and discovers the required','line_number':139,'multiline':False]
['text':' index no longer exists. Enable the profiler to verify shard/db versions later.','line_number':140,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':144,'multiline':False]
['text':' versions.','line_number':145,'multiline':False]
['text':'','line_number':154,'multiline':False]
['text':' Verify shard versions are used to detect when the shards that own chunks for a sharded target','line_number':155,'multiline':False]
['text':' collection changes.','line_number':156,'multiline':False]
['text':'','line_number':157,'multiline':False]
['text':' Move the only chunk for the test collection from shard0 to shard1 and create an index','line_number':165,'multiline':False]
['text':' required for the merge. Indexes are only created on shards that own chunks, so the index','line_number':166,'multiline':False]
['text':' will only exist on shard1.','line_number':167,'multiline':False]
['text':' Run $merge and expect it to succeed because the stale router refreshes and is able to find','line_number':174,'multiline':False]
['text':' the correct indexes. Enable the profiler to verify shard/db versions later.','line_number':175,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':179,'multiline':False]
['text':' versions.','line_number':180,'multiline':False]
['text':' Create the index necessary for the merge below.','line_number':195,'multiline':False]
['text':' Move the only chunk for the test collection from shard0 to shard1 and drop the index required','line_number':199,'multiline':False]
['text':' for the merge. dropIndexes will only target shards that own chunks, so the index will still','line_number':200,'multiline':False]
['text':' exist on shard0.','line_number':201,'multiline':False]
['text':' Run $merge and expect it to fail because the router refreshes and discovers the required','line_number':208,'multiline':False]
['text':' index no longer exists. Enable the profiler to verify shard/db versions later.','line_number':209,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':213,'multiline':False]
['text':' versions.','line_number':214,'multiline':False]
['text':'','line_number':223,'multiline':False]
['text':' Verify shard versions are used to detect when an unsharded collection becomes sharded or vice','line_number':224,'multiline':False]
['text':' versa.','line_number':225,'multiline':False]
['text':'','line_number':226,'multiline':False]
['text':' Shard the target collection through a different router, move its only chunk to shard1, and','line_number':234,'multiline':False]
['text':' create a new index required for the merge on only the shard with the chunk.','line_number':235,'multiline':False]
['text':' Run $merge and expect it to succeed because the stale router refreshes and is able to find','line_number':248,'multiline':False]
['text':' the correct indexes. Enable the profiler to verify shard/db versions later.','line_number':249,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':253,'multiline':False]
['text':' versions.','line_number':254,'multiline':False]
['text':' Create the index necessary for the merge below.','line_number':269,'multiline':False]
['text':' Drop and recreate the sharded target collection as an unsharded collection with its primary','line_number':273,'multiline':False]
['text':' on shard1. Dropping the collection will also drop the index required for the merge.','line_number':274,'multiline':False]
['text':' Run $merge and expect it to fail because the router refreshes and discovers the required','line_number':282,'multiline':False]
['text':' index no longer exists. Enable the profiler to verify shard/db versions later.','line_number':283,'multiline':False]
['text':' Verify the aggregation succeeded on the expected shard and included the expected shard/db','line_number':287,'multiline':False]
['text':' versions.','line_number':288,'multiline':False]
