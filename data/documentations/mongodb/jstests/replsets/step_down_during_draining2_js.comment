['text':' Test stepdown during drain mode','line_number':1,'multiline':False]
['text':' 1. Set up a 3-node set. Assume Node 0 is the primary at the beginning for simplicity.','line_number':2,'multiline':False]
['text':' 2. Prevent applying retrieved ops on all secondaries, including Node 1.','line_number':3,'multiline':False]
['text':' 3. Insert data to ensure Node 1 has ops to apply in its queue.','line_number':4,'multiline':False]
['text':' 4. Step up Node 1. Now it enters drain mode, but cannot proceed.','line_number':5,'multiline':False]
['text':' 5. Block Node 1's ability to process stepdowns.','line_number':6,'multiline':False]
['text':' 5. Shut down nodes 0 and 2. Wait until Node 1 begins stepping down due to no longer having a','line_number':7,'multiline':False]
['text':'    majority','line_number':8,'multiline':False]
['text':' 6. Re-enable Node 1's ability to apply operations, ensure that clearing it's buffer doesn't','line_number':9,'multiline':False]
['text':'    cause it to finish drain mode because of the pending stepdown request.','line_number':10,'multiline':False]
['text':' 7. Allow Node 1 to finish stepping down.','line_number':11,'multiline':False]
['text':' Set verbosity for replication on all nodes.','line_number':29,'multiline':False]
['text':' The default WC is majority and rsSyncApplyStop failpoint will prevent satisfying any majority','line_number':51,'multiline':False]
['text':' writes.','line_number':52,'multiline':False]
['text':' Do an initial insert to prevent the secondary from going into recovery','line_number':56,'multiline':False]
['text':' Enable fail point to stop replication.','line_number':62,'multiline':False]
['text':' Secondary doesn't allow writes yet.','line_number':89,'multiline':False]
['text':' Prevent the current primary from stepping down','line_number':93,'multiline':False]
['text':' Fail point needs to be off when node is shut down.','line_number':98,'multiline':False]
['text':' Disable fail point to allow replication and allow secondary to finish drain mode while in the','line_number':104,'multiline':False]
['text':' process of stepping down.','line_number':105,'multiline':False]
['text':' The node should now be able to apply the writes in its buffer.','line_number':110,'multiline':False]
['text':' Now ensure that the node can successfully become primary again.','line_number':127,'multiline':False]
['text':' Check that no writes were lost.','line_number':138,'multiline':False]
