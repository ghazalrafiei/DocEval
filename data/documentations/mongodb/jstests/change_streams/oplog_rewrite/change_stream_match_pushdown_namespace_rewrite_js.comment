['text':' Test that a pipeline of the form [{$changeStream: {}}, {$match: ...}] can rewrite the 'namespace'','line_number':1,'multiline':False]
['text':' and apply it to oplog-format documents in order to filter out results as early as possible.','line_number':2,'multiline':False]
['text':' @tags: [','line_number':3,'multiline':False]
['text':'   requires_fcv_63,','line_number':4,'multiline':False]
['text':'   requires_pipeline_optimization,','line_number':5,'multiline':False]
['text':'   requires_sharding,','line_number':6,'multiline':False]
['text':'   uses_change_streams,','line_number':7,'multiline':False]
['text':'   change_stream_does_not_expect_txns,','line_number':8,'multiline':False]
['text':'   assumes_unsharded_collection,','line_number':9,'multiline':False]
['text':'   assumes_read_preference_unchanged','line_number':10,'multiline':False]
['text':' ]','line_number':11,'multiline':False]
['text':' Create a sharded collection in the main test database.','line_number':31,'multiline':False]
['text':' shardKey ','line_number':32,'multiline':True]
['text':' splitAt ','line_number':32,'multiline':True]
['text':' Create a sharded collection in the "other" database.','line_number':34,'multiline':False]
['text':' shardKey ','line_number':36,'multiline':True]
['text':' splitAt ','line_number':36,'multiline':True]
['text':' A helper that opens a change stream on the whole cluster with the user supplied match expression','line_number':38,'multiline':False]
['text':' 'userMatchExpr' and validates that:','line_number':39,'multiline':False]
['text':' 1. for each shard, the events are seen in that order as specified in 'expectedResult'','line_number':40,'multiline':False]
['text':' 2. the filtering is been done at oplog level','line_number':41,'multiline':False]
['text':' Enable a failpoint that will prevent $expr match expressions from generating $_internalExprEq','line_number':55,'multiline':False]
['text':' or similar expressions. This ensures that the following test-cases only exercise the $expr','line_number':56,'multiline':False]
['text':' rewrites.','line_number':57,'multiline':False]
['text':' Create some new collections to ensure that test cases has sufficient namespaces to verify','line_number':65,'multiline':False]
['text':' that the namespace filtering is working correctly.','line_number':66,'multiline':False]
['text':' shardKey ','line_number':67,'multiline':True]
['text':' splitAt ','line_number':67,'multiline':True]
['text':' shardKey ','line_number':69,'multiline':True]
['text':' splitAt ','line_number':69,'multiline':True]
['text':' shardKey ','line_number':70,'multiline':True]
['text':' splitAt ','line_number':70,'multiline':True]
['text':' Open a change stream and store the resume token. This resume token will be used to replay the','line_number':72,'multiline':False]
['text':' stream after this point.','line_number':73,'multiline':False]
['text':' For each collection, insert 2 documents, one on each shard. These will create oplog events and','line_number':77,'multiline':False]
['text':' change stream will apply various namespace filtering on these collections to verify that the','line_number':78,'multiline':False]
['text':' namespace is rewritten correctly. Each documents also contains field names matching with that of','line_number':79,'multiline':False]
['text':' '$cmd' operations, ie. 'renameCollection', 'drop' and 'dropDatabase', but with value-type other','line_number':80,'multiline':False]
['text':' than strings. The 'ns' match filters should gracefully handle the type mismatch and not throw any','line_number':81,'multiline':False]
['text':' error.','line_number':82,'multiline':False]
['text':'','line_number':83,'multiline':False]
['text':' Each of these inserted documents will be represented in this form in the oplog:','line_number':84,'multiline':False]
['text':'   {... "o": {"_id": <id>, "renameCollection": true, "drop": {}, "dropDatabase": null}, ...}','line_number':85,'multiline':False]
['text':'','line_number':86,'multiline':False]
['text':' A few collections are renamed and dropped to verify that these are filtered properly.','line_number':87,'multiline':False]
['text':' Insert some documents into 'coll4' with field names which match known command types. Despite the','line_number':97,'multiline':False]
['text':' fact that these documents could potentially match with the partial 'ns' filter we rewrite into','line_number':98,'multiline':False]
['text':' the oplog, the {op: "c"} predicate we add into the filter should ensure that they are correctly','line_number':99,'multiline':False]
['text':' discarded.','line_number':100,'multiline':False]
['text':' These events from unmonitored collection should not been seen unexpectedly.','line_number':112,'multiline':False]
['text':' This group of tests ensures that the '$match' on a particular namespace object only sees its','line_number':118,'multiline':False]
['text':' documents and only required document(s) are returned at the oplog for each shard.','line_number':119,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':123,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':127,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':131,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':135,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':139,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':143,'multiline':True]
['text':' Ensure that the '$match' on the namespace with only db component should not emit any document and','line_number':145,'multiline':False]
['text':' the oplog should not return any documents.','line_number':146,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':148,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':152,'multiline':True]
['text':' Ensure that the namespace object with 'unknown' collection does not exists and the oplog cursor','line_number':154,'multiline':False]
['text':' returns 0 document.','line_number':155,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':159,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':163,'multiline':True]
['text':' Ensure that the namespace object with flipped fields does not match with the namespace object and','line_number':165,'multiline':False]
['text':' the oplog cursor returns 0 document.','line_number':166,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':170,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':174,'multiline':True]
['text':' Ensure that the namespace object with extra fields does not match with the namespace object and','line_number':176,'multiline':False]
['text':' the oplog cursor returns 0 document.','line_number':177,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':181,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':186,'multiline':True]
['text':' Ensure that the empty namespace object does not match with the namespace object and the oplog','line_number':188,'multiline':False]
['text':' cursor returns 0 document.','line_number':189,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':194,'multiline':True]
['text':' Ensure the '$match' on namespace's db should return documents for all collection and oplog should','line_number':196,'multiline':False]
['text':' return all documents for each shard.','line_number':197,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':206,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':215,'multiline':True]
['text':' These cases ensure that the '$match' on regex of namespace' db, should return documents for all','line_number':217,'multiline':False]
['text':' collection and oplog should return all documents for each shard.','line_number':218,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':227,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':237,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':246,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':259,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':268,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':285,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':294,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':311,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':320,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':336,'multiline':True]
['text':' Ensure that the '$match' on non-existing db should not return any document and oplog should not','line_number':338,'multiline':False]
['text':' return any document for each shard.','line_number':339,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':341,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':345,'multiline':True]
['text':' Ensure that the '$match' on empty db should not return any document and oplog should not return','line_number':347,'multiline':False]
['text':' any document for each shard.','line_number':348,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':350,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':354,'multiline':True]
['text':' Ensure that the '$match' on sub field of db should not return any document and oplog should not','line_number':356,'multiline':False]
['text':' return any document for each shard.','line_number':357,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':361,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':365,'multiline':True]
['text':' This group of tests ensures that the '$match' on collection field path should emit only the','line_number':367,'multiline':False]
['text':' required documents and oplog should return only required document(s) for each shard.','line_number':368,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':372,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':376,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':380,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':384,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':388,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':392,'multiline':True]
['text':' This group of tests ensures that the '$match' on the regex of the collection field path should','line_number':394,'multiline':False]
['text':' emit only the required documents and oplog should return only required document(s) for each','line_number':395,'multiline':False]
['text':' shard.','line_number':396,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':400,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':404,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':408,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':412,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':416,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':420,'multiline':True]
['text':' This group of tests ensures that the '$match' on the regex matching all collections should return','line_number':422,'multiline':False]
['text':' documents from all collection and oplog should return all document for each shard.','line_number':423,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':432,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':441,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':450,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':460,'multiline':True]
['text':' Ensure that the '$match' on the regex matching 3 collection should return documents from these','line_number':462,'multiline':False]
['text':' collections and oplog should return required documents for each shard.','line_number':463,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':471,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':480,'multiline':True]
['text':' Ensure that the '$match' on the regex to exclude 'coll1', 'coll2' and 'coll4' should return only','line_number':482,'multiline':False]
['text':' documents from 'coll.coll3' and oplog should return required documents for each shard.','line_number':483,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':487,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':491,'multiline':True]
['text':' Ensure that the '$match' on non-existing collection should not return any document and oplog','line_number':493,'multiline':False]
['text':' should not return any document for each shard.','line_number':494,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':498,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':502,'multiline':True]
['text':' Ensure that the '$match' on empty collection should not return any document and oplog should not','line_number':504,'multiline':False]
['text':' return any document for each shard.','line_number':505,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':507,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':511,'multiline':True]
['text':' Ensure that the '$match' on sub field of collection should not return any document and oplog','line_number':513,'multiline':False]
['text':' should not return any document for each shard.','line_number':514,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':518,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':522,'multiline':True]
['text':' Ensure that '$in' on db should return all documents and oplog should return all documents for','line_number':524,'multiline':False]
['text':' each shard.','line_number':525,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':534,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':543,'multiline':True]
['text':' This group of tests ensures that '$in' and equivalent '$expr' expression on regex matching the db','line_number':545,'multiline':False]
['text':' name should return all documents and oplog should return all documents for each shard.','line_number':546,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':555,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':565,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':574,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':592,'multiline':True]
['text':' Ensure that an empty '$in' on db path should not match any collection and oplog should not return','line_number':594,'multiline':False]
['text':' any document for each shard.','line_number':595,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':597,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':601,'multiline':True]
['text':' Ensure that '$in' with invalid db cannot be rewritten and oplog should return all documents for','line_number':603,'multiline':False]
['text':' each shard.','line_number':604,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':613,'multiline':True]
['text':' Ensure tht '$expr' with mix of valid and invalid db names should return required documents at the','line_number':615,'multiline':False]
['text':' oplog for each shard.','line_number':616,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':625,'multiline':True]
['text':' Ensure that '$in' on db path with mix of string and regex can be rewritten and oplog should','line_number':627,'multiline':False]
['text':' return '0' document for each shard.','line_number':628,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':632,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':645,'multiline':True]
['text':' Ensure that '$in' on multiple collections should return the required documents and oplog should','line_number':647,'multiline':False]
['text':' return required documents for each shard.','line_number':648,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':653,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':658,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':662,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':666,'multiline':True]
['text':' Ensure that '$in' on regex of multiple collections should return the required documents and oplog','line_number':668,'multiline':False]
['text':' should return required documents for each shard.','line_number':669,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':673,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':686,'multiline':True]
['text':' This group of tests ensures that '$in' and equivalent '$expr' expression on regex of matching all','line_number':688,'multiline':False]
['text':' collections should return all documents and oplog should return all documents for each shard.','line_number':689,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':698,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':715,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':724,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':742,'multiline':True]
['text':' Ensure that an empty '$in' should not match any collection and oplog should not return any','line_number':744,'multiline':False]
['text':' document for each shard.','line_number':745,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':749,'multiline':True]
['text':' Ensure that '$in' with invalid collection cannot be rewritten and oplog should return all','line_number':751,'multiline':False]
['text':' documents for each shard.','line_number':752,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':756,'multiline':True]
['text':' Ensure that '$expr' on '$in' with mix of valid and invalid collections should return only','line_number':758,'multiline':False]
['text':' required documents at oplog for each shard.','line_number':759,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':763,'multiline':True]
['text':' Ensure that '$in' with mix of string and regex matching collections can be rewritten and oplog','line_number':765,'multiline':False]
['text':' should return required documents for each shard.','line_number':766,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':773,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':789,'multiline':True]
['text':' Ensure that '$in' and equivalent '$expr' expression with mix of string and regex can be rewritten','line_number':791,'multiline':False]
['text':' and oplog should return '0' document for each shard.','line_number':792,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':796,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':809,'multiline':True]
['text':' This group of tests ensure that '$nin' and equivalent '$expr' expression on db path should return','line_number':811,'multiline':False]
['text':' all documents and oplog should return all documents for each shard.','line_number':812,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':822,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':832,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':842,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':852,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':863,'multiline':True]
['text':' These group of tests ensure that '$nin' and equivalent '$expr' expression on matching db name','line_number':865,'multiline':False]
['text':' should only return documents from unmonitored db and oplog should return only required documents','line_number':866,'multiline':False]
['text':' from unmonitored db.','line_number':867,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':871,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':875,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':879,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':895,'multiline':True]
['text':' Ensure that '$nin' and equivalent '$expr' expression on multiple collections should return the','line_number':897,'multiline':False]
['text':' required documents and oplog should return required documents for each shard.','line_number':898,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':903,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':908,'multiline':True]
['text':' Ensure that '$nin' and equivalent '$expr' expression on regex of multiple collections should','line_number':910,'multiline':False]
['text':' return the required documents and oplog should return required documents for each shard.','line_number':911,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':916,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':933,'multiline':True]
['text':' Ensure that '$nin' and equivalent '$expr' expression on regex of matching all collections should','line_number':935,'multiline':False]
['text':' return documents from unmonitored db and oplog should also return documentss for unmonitored db','line_number':936,'multiline':False]
['text':' each shard.','line_number':937,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':941,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':956,'multiline':True]
['text':' Ensure that an empty '$nin' and equivalent '$expr' expression should match all collections and','line_number':958,'multiline':False]
['text':' oplog should return all documents for each shard.','line_number':959,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':969,'multiline':True]
['text':' Ensure that '$nin' with invalid collection cannot be rewritten and oplog should return all','line_number':971,'multiline':False]
['text':' documents for each shard.','line_number':972,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':981,'multiline':True]
['text':' Ensure that '$expr' with mix of valid and invalid collection should return required documents at','line_number':983,'multiline':False]
['text':' the oplog for each shard.','line_number':984,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':993,'multiline':True]
['text':' Ensure that '$nin' and equivalent '$expr' expression with mix of string and regex can be','line_number':995,'multiline':False]
['text':' rewritten and oplog should return required documents for each shard.','line_number':996,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':1001,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1017,'multiline':True]
['text':' At this stage, the coll2 has been renamed to 'newColl2' and coll3 has been dropped. The test from','line_number':1019,'multiline':False]
['text':' here will drop the database and ensure that the 'ns' filter when applied over the collection','line_number':1020,'multiline':False]
['text':' should only emit the 'drop' event for that collection and not the 'dropDatabase' event. It should','line_number':1021,'multiline':False]
['text':' be noted that for 'newColl2' and 'coll3', the 'dropDatabase' will be no-op and will not emit any','line_number':1022,'multiline':False]
['text':' documents.','line_number':1023,'multiline':False]
['text':' Open a new change streams and verify that from here onwards the events related to 'dropDatabase'','line_number':1025,'multiline':False]
['text':' are seen.','line_number':1026,'multiline':False]
['text':' This group of tests ensures that the match on 'coll1' only sees the 'drop' events.','line_number':1032,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':1036,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1040,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1044,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1048,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1052,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1056,'multiline':True]
['text':' Ensure that the '$ns' object containing only 'db' should see only the 'dropDatabase' event and','line_number':1058,'multiline':False]
['text':' only the required documents gets returned at the oplog for each shard.','line_number':1059,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':1064,'multiline':True]
['text':' expectedOplogRetDocsForEachShard ','line_number':1069,'multiline':True]
['text':' Create two sharded collections in the main test database, then start a new change stream to get a','line_number':1071,'multiline':False]
['text':' fresh resume token.','line_number':1072,'multiline':False]
['text':' shardKey ','line_number':1074,'multiline':True]
['text':'splitAt ','line_number':1074,'multiline':True]
['text':' shardKey ','line_number':1076,'multiline':True]
['text':'splitAt ','line_number':1076,'multiline':True]
['text':' Insert one document per collection, per shard. The test cases below verify the behavior of regex','line_number':1080,'multiline':False]
['text':' matches with escaped characters on collections with special names (e.g. containing dots). This','line_number':1081,'multiline':False]
['text':' exercises the fix for SERVER-67715.','line_number':1082,'multiline':False]
['text':' Ensure that a regex match properly respects escaped characters (here, testing that the escaped','line_number':1088,'multiline':False]
['text':' "." character is treated as a literal dot).','line_number':1089,'multiline':False]
['text':' expectedOplogRetDocsForEachShard ','line_number':1093,'multiline':True]
