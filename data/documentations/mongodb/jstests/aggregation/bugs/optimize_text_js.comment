['text':' Ensures TEXT_OR stage is elided or replaced with OR stage when possible.','line_number':1,'multiline':False]
['text':' @tags: [','line_number':2,'multiline':False]
['text':'   # We don't try to replace TEXT_OR with OR when the results are consumed by a merging node,','line_number':3,'multiline':False]
['text':'   # because the shard doesn't know whether the merger needs the textScore metadata.','line_number':4,'multiline':False]
['text':'   assumes_unsharded_collection,','line_number':5,'multiline':False]
['text':' ]','line_number':6,'multiline':False]
['text':' The .find() plan doesn't have TEXT_OR, it has OR instead.','line_number':16,'multiline':False]
['text':' Both kinds of stages deduplicate record IDs, but OR is better because OR is streaming','line_number':17,'multiline':False]
['text':' while TEXT_OR is blocking. TEXT_OR is blocking because it has to accumulate the textScore','line_number':18,'multiline':False]
['text':' of each record ID, so when textScore is unused we can use the more efficient OR.','line_number':19,'multiline':False]
['text':' The same optimization should apply to the equivalent aggregation query. Before SERVER-47848 we','line_number':23,'multiline':False]
['text':' failed to apply this optimization because we were too conservative about dependency tracking.','line_number':24,'multiline':False]
['text':' Specifically, before SERVER-47848 we assumed that the consumer of a pipeline might depend on','line_number':25,'multiline':False]
['text':' textScore if all the stages preserve it. We made that assumption because in a sharded cluster,','line_number':26,'multiline':False]
['text':' when a merger sends the shardsPart of a pipeline to the shards, it doesn't specify whether it','line_number':27,'multiline':False]
['text':' depends on textScore. After SERVER-47848, we refined that assumption: the shard can tell whether','line_number':28,'multiline':False]
['text':' the consumer is a merger by looking at needsMerge. If the consumer is not a merger, there won't','line_number':29,'multiline':False]
['text':' be an implicit dependency on textScore.','line_number':30,'multiline':False]
['text':' Non-blocking $text plans with just one search term do not need an OR stage, as a further','line_number':34,'multiline':False]
['text':' optimization.','line_number':35,'multiline':False]
