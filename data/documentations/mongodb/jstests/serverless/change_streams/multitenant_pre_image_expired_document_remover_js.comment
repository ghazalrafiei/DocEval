['text':'*
 * Tests the pre-image collection periodic remover job in serverless environment.
 *
 * @tags: [requires_fcv_62]
 ','line_number':1,'multiline':True]
['text':' Set up the replica set with one nodes and two collections with 'changeStreamPreAndPostImages'','line_number':18,'multiline':False]
['text':' enabled and run expired pre-image removal job every 'kPreImageRemovalJobSleepSecs' seconds.','line_number':19,'multiline':False]
['text':' If 'UseUnreplicatedTruncatesForDeletions' feature flag is enabled, the test expects','line_number':25,'multiline':False]
['text':' documents to be removed 1 by 1.','line_number':26,'multiline':False]
['text':' Hard code a tenant ids such that tenants can be identified deterministically.','line_number':32,'multiline':False]
['text':' Create connections to the primary such that they have respective tenant ids stamped.','line_number':46,'multiline':False]
['text':' Create a tenant connection associated with 'notUsedTenantId' such that only the tenant id exists','line_number':53,'multiline':False]
['text':' in the replica set but no corresponding pre-images collection exists. The purging job should','line_number':54,'multiline':False]
['text':' safely ignore this tenant without any side-effects.','line_number':55,'multiline':False]
['text':' Create connections to the secondary such that they have respective tenant ids stamped.','line_number':59,'multiline':False]
['text':' Using fast-count relies on reading the metadata document count. Depending on whether removal uses','line_number':65,'multiline':False]
['text':' replicated deletes or unreplicated truncates, this count may or may not be correct since it's','line_number':66,'multiline':False]
['text':' only an approximation. To avoid accuracy issues, we perform a slow count which will provide an','line_number':67,'multiline':False]
['text':' accurate document count.','line_number':68,'multiline':False]
['text':' Enable change streams for 'tenant1' and 'tenant2', but not for 'notUsedTenant'.','line_number':83,'multiline':False]
['text':' Create the 'stocks' collection on all three tenants.','line_number':95,'multiline':False]
['text':' Enable pre-images collection for 'tenant1' and 'tenant2' but not for 'notUsedTenant'.','line_number':96,'multiline':False]
['text':' Insert some documents. They should not create pre-images documents.','line_number':104,'multiline':False]
['text':' Modify data to generate pre-images.','line_number':112,'multiline':False]
['text':' This update should not be captured captured by 'pre-images' collection, as it does not exist for','line_number':115,'multiline':False]
['text':' 'notUsedTenant'.','line_number':116,'multiline':False]
['text':' Verify that the pre-image collections are replicated correctly.','line_number':122,'multiline':False]
['text':' Verify that serverStatus does not report metrics aside from the 'purgingJob' in a multi-tenant','line_number':127,'multiline':False]
['text':' environment.','line_number':128,'multiline':False]
['text':' Let pre-images of tenant1 expire soon.','line_number':145,'multiline':False]
['text':' The pre-images of tenant1 should expire, but the pre-images of tenant2 should not.','line_number':148,'multiline':False]
['text':' Verify the pre-images collections are eventually in sync between the secondary and primary.','line_number':153,'multiline':False]
['text':' Replicated deletes ensure the secondary and primary will instantly be in sync after awaiting','line_number':162,'multiline':False]
['text':' replication.','line_number':163,'multiline':False]
['text':' Wait long enough for the purging job to finish. The pre-images of 'tenant2' should still not','line_number':169,'multiline':False]
['text':' expire.','line_number':170,'multiline':False]
['text':' Let pre-images of tenant2 expire soon.','line_number':174,'multiline':False]
['text':' Ensure pre-images are expired on the secondary.','line_number':179,'multiline':False]
