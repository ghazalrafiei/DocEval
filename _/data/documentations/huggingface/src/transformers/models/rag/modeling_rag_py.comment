['text':' coding=utf-8','line_number':1,'multiline':False]['text':' Copyright 2020, The RAG Authors and The HuggingFace Inc. team.','line_number':2,'multiline':False]['text':'','line_number':3,'multiline':False]['text':' Licensed under the Apache License, Version 2.0 (the "License");','line_number':4,'multiline':False]['text':' you may not use this file except in compliance with the License.','line_number':5,'multiline':False]['text':' You may obtain a copy of the License at','line_number':6,'multiline':False]['text':'','line_number':7,'multiline':False]['text':'     http://www.apache.org/licenses/LICENSE-2.0','line_number':8,'multiline':False]['text':'','line_number':9,'multiline':False]['text':' Unless required by applicable law or agreed to in writing, software','line_number':10,'multiline':False]['text':' distributed under the License is distributed on an "AS IS" BASIS,','line_number':11,'multiline':False]['text':' WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.','line_number':12,'multiline':False]['text':' See the License for the specific language governing permissions and','line_number':13,'multiline':False]['text':' limitations under the License.','line_number':14,'multiline':False]['text':' At the moment fast initialization is not supported','line_number':238,'multiline':False]['text':' for composite models','line_number':239,'multiline':False]['text':' remove question_encoder, generator kwargs from kwargs','line_number':327,'multiline':False]['text':' Load and initialize the question_encoder and generator','line_number':333,'multiline':False]['text':' The distinction between question_encoder and generator at the model level is made','line_number':334,'multiline':False]['text':' by the value of the flag `is_generator` that we need to set correctly.','line_number':335,'multiline':False]['text':' instantiate config with corresponding kwargs','line_number':379,'multiline':False]['text':' or maybe just use a `set_retriever(...)` method','line_number':496,'multiline':False]['text':' whether retriever has to be used','line_number':579,'multiline':False]['text':' encoder_outputs are pre-computed during RAG-token generation','line_number':585,'multiline':False]['text':' hidden states of question encoder','line_number':591,'multiline':False]['text':' reshaping','line_number':627,'multiline':False]['text':' compute doc_scores involving ctx_encoder','line_number':629,'multiline':False]['text':' set to correct device','line_number':642,'multiline':False]['text':' compute doc_scores','line_number':647,'multiline':False]['text':' Decoder input without context documents','line_number':674,'multiline':False]['text':' don't output retrieved docs','line_number':704,'multiline':False]['text':' instantiate model','line_number':755,'multiline':False]['text':' needs kwargs for generation','line_number':786,'multiline':False]['text':' defaults to True','line_number':914,'multiline':False]['text':' defaults to 1','line_number':915,'multiline':False]['text':' defaults to 1','line_number':916,'multiline':False]['text':' set to correct device','line_number':992,'multiline':False]['text':' first, generate beams from documents:','line_number':1003,'multiline':False]['text':' (n_docs, max_len)','line_number':1004,'multiline':False]['text':' n_docs * n_beam, tgt_len','line_number':1009,'multiline':False]['text':' do_deduplication, max_output_len','line_number':1011,'multiline':False]['text':' after deduplication, this number can be less than n_docs*n_beam','line_number':1016,'multiline':False]['text':' then, run model forwards to get nll scores:','line_number':1018,'multiline':False]['text':' input_ids is None, need context_input_ids/mask and doc_scores','line_number':1022,'multiline':False]['text':' (num_candidates*n_docs, max_len)','line_number':1034,'multiline':False]['text':' doc_scores.shape = [batch, n_docs]','line_number':1039,'multiline':False]['text':' [num_candidates, n_docs]','line_number':1040,'multiline':False]['text':' add hypothesis','line_number':1052,'multiline':False]['text':' shift tokens left','line_number':1060,'multiline':False]['text':' bos_token_id is None for T5','line_number':1067,'multiline':False]['text':' seq_logits dim = (batch*n_docs, tgt_len , #vocabs)','line_number':1078,'multiline':False]['text':' batch_size x n_docs x tgt_len x #vocab_size','line_number':1081,'multiline':False]['text':' RAG-sequence marginalization','line_number':1084,'multiline':False]['text':' calculate loss','line_number':1090,'multiline':False]['text':' total sum of all (normalised) logits','line_number':1095,'multiline':False]['text':' sum over tokens, exclude bos while scoring','line_number':1099,'multiline':False]['text':' logsumexp over docs','line_number':1102,'multiline':False]['text':' instantiate model','line_number':1154,'multiline':False]['text':' if past is defined use only last decoder_input_ids','line_number':1176,'multiline':False]['text':' get the correct batch idx from decoder layer's batch dim for cross and self-attn','line_number':1216,'multiline':False]['text':' RAG-token marginalization','line_number':1226,'multiline':False]['text':' needs kwargs for generation','line_number':1255,'multiline':False]['text':' Handle `generation_config` and kwargs that might update it','line_number':1455,'multiline':False]['text':' All unused kwargs must be model kwargs','line_number':1459,'multiline':False]['text':' set default parameters','line_number':1461,'multiline':False]['text':' retrieve docs','line_number':1464,'multiline':False]['text':' set to correct device','line_number':1480,'multiline':False]['text':' compute doc_scores','line_number':1485,'multiline':False]['text':' batch_size','line_number':1495,'multiline':False]['text':' split into `batch_size`, `num_beams`, `num_docs`','line_number':1511,'multiline':False]['text':' repeat same last hidden states over `num_beams` dimension','line_number':1513,'multiline':False]['text':' merge `batch_size`, `num_beams`, `num_docs` dims again','line_number':1515,'multiline':False]['text':' correctly extend last_hidden_state and attention mask','line_number':1518,'multiline':False]['text':' define start_len & additional parameters','line_number':1526,'multiline':False]['text':' shift tokens left','line_number':1600,'multiline':False]['text':' total sum of all (normalised) logits','line_number':1618,'multiline':False]['text':' sum over tokens','line_number':1620,'multiline':False]