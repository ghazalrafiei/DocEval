['text':' Compute fp16 FMA using fp16','line_number':8,'multiline':False]['text':' Out = FMA (A, B, Out)','line_number':9,'multiline':False]['text':'','line_number':10,'multiline':False]['text':' Algorithm:','line_number':11,'multiline':False]['text':'  Do an FMA in fp64','line_number':12,'multiline':False]['text':'  Since fp16 has 10 bits of mantissa and fp64 has 52, zero out','line_number':13,'multiline':False]['text':'   42 bits.','line_number':14,'multiline':False]['text':'  Extract the exponent.','line_number':15,'multiline':False]['text':'  If the exponent ends up in the subnormal range, shift out','line_number':16,'multiline':False]['text':'  only 42 - (14 + exponent).','line_number':17,'multiline':False]['text':'  Compute the bounce value as a value that is big enough to','line_number':18,'multiline':False]['text':'  push all the digits except for the required ones in fp16,','line_number':19,'multiline':False]['text':'  the objective is to push digits to let the machine do rounding.','line_number':20,'multiline':False]['text':'  Add 42 or the computed number (in case of denormals) to the exponent.','line_number':21,'multiline':False]['text':'  For negative numbers set the highest bit of the mantissa to 1.','line_number':22,'multiline':False]['text':' It can be proven than in the absence of intermediate overflow','line_number':32,'multiline':False]['text':' the desired numerical result can be obtained even with the','line_number':33,'multiline':False]['text':' possibility of a double rounding, as follow.','line_number':34,'multiline':False]['text':'    round-to-fp16-precision(   (double)A * (double)B + (double)C  )','line_number':35,'multiline':False]['text':' This statement is not proved here; but we explain how to round a fp64','line_number':36,'multiline':False]['text':' number into fp16 precision using the technique of a "Bouncer"','line_number':37,'multiline':False]['text':' Suppose a numerical value in fp64 has exponent value of E','line_number':38,'multiline':False]['text':' If -14 <= E <= 15 (the fp16 exponent value for normalized number),','line_number':39,'multiline':False]['text':' the lsb of this value in fp16 precision is 2^(E-10).','line_number':40,'multiline':False]['text':' Now consider this fp64 number Bouncer which is 2^(52+(E-10)) * 3/2','line_number':41,'multiline':False]['text':' The lsb of Bouncer is (by design) 2^(E-10). Because Bouncer is','line_number':42,'multiline':False]['text':' is very much bigger than the fp16 value, denoted by say x,','line_number':43,'multiline':False]['text':'          2^(52+(E-10)) < Bouncer + x < 2^(53+(E-10))','line_number':44,'multiline':False]['text':' Thus TMP := Bouncer + x  in double precision forces x to be rounded off','line_number':45,'multiline':False]['text':' at the lsb position of 2^(E-10).','line_number':46,'multiline':False]['text':' Consequently, the subtraction yields the desired result','line_number':47,'multiline':False]['text':'          x_fp16_precision := TMP - Bouncer;','line_number':48,'multiline':False]['text':' If E < -14, we are dealing with the subnormal number range, there the lsb','line_number':49,'multiline':False]['text':' of fp16 precision is FIXED at 2^(-24) (definition of fp16).','line_number':50,'multiline':False]['text':' Hence the Bouncer is set at 2^(52-24) = 2^(28)','line_number':51,'multiline':False]['text':' Epilogue','line_number':84,'multiline':False]['text':' This is FMA in FP64','line_number':96,'multiline':False]['text':' We now round Out_.F to fp16 precision using a Bouncer','line_number':99,'multiline':False]['text':' First, figure out the exponent value E of Out_.F','line_number':101,'multiline':False]['text':' Second: create the Bouncer. To do that, we','line_number':104,'multiline':False]['text':' first compute its exponent and then add that exponent value','line_number':105,'multiline':False]['text':' to the exponent field of the constant 3/2.','line_number':106,'multiline':False]['text':' This is rounding to fp16 precision; add and subtract Bouncer','line_number':114,'multiline':False]['text':' namespace fake_fp16','line_number':129,'multiline':False]