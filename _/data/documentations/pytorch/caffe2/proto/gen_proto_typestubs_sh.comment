['text':'!/usr/bin/env bash','line_number':1,'multiline':False]['text':' Generate type stubs for .proto definition files.','line_number':3,'multiline':False]['text':' This should be run from as','line_number':5,'multiline':False]['text':' ./gen_proto_typestubs.sh','line_number':6,'multiline':False]['text':' (i.e., from inside the proto/ directory)','line_number':7,'multiline':False]['text':' assumes mypy-protobuf installed to ~/.local; i.e. via','line_number':9,'multiline':False]['text':' pip3 install mypy-protobuf --user','line_number':10,'multiline':False]['text':' get rid of 'builtins.' prefix, which pyre does not like','line_number':20,'multiline':False]['text':' mypy-protobuf references types from other mypy-protobuf-generated stubs as','line_number':23,'multiline':False]['text':' 'type.V', but it should just be 'type', so we get rid of the '.V' suffix','line_number':24,'multiline':False]['text':' when it's not followed by parens to indicate a particular enum value.','line_number':25,'multiline':False]['text':' ---------------------------','line_number':28,'multiline':False]['text':' Freedom-patched DeviceTypes','line_number':29,'multiline':False]['text':' ---------------------------','line_number':30,'multiline':False]['text':'','line_number':31,'multiline':False]['text':' In order to make DeviceTypes like CPU, CUDA, etc. directly accessible from','line_number':32,'multiline':False]['text':' the caffe2_pb2 module, they are currently freedom-patched into it in','line_number':33,'multiline':False]['text':' caffe2/python/__init__.py. This is not ideal: it would be better if these','line_number':34,'multiline':False]['text':' were autogenerated when the protobuf definitions were created by using','line_number':35,'multiline':False]['text':' allow_alias = true in the DeviceTypeProto definition in caffe2.proto.','line_number':36,'multiline':False]['text':'','line_number':37,'multiline':False]['text':' However, it is impossible to do this currently without significant effort.','line_number':38,'multiline':False]['text':' The issue is that the generated proto constants would conflict with various','line_number':39,'multiline':False]['text':' constants defined in the C++ caffe2 codebase (`caffe2_pb2.h`). We cannot','line_number':40,'multiline':False]['text':' simply remove these constants and replace them with the caffe2','line_number':41,'multiline':False]['text':' DeviceTypeProto constants, because a huge portion of code expects','line_number':42,'multiline':False]['text':' at::DeviceType constants defined in `core/DeviceType.h` (apparently','line_number':43,'multiline':False]['text':' duplicated to avoid having to figure out how to autogenerate the protobuf','line_number':44,'multiline':False]['text':' definitions using cmake for ATen).','line_number':45,'multiline':False]['text':'','line_number':46,'multiline':False]['text':' Instead, we make a best-effort to add additional definitions in','line_number':47,'multiline':False]['text':' `caffe2_pb2.py` by looking for any freedom-patched constants in','line_number':48,'multiline':False]['text':' `caffe2/python/__init__.py` and making sure they have corresponding stubs in','line_number':49,'multiline':False]['text':' the pyi (see `gen_proto_typestubs_helper.py`).','line_number':50,'multiline':False]