['text':' Owner(s): ["oncall: distributed"]','line_number':1,'multiline':False]['text':' Get 2 events.','line_number':42,'multiline':False]['text':' Record the fake forward compute time.','line_number':46,'multiline':False]['text':' force the param to be part of the graph','line_number':51,'multiline':False]['text':' return the recorded duration.','line_number':56,'multiline':False]['text':' Use `limit_all_gathers=False` since the timing being tested relies on the','line_number':61,'multiline':False]['text':' CPU running ahead of the GPU','line_number':62,'multiline':False]['text':' Save the original torch.distributed.all_gather_into_tensor function since we will','line_number':99,'multiline':False]['text':' patch it to include an artificial delay.','line_number':100,'multiline':False]['text':' Get the input and sets the input's requires_grad to True because','line_number':107,'multiline':False]['text':' we have a fake compute in the forward pass.','line_number':108,'multiline':False]['text':' Run one dummy iteration to trigger the execution order validation','line_number':112,'multiline':False]['text':' all-gathers','line_number':113,'multiline':False]['text':' We run 20 iterations but only collect timing data from the minimal 10','line_number':118,'multiline':False]['text':' data points because nondeterministic system events can disturb the timing.','line_number':119,'multiline':False]['text':' Get two events for measuring the overall time.','line_number':125,'multiline':False]['text':' forward pass','line_number':140,'multiline':False]['text':'','line_number':141,'multiline':False]['text':' Even though both e1 & e2 are on the compute stream, since','line_number':142,'multiline':False]['text':' compute depends on all_gather, e2-e1 includes all_gather time.','line_number':143,'multiline':False]['text':' backward pass','line_number':155,'multiline':False]['text':' wait for gpu','line_number':161,'multiline':False]['text':' get sum of the compute time','line_number':165,'multiline':False]['text':' get gpu compute + all_gather time','line_number':172,'multiline':False]['text':' no compute, no all-gather','line_number':190,'multiline':False]['text':' no compute, only all-gather','line_number':191,'multiline':False]['text':' only compute, no all-gather','line_number':192,'multiline':False]['text':' both compute and all-gather','line_number':193,'multiline':False]['text':' Check the cpu/gpu timing. CPU should run ahead of GPU. Therefore, cpu-gpu','line_number':197,'multiline':False]['text':' wait should be long, except when there is no real work on GPU.','line_number':198,'multiline':False]['text':'','line_number':199,'multiline':False]['text':' If the assertions fail below, we likely have a cpu-gpu wait in the forward/backward pass.','line_number':200,'multiline':False]['text':' e4["cpu_iter"] may not be short as cpu may take some time to queue both compute and all-gather.','line_number':201,'multiline':False]['text':' all gather should not be happening.','line_number':210,'multiline':False]['text':' all gather should happen and prolong the cpu-gpu wait.','line_number':214,'multiline':False]['text':' 10X longer is a safe margin, since the GPU work timing is around 100X more','line_number':217,'multiline':False]['text':' of that of the CPU.','line_number':218,'multiline':False]['text':' Check the GPU timing.','line_number':221,'multiline':False]['text':' all gather should not be happening.','line_number':225,'multiline':False]['text':' all gather should happen and prolong the cpu-gpu wait.','line_number':229,'multiline':False]['text':' 10X longer is a safe margin, since the time is around 100X longer','line_number':232,'multiline':False]['text':' when there is work on GPU vs. no work.','line_number':233,'multiline':False]['text':' Check the GPU overlapping when there is all-gather.','line_number':236,'multiline':False]