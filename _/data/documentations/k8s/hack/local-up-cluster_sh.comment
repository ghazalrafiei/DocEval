['text':'!/usr/bin/env bash','line_number':1,'multiline':False]['text':' Copyright 2014 The Kubernetes Authors.','line_number':3,'multiline':False]['text':'','line_number':4,'multiline':False]['text':' Licensed under the Apache License, Version 2.0 (the "License");','line_number':5,'multiline':False]['text':' you may not use this file except in compliance with the License.','line_number':6,'multiline':False]['text':' You may obtain a copy of the License at','line_number':7,'multiline':False]['text':'','line_number':8,'multiline':False]['text':'     http://www.apache.org/licenses/LICENSE-2.0','line_number':9,'multiline':False]['text':'','line_number':10,'multiline':False]['text':' Unless required by applicable law or agreed to in writing, software','line_number':11,'multiline':False]['text':' distributed under the License is distributed on an "AS IS" BASIS,','line_number':12,'multiline':False]['text':' WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.','line_number':13,'multiline':False]['text':' See the License for the specific language governing permissions and','line_number':14,'multiline':False]['text':' limitations under the License.','line_number':15,'multiline':False]['text':' This script builds and runs a local kubernetes cluster. You may need to run','line_number':19,'multiline':False]['text':' this as root to allow kubelet to open docker's socket, and to write the test','line_number':20,'multiline':False]['text':' CA in /var/run/kubernetes.','line_number':21,'multiline':False]['text':' Usage: `hack/local-up-cluster.sh`.','line_number':22,'multiline':False]['text':' many dev environments run with swap on, so we don't fail in this env','line_number':35,'multiline':False]['text':' Name of the dns addon, eg: "kube-dns" or "coredns"','line_number':37,'multiline':False]['text':' if enabled, must set CGROUP_ROOT','line_number':42,'multiline':False]['text':' name of the cgroup driver, i.e. cgroupfs or systemd','line_number':44,'multiline':False]['text':' if cgroups per qos is enabled, optionally change cgroup root','line_number':46,'multiline':False]['text':' owner of client certs, default to current user if not specified','line_number':48,'multiline':False]['text':' if true, limited swap is being used instead of unlimited swap (default)','line_number':50,'multiline':False]['text':' required for cni installation','line_number':53,'multiline':False]['text':' The arch of the CNI binary, if not set, will be fetched based on the value of `uname -m`','line_number':56,'multiline':False]['text':' enables testing eviction scenarios locally.','line_number':64,'multiline':False]['text':' This script uses docker0 (or whatever container bridge docker is currently using)','line_number':69,'multiline':False]['text':' and we don't know the IP of the DNS pod to pass in as --cluster-dns.','line_number':70,'multiline':False]['text':' To set this up by hand, set this flag and change DNS_SERVER_IP.','line_number':71,'multiline':False]['text':' Note also that you need API_HOST (defined below) for correct DNS.','line_number':72,'multiline':False]['text':' preserve etcd data. you also need to set ETCD_DIR.','line_number':95,'multiline':False]['text':' enable Kubernetes-CSI snapshotter','line_number':99,'multiline':False]['text':' WebHook Authentication and Authorization','line_number':105,'multiline':False]['text':' Install a default storage class (enabled by default)','line_number':109,'multiline':False]['text':' Do not run the mutation detector by default on a local cluster.','line_number':112,'multiline':False]['text':' It is intended for a specific type of testing and inherently leaks memory.','line_number':113,'multiline':False]['text':' panic the server on watch decode errors since they are considered coder mistakes','line_number':117,'multiline':False]['text':' Default list of admission Controllers to invoke prior to persisting objects in cluster','line_number':121,'multiline':False]['text':' The order defined here does not matter.','line_number':122,'multiline':False]['text':' START_MODE can be 'all', 'kubeletonly', 'nokubelet', 'nokubeproxy', or 'nokubelet,nokubeproxy'','line_number':127,'multiline':False]['text':' A list of controllers to enable','line_number':130,'multiline':False]['text':' Audit policy','line_number':133,'multiline':False]['text':' Stop right away if the build fails','line_number':136,'multiline':False]['text':' This function guesses where the existing cached binary build is for the `-O`','line_number':150,'multiline':False]['text':' flag','line_number':151,'multiline':False]['text':'## Allow user to supply the source directory.','line_number':161,'multiline':False]['text':' Shut down anyway if there's an error.','line_number':195,'multiline':False]['text':' WARNING: For DNS to work on most setups you should export API_HOST as the docker0 ip address,','line_number':201,'multiline':False]['text':' By default only allow CORS for requests on localhost','line_number':211,'multiline':False]['text':' By default we use 0(close it) for it's insecure','line_number':214,'multiline':False]['text':' Use to increase verbosity on particular files, e.g. LOG_SPEC=token_controller*=5,other_controller*=4','line_number':217,'multiline':False]['text':' current k8s default','line_number':226,'multiline':False]['text':' current default','line_number':227,'multiline':False]['text':' current default','line_number':228,'multiline':False]['text':' This is the default dir and filename where the apiserver will generate a self-signed cert','line_number':229,'multiline':False]['text':' which should be able to be used as the CA to verify itself','line_number':230,'multiline':False]['text':' Reuse certs will skip generate new ca/cert files under CERT_DIR','line_number':235,'multiline':False]['text':' it's useful with PRESERVE_ETCD=true because new ca will make existed service account secrets invalided','line_number':236,'multiline':False]['text':' Ensure CERT_DIR is created for auto-generated crt/key and kubeconfig','line_number':240,'multiline':False]['text':' For the common local scenario, fail fast if server is already running.','line_number':245,'multiline':False]['text':' this can happen if you run local-up-cluster.sh twice and kill etcd in between.','line_number':246,'multiline':False]['text':' delete running images','line_number':339,'multiline':False]['text':' if [[ "${ENABLE_CLUSTER_DNS}" == true ]]; then','line_number':340,'multiline':False]['text':' Still need to figure why this commands throw an error: Error from server: client: etcd cluster is unavailable or misconfigured','line_number':341,'multiline':False]['text':'     ${KUBECTL} --namespace=kube-system delete service kube-dns','line_number':342,'multiline':False]['text':' And this one hang forever:','line_number':343,'multiline':False]['text':'     ${KUBECTL} --namespace=kube-system delete rc kube-dns-v10','line_number':344,'multiline':False]['text':' fi','line_number':345,'multiline':False]['text':' Check if the API server is still running','line_number':347,'multiline':False]['text':' Check if the controller-manager is still running','line_number':351,'multiline':False]['text':' Check if the cloud-controller-manager is still running','line_number':355,'multiline':False]['text':' Check if the kubelet is still running','line_number':359,'multiline':False]['text':' Check if the proxy is still running','line_number':363,'multiline':False]['text':' Check if the scheduler is still running','line_number':367,'multiline':False]['text':' Check if the etcd is still running','line_number':371,'multiline':False]['text':' Check if all processes are still running. Prints a warning once each time','line_number':380,'multiline':False]['text':' a process dies unexpectedly.','line_number':381,'multiline':False]['text':' add colon only if defined','line_number':416,'multiline':False]['text':' default is red','line_number':417,'multiline':False]['text':' Generate ServiceAccount key if needed','line_number':436,'multiline':False]['text':' Create CA signers','line_number':444,'multiline':False]['text':' Create auth proxy client ca','line_number':455,'multiline':False]['text':' serving cert for kube-apiserver','line_number':458,'multiline':False]['text':' Create client certs signed with client-ca, given id, given CN and a number of groups','line_number':461,'multiline':False]['text':' Create matching certificates for kube-aggregator','line_number':467,'multiline':False]['text':' TODO remove masters and add rolebinding','line_number':471,'multiline':False]['text':' Append security_admission plugin','line_number':492,'multiline':False]['text':' Let the API server pick a default address when API_HOST_IP','line_number':518,'multiline':False]['text':' is set to 127.0.0.1','line_number':519,'multiline':False]['text':' Clean previous dynamic certs','line_number':533,'multiline':False]['text':' This file is owned by root, so we can't always overwrite it (depends if','line_number':534,'multiline':False]['text':' we run the script as root or not). Let's remove it, that is something we','line_number':535,'multiline':False]['text':' can always do: either we have write permissions as a user in CERT_DIR or','line_number':536,'multiline':False]['text':' we run the rm with sudo.','line_number':537,'multiline':False]['text':' Create Certs','line_number':540,'multiline':False]['text':' Log all requests at the Metadata level.','line_number':569,'multiline':False]['text':' shellcheck disable=SC2086','line_number':579,'multiline':False]['text':' Create kubeconfigs for all components, using client certs','line_number':621,'multiline':False]['text':' make readable for kubectl','line_number':623,'multiline':False]['text':' Wait for kube-apiserver to come up before launching the rest of the components.','line_number':625,'multiline':False]['text':' Grant apiserver permission to speak to the kubelet','line_number':636,'multiline':False]['text':' Grant kubelets permission to request client certificates','line_number':639,'multiline':False]['text':' shellcheck disable=SC2086','line_number':693,'multiline':False]['text':' check the nodes information after kubelet daemon start','line_number':710,'multiline':False]['text':' shellcheck disable=SC2027 disable=SC2046','line_number':737,'multiline':False]['text':' kick the coredns pods to be recreated','line_number':759,'multiline':False]['text':' bump log level','line_number':777,'multiline':False]['text':' loop through and grab all things in dmesg','line_number':780,'multiline':False]['text':' shellcheck disable=SC2206','line_number':810,'multiline':False]['text':' warn if users are running with swap allowed','line_number':823,'multiline':False]['text':' clear previous dynamic certs','line_number':829,'multiline':False]['text':' create new certs','line_number':831,'multiline':False]['text':' the default value','line_number':858,'multiline':False]['text':' sample always','line_number':859,'multiline':False]['text':' authentication','line_number':871,'multiline':False]['text':' authorization','line_number':886,'multiline':False]['text':' dns','line_number':892,'multiline':False]['text':' To start a private DNS server set ENABLE_CLUSTER_DNS and','line_number':901,'multiline':False]['text':' DNS_SERVER_IP/DOMAIN. This will at least provide a working','line_number':902,'multiline':False]['text':' DNS server for real world hostnames.','line_number':903,'multiline':False]['text':' eviction','line_number':907,'multiline':False]['text':' feature gate','line_number':917,'multiline':False]['text':' shellcheck disable=SC2024','line_number':923,'multiline':False]['text':' Quick check that kubelet is running.','line_number':928,'multiline':False]['text':' wait for kubelet collect node information','line_number':940,'multiline':False]['text':' Skip setting sysctl value "net.netfilter.nf_conntrack_max"','line_number':953,'multiline':False]['text':' Skip setting "net.netfilter.nf_conntrack_tcp_timeout_established"','line_number':955,'multiline':False]['text':' Skip setting "net.netfilter.nf_conntrack_tcp_timeout_close"','line_number':957,'multiline':False]['text':' shellcheck disable=SC2024','line_number':968,'multiline':False]['text':' TODO update to dns role once we have one.','line_number':1003,'multiline':False]['text':' use kubectl to create dns addon','line_number':1004,'multiline':False]['text':' eventually all the __PILLAR__ stuff will be gone, but theyre still in nodelocaldns for backward compat.','line_number':1018,'multiline':False]['text':' use kubectl to create nodelocaldns addon','line_number':1023,'multiline':False]['text':' Convert from foo=true,bar=false to','line_number':1125,'multiline':False]['text':'   foo: true','line_number':1126,'multiline':False]['text':'   bar: false','line_number':1127,'multiline':False]['text':' Convert from memory.available<100Mi,nodefs.available<10%,nodefs.inodesFree<5% to','line_number':1134,'multiline':False]['text':'   memory.available: "100Mi"','line_number':1135,'multiline':False]['text':'   nodefs.available: "10%"','line_number':1136,'multiline':False]['text':'   nodefs.inodesFree: "5%"','line_number':1137,'multiline':False]['text':' Do not update docker / containerd / runc','line_number':1147,'multiline':False]['text':' jump through hoops to avoid removing docker/containerd','line_number':1150,'multiline':False]['text':' when installing nftables and kmod, as those docker/containerd','line_number':1151,'multiline':False]['text':' packages depend on iptables','line_number':1152,'multiline':False]['text':' https://github.com/moby/moby/blob/be220af9fb36e9baa9a75bbc41f784260aa6f96e/hack/dind#L28-L38','line_number':1160,'multiline':False]['text':' cgroup v2: enable nesting','line_number':1161,'multiline':False]['text':' move the processes from the root group to the /init group,','line_number':1163,'multiline':False]['text':' otherwise writing subtree_control fails with EBUSY.','line_number':1164,'multiline':False]['text':' An error during moving non-existent process (i.e., "cat") is ignored.','line_number':1165,'multiline':False]['text':' enable controllers','line_number':1168,'multiline':False]['text':' containerd 1.4.12 installed by docker in kubekins supports CNI version 0.4.0','line_number':1201,'multiline':False]['text':' If we are running in the CI, we need a few more things before we can start','line_number':1249,'multiline':False]['text':' install things we need that are missing from the kubekins image','line_number':1256,'multiline':False]['text':' configure shared mounts to prevent failure in DIND scenarios','line_number':1259,'multiline':False]['text':' kubekins has a special directory for docker root','line_number':1262,'multiline':False]['text':' to use docker installed containerd as kubelet container runtime','line_number':1265,'multiline':False]['text':' we need to enable cri and install cni','line_number':1266,'multiline':False]['text':' install cni for docker in docker','line_number':1267,'multiline':False]['text':' If we are running in a cgroups v2 environment','line_number':1270,'multiline':False]['text':' we need to enable nesting','line_number':1271,'multiline':False]['text':' enable cri for docker in docker','line_number':1274,'multiline':False]['text':' shellcheck disable=SC2129','line_number':1276,'multiline':False]['text':' enable debug','line_number':1279,'multiline':False]['text':' let's log it where we can grab it later','line_number':1282,'multiline':False]['text':' bump up things','line_number':1285,'multiline':False]['text':' check if the new stuff is there','line_number':1288,'multiline':False]['text':' validate that etcd is: not running, in path, and has minimum required version.','line_number':1297,'multiline':False]['text':'## IF the user didn't supply an output/ for the build... Then we detect.','line_number':1309,'multiline':False]['text':'# TODO remove this check if/when kubelet is supported on darwin','line_number':1341,'multiline':False]['text':' Detect the OS name/arch and display appropriate error.','line_number':1342,'multiline':False]['text':'# TODO remove this check if/when kubelet is supported on darwin','line_number':1360,'multiline':False]['text':' Detect the OS name/arch and display appropriate error.','line_number':1361,'multiline':False]