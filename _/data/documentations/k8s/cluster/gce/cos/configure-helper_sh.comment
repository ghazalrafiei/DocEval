['text':'!/usr/bin/env bash','line_number':1,'multiline':False]['text':' Copyright 2016 The Kubernetes Authors.','line_number':3,'multiline':False]['text':'','line_number':4,'multiline':False]['text':' Licensed under the Apache License, Version 2.0 (the "License");','line_number':5,'multiline':False]['text':' you may not use this file except in compliance with the License.','line_number':6,'multiline':False]['text':' You may obtain a copy of the License at','line_number':7,'multiline':False]['text':'','line_number':8,'multiline':False]['text':'     http://www.apache.org/licenses/LICENSE-2.0','line_number':9,'multiline':False]['text':'','line_number':10,'multiline':False]['text':' Unless required by applicable law or agreed to in writing, software','line_number':11,'multiline':False]['text':' distributed under the License is distributed on an "AS IS" BASIS,','line_number':12,'multiline':False]['text':' WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.','line_number':13,'multiline':False]['text':' See the License for the specific language governing permissions and','line_number':14,'multiline':False]['text':' limitations under the License.','line_number':15,'multiline':False]['text':' This script is for configuring kubernetes master and node instances. It is','line_number':17,'multiline':False]['text':' uploaded in the manifests tar ball.','line_number':18,'multiline':False]['text':' TODO: this script duplicates templating logic from cluster/saltbase/salt','line_number':20,'multiline':False]['text':' using sed. It should use an actual template parser on the manifest','line_number':21,'multiline':False]['text':' files.','line_number':22,'multiline':False]['text':'## Hardcoded constants','line_number':28,'multiline':False]['text':' Standard curl flags.','line_number':31,'multiline':False]['text':' A helper function to convert the manifest args from a string to a list of','line_number':35,'multiline':False]['text':' flag arguments.','line_number':36,'multiline':False]['text':' Old format:','line_number':37,'multiline':False]['text':'   command=["/bin/sh", "-c", "exec KUBE_EXEC_BINARY --param1=val1 --param2-val2"].','line_number':38,'multiline':False]['text':' New format:','line_number':39,'multiline':False]['text':'   command=["KUBE_EXEC_BINARY"]  # No shell dependencies.','line_number':40,'multiline':False]['text':'   args=["--param1=val1", "--param2-val2"]','line_number':41,'multiline':False]['text':'  drop trailing comma','line_number':48,'multiline':False]['text':' A helper function to add flag to an arguments string','line_number':53,'multiline':False]['text':' if no such flag is present already','line_number':54,'multiline':False]['text':' Reset core_pattern. On GCI, the default core_pattern pipes the core dumps to','line_number':65,'multiline':False]['text':' /sbin/crash_reporter which is more restrictive in saving crash dumps. So for','line_number':66,'multiline':False]['text':' now, set a generic core_pattern that users can work with.','line_number':67,'multiline':False]['text':' secure_random generates a secure random string of bytes. This function accepts','line_number':71,'multiline':False]['text':' a number of secure bytes desired and returns a base64 encoded string with at','line_number':72,'multiline':False]['text':' least the requested entropy. Rather than directly reading from /dev/urandom,','line_number':73,'multiline':False]['text':' we use uuidgen which calls getrandom(2). getrandom(2) verifies that the','line_number':74,'multiline':False]['text':' entropy pool has been initialized sufficiently for the desired operation','line_number':75,'multiline':False]['text':' before reading from /dev/urandom.','line_number':76,'multiline':False]['text':'','line_number':77,'multiline':False]['text':' ARGS:','line_number':78,'multiline':False]['text':'   #1: number of secure bytes to generate. We round up to the nearest factor of 32.','line_number':79,'multiline':False]['text':' uuids have 122 random bits, sha256 sums have 256 bits, so concatenate','line_number':89,'multiline':False]['text':' three uuids and take their sum. The sum is encoded in ASCII hex, hence the','line_number':90,'multiline':False]['text':' 64 character cut.','line_number':91,'multiline':False]['text':' Finally, convert the ASCII hex to base64 to increase the density.','line_number':101,'multiline':False]['text':' Helper for configuring iptables rules for metadata server.','line_number':105,'multiline':False]['text':'','line_number':106,'multiline':False]['text':' $1 is the command flag (-I or -D).','line_number':107,'multiline':False]['text':' $2 is the firewall action (LOG or REJECT).','line_number':108,'multiline':False]['text':' $3 is the prefix for log output.','line_number':109,'multiline':False]['text':' $4 is "!" to optionally invert the uid range.','line_number':110,'multiline':False]['text':' Expand rule action to include relevant option flags.','line_number':117,'multiline':False]['text':' Deliberately allow word split here','line_number':124,'multiline':False]['text':' shellcheck disable=SC2086','line_number':125,'multiline':False]['text':' WARNING: DO NOT USE THE FILTER TABLE! Some implementations of network policy','line_number':129,'multiline':False]['text':' think they own it and will stomp all over your changes. At this time, the','line_number':130,'multiline':False]['text':' mangle table is less contentious so use that if possible.','line_number':131,'multiline':False]['text':' Do not consider loopback addresses as martian source or destination while','line_number':135,'multiline':False]['text':' routing. This enables the use of 127/8 for local routing purposes.','line_number':136,'multiline':False]['text':' The GCI image has host firewall which drop most inbound/forwarded packets.','line_number':139,'multiline':False]['text':' We need to add rules to accept all TCP/UDP/ICMP/SCTP packets.','line_number':140,'multiline':False]['text':' Flush iptables nat table','line_number':156,'multiline':False]['text':' If METADATA_CONCEALMENT_NO_FIREWALL is set, don't create a firewall on this','line_number':178,'multiline':False]['text':' node because we don't expect the daemonset to run on this node.','line_number':179,'multiline':False]['text':' Log all metadata access not from approved processes.','line_number':188,'multiline':False]['text':' Gets the total number of $(1) and $(2) type disks specified','line_number':207,'multiline':False]['text':' by the user in ${NODE_LOCAL_SSDS_EXT}','line_number':208,'multiline':False]['text':' Creates a symlink for a ($1) so that it may be used as block storage','line_number':229,'multiline':False]['text':' Do not "mkdir -p ${sym}" as that will cause unintended symlink behavior','line_number':240,'multiline':False]['text':' Gets a pregenerated UUID from ${ssdmap} if it exists, otherwise generates a new','line_number':246,'multiline':False]['text':' UUID and places it inside ${ssdmap}','line_number':247,'multiline':False]['text':' each line of the ssdmap looks like "${device} persistent-uuid"','line_number':259,'multiline':False]['text':'create symlink based on saved uuid','line_number':262,'multiline':False]['text':' generate new uuid and add it to the map','line_number':265,'multiline':False]['text':'Formats the given device ($1) if needed and mounts it at given mount point','line_number':281,'multiline':False]['text':' ($2).','line_number':282,'multiline':False]['text':' Format only if the disk is not already formatted.','line_number':289,'multiline':False]['text':' Gets a devices UUID and bind mounts the device to mount location in','line_number':301,'multiline':False]['text':' /mnt/disks/by-id/','line_number':302,'multiline':False]['text':' Trigger udev refresh so that newly formatted devices are propagated in by-uuid','line_number':309,'multiline':False]['text':' find uuid for actual_device','line_number':314,'multiline':False]['text':' myuuid should be the uuid of the device as found in /dev/disk/by-uuid/','line_number':317,'multiline':False]['text':' bindpoint should be the full path of the to-be-bound device','line_number':323,'multiline':False]['text':' Bind mounts device at mountpoint to bindpoint','line_number':329,'multiline':False]['text':' Mount device to the mountpoint','line_number':334,'multiline':False]['text':' Mounts, bindmounts, or symlinks depending on the interface and format','line_number':342,'multiline':False]['text':' of the incoming device','line_number':343,'multiline':False]['text':' TODO: Handle partitioned disks. Right now this code just ignores partitions','line_number':356,'multiline':False]['text':' Error checking','line_number':361,'multiline':False]['text':' This path is required because the existing Google images do not','line_number':368,'multiline':False]['text':' expose NVMe devices in /dev/disk/by-id so we are using the /dev/nvme instead','line_number':369,'multiline':False]['text':' Error checking','line_number':372,'multiline':False]['text':' We only do the bindmount if users are using the new local ssd request method','line_number':381,'multiline':False]['text':' see https://github.com/kubernetes/kubernetes/pull/53466#discussion_r146431894','line_number':382,'multiline':False]['text':' Local ssds, if present, are mounted or symlinked to their appropriate','line_number':394,'multiline':False]['text':' locations','line_number':395,'multiline':False]['text':' GKE does not set NODE_LOCAL_SSDS so all non-block devices','line_number':411,'multiline':False]['text':' are assumed to be filesystem devices','line_number':412,'multiline':False]['text':' The following mounts or symlinks NVMe devices','line_number':421,'multiline':False]['text':' Check if NVMe SSD specified.','line_number':426,'multiline':False]['text':' This workaround to find if the NVMe device is a disk is required because','line_number':434,'multiline':False]['text':' the existing Google images does not expose NVMe devices in /dev/disk/by-id','line_number':435,'multiline':False]['text':' shellcheck disable=SC2155','line_number':437,'multiline':False]['text':' Local SSDs, if present, are used in a single RAID 0 array and directories that','line_number':452,'multiline':False]['text':' back ephemeral storage are mounted on them (kubelet root, container runtime','line_number':453,'multiline':False]['text':' root and pod logs).','line_number':454,'multiline':False]['text':' Get nvme devices','line_number':457,'multiline':False]['text':' This workaround to find if the NVMe device is a local SSD is required','line_number':460,'multiline':False]['text':' because the existing Google images does not them in /dev/disk/by-id','line_number':461,'multiline':False]['text':'devices[@]} "${devices[@]}"','line_number':479,'multiline':False]['text':' mount container runtime root dir on SSD','line_number':486,'multiline':False]['text':' Some images remount the container runtime root dir.','line_number':489,'multiline':False]['text':' Move the container runtime's directory to the new location to preserve','line_number':491,'multiline':False]['text':' preloaded images.','line_number':492,'multiline':False]['text':' mount kubelet root dir on SSD','line_number':499,'multiline':False]['text':' mount pod logs root dir on SSD','line_number':503,'multiline':False]['text':' set journald configuration','line_number':508,'multiline':False]['text':' Installs logrotate configuration files','line_number':522,'multiline':False]['text':' Configure log rotation for all logs in /var/log, which is where k8s services','line_number':527,'multiline':False]['text':' are configured to write their log files. Whenever logrotate is ran, this','line_number':528,'multiline':False]['text':' config will:','line_number':529,'multiline':False]['text':' * rotate the log file if its size is > 100Mb OR if one day has elapsed','line_number':530,'multiline':False]['text':' * save rotated logs into a gzipped timestamped backup','line_number':531,'multiline':False]['text':' * log file timestamp (controlled by 'dateformat') includes seconds too. This','line_number':532,'multiline':False]['text':'   ensures that logrotate can generate unique logfiles during each rotation','line_number':533,'multiline':False]['text':'   (otherwise it skips rotation if 'maxsize' is reached multiple times in a','line_number':534,'multiline':False]['text':'   day).','line_number':535,'multiline':False]['text':' * keep only 5 old (rotated) logs, and will discard older logs.','line_number':536,'multiline':False]['text':' Configure log rotation for pod logs in /var/log/pods/NAMESPACE_NAME_UID.','line_number':554,'multiline':False]['text':' Finds the master PD device; returns it in MASTER_PD_DEVICE','line_number':572,'multiline':False]['text':'#* }','line_number':579,'multiline':False]['text':' Mounts a persistent disk (formatting if needed) to store the persistent data','line_number':583,'multiline':False]['text':' on the master -- etcd's data, a few settings, and security certs/keys/tokens.','line_number':584,'multiline':False]['text':' safe-format-and-mount only formats an unformatted disk, and mkdir -p will','line_number':585,'multiline':False]['text':' leave a directory be if it already exists.','line_number':586,'multiline':False]['text':' Format and mount the disk, create directories on it for all of the master's','line_number':596,'multiline':False]['text':' persistent data, and link them to where they're used.','line_number':597,'multiline':False]['text':' NOTE: These locations on the PD store persistent data, so to maintain','line_number':602,'multiline':False]['text':' upgradeability, these locations should not change.  If they do, take care','line_number':603,'multiline':False]['text':' to maintain a migration path from these locations to whatever new','line_number':604,'multiline':False]['text':' locations.','line_number':605,'multiline':False]['text':' Contains all the data stored in etcd.','line_number':607,'multiline':False]['text':' Contains the dynamically generated apiserver auth certs and keys.','line_number':612,'multiline':False]['text':' Directory for kube-apiserver to store SSH key (if necessary).','line_number':615,'multiline':False]['text':' append_or_replace_prefixed_line ensures:','line_number':623,'multiline':False]['text':' 1. the specified file exists','line_number':624,'multiline':False]['text':' 2. existing lines with the specified ${prefix} are removed','line_number':625,'multiline':False]['text':' 3. a new line with the specified ${prefix}${suffix} is appended','line_number':626,'multiline':False]['text':' remove the path if it exists','line_number':643,'multiline':False]['text':' this is not true on GKE','line_number':695,'multiline':False]['text':' After the first boot and on upgrade, these files exist on the master-pd','line_number':798,'multiline':False]['text':' and should never be touched again (except perhaps an additional service','line_number':799,'multiline':False]['text':' account, see NB below.) One exception is if METADATA_CLOBBERS_CONFIG is','line_number':800,'multiline':False]['text':' enabled.','line_number':801,'multiline':False]['text':' Create a static Bearer token and kubeconfig for extra, comma-separated components.','line_number':848,'multiline':False]['text':' split NODE_TAGS into an array by comma.','line_number':912,'multiline':False]['text':' Multimaster indicates that the cluster is HA.','line_number':932,'multiline':False]['text':' Currently the only HA clusters are regional.','line_number':933,'multiline':False]['text':' If we introduce zonal multimaster this will need to be revisited.','line_number':934,'multiline':False]['text':' split GCE_ALPHA_FEATURES into an array by comma.','line_number':943,'multiline':False]['text':' Emit a basic admission control configuration file, with no plugins specified.','line_number':1048,'multiline':False]['text':' Add resourcequota config to limit critical pods to kube-system by default','line_number':1055,'multiline':False]['text':' ImagePolicyWebhook needs special kubeconfig for authenticating to the webhook endpoint.','line_number':1077,'multiline':False]['text':' Append config for ImagePolicyWebhook to the shared admission controller','line_number':1096,'multiline':False]['text':' configuration file.','line_number':1097,'multiline':False]['text':' Write the config for the audit policy.','line_number':1112,'multiline':False]['text':' Known api groups','line_number':1122,'multiline':False]['text':' The following requests were manually identified as high-volume and low-risk,','line_number':1147,'multiline':False]['text':' so drop them.','line_number':1148,'multiline':False]['text':' core','line_number':1153,'multiline':False]['text':' Ingress controller reads 'configmaps/ingress-uid' through the unsecured port.','line_number':1156,'multiline':False]['text':' TODO(#46983): Change this to the ingress controller service account.','line_number':1157,'multiline':False]['text':' core','line_number':1162,'multiline':False]['text':' legacy kubelet identity','line_number':1165,'multiline':False]['text':' core','line_number':1168,'multiline':False]['text':' core','line_number':1174,'multiline':False]['text':' core','line_number':1185,'multiline':False]['text':' core','line_number':1191,'multiline':False]['text':' core','line_number':1198,'multiline':False]['text':' Don't log HPA fetching metrics.','line_number':1200,'multiline':False]['text':' Don't log these read-only URLs.','line_number':1209,'multiline':False]['text':' Don't log events requests because of performance impact.','line_number':1216,'multiline':False]['text':' core','line_number':1219,'multiline':False]['text':' node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes','line_number':1222,'multiline':False]['text':' core','line_number':1227,'multiline':False]['text':' core','line_number':1235,'multiline':False]['text':' deletecollection calls can be large, don't log responses for expected namespace deletions','line_number':1240,'multiline':False]['text':' Secrets, ConfigMaps, TokenRequest and TokenReviews can contain sensitive & binary data,','line_number':1247,'multiline':False]['text':' so only log at the Metadata level.','line_number':1248,'multiline':False]['text':' core','line_number':1251,'multiline':False]['text':' Get responses can be large; skip them.','line_number':1257,'multiline':False]['text':' Default level for known APIs','line_number':1263,'multiline':False]['text':' Default level for all other requests.','line_number':1268,'multiline':False]['text':' Writes the configuration file used by the webhook advanced auditing backend.','line_number':1275,'multiline':False]['text':' The webhook config file is a kubeconfig file describing the webhook endpoint.','line_number':1280,'multiline':False]['text':' Arg 1: the IP address of the API server','line_number':1333,'multiline':False]['text':' Uses KUBELET_CA_CERT (falling back to CA_CERT), KUBELET_CERT, and KUBELET_KEY','line_number':1371,'multiline':False]['text':' to generate a kubeconfig file for the kubelet to securely connect to the apiserver.','line_number':1372,'multiline':False]['text':' Set REGISTER_MASTER_KUBELET to true if kubelet on the master node','line_number':1373,'multiline':False]['text':' should register to the apiserver.','line_number':1374,'multiline':False]['text':' Only configure the kubelet on the master if the required variables are','line_number':1376,'multiline':False]['text':' set in the environment.','line_number':1377,'multiline':False]['text':' TODO(#92143): Remove legacy policy config creation once kube-scheduler config is GA.','line_number':1414,'multiline':False]['text':' Keep in sync with add-replica-to-etcd/remove-replica-from-etcd in util.sh.','line_number':1474,'multiline':False]['text':' Keep in sync with add-replica-to-etcd/remove-replica-from-etcd in util.sh.','line_number':1484,'multiline':False]['text':' Keep in sync with add-replica-to-etcd/remove-replica-from-etcd in util.sh.','line_number':1488,'multiline':False]['text':' util function to add a docker option to daemon.json file only if the daemon.json file is present.','line_number':1502,'multiline':False]['text':' accepts only one argument (docker options)','line_number':1503,'multiline':False]['text':' appends the given input to the docker opts file i.e. /etc/docker/daemon.json file','line_number':1513,'multiline':False]['text':' disable aufs module if aufs is loaded','line_number':1522,'multiline':False]['text':' set docker options mtu and storage driver for non-ubuntu','line_number':1529,'multiline':False]['text':' as it is default for ubuntu','line_number':1530,'multiline':False]['text':' Disable live-restore if the environment variable is set.','line_number':1539,'multiline':False]['text':' log the contents of the /etc/docker/daemon.json if already exists','line_number':1550,'multiline':False]['text':' set docker0 cidr to private ip address range to avoid conflict with cbr0 cidr range','line_number':1573,'multiline':False]['text':' TODO (vteratipally)  move the registry-mirror completely to /etc/docker/daemon.json','line_number':1580,'multiline':False]['text':' Decide whether to enable a docker registry mirror. This is taken from','line_number':1582,'multiline':False]['text':' the "kube-env" metadata value.','line_number':1583,'multiline':False]['text':' Configure docker logging','line_number':1593,'multiline':False]['text':' Ensure TasksMax is sufficient for docker.','line_number':1604,'multiline':False]['text':' (https://github.com/kubernetes/kubernetes/issues/51977)','line_number':1605,'multiline':False]['text':' This function assembles the kubelet systemd service file and starts it','line_number':1618,'multiline':False]['text':' using systemctl.','line_number':1619,'multiline':False]['text':' Determine which binary to use on test clusters. We use the built-in','line_number':1627,'multiline':False]['text':' version only if the downloaded version is the same as the built-in','line_number':1628,'multiline':False]['text':' version. This allows GCI to run some of the e2e tests to qualify the','line_number':1629,'multiline':False]['text':' built-in kubelet.','line_number':1630,'multiline':False]['text':' Write the systemd service file for kubelet.','line_number':1651,'multiline':False]['text':' This function assembles the node problem detector systemd service file and','line_number':1672,'multiline':False]['text':' starts it using systemctl.','line_number':1673,'multiline':False]['text':' TODO(random-liu): Handle this for alternative container runtime.','line_number':1682,'multiline':False]['text':' Write the systemd service file for node problem detector.','line_number':1703,'multiline':False]['text':' Create the log file and set its properties.','line_number':1722,'multiline':False]['text':'','line_number':1723,'multiline':False]['text':' $1 is the file to create.','line_number':1724,'multiline':False]['text':' $2: the log owner uid to set for the log file.','line_number':1725,'multiline':False]['text':' $3: the log owner gid to set for the log file. If $KUBE_POD_LOG_READERS_GROUP','line_number':1726,'multiline':False]['text':' is set then this value will not be used.','line_number':1727,'multiline':False]['text':' Prepares parameters for kube-proxy manifest.','line_number':1739,'multiline':False]['text':' $1 source path of kube-proxy manifest.','line_number':1740,'multiline':False]['text':' Assumptions: HOST_PLATFORM and HOST_ARCH are specified by calling detect_host_info.','line_number':1741,'multiline':False]['text':' use 'nf_conntrack' instead of 'nf_conntrack_ipv4' for linux kernel >= 4.19','line_number':1757,'multiline':False]['text':' https://github.com/kubernetes/kubernetes/pull/70398','line_number':1758,'multiline':False]['text':' If IPVS modules are not present, make sure the node does not come up as','line_number':1768,'multiline':False]['text':' healthy.','line_number':1769,'multiline':False]['text':' TODO(#99245): Use multi-arch image and get rid of this.','line_number':1801,'multiline':False]['text':' Starts kube-proxy static pod.','line_number':1818,'multiline':False]['text':' Replaces the variables in the etcd manifest file with the real values, and then','line_number':1828,'multiline':False]['text':' copy the file to the manifest dir','line_number':1829,'multiline':False]['text':' $1: value for variable 'suffix'','line_number':1830,'multiline':False]['text':' $2: value for variable 'port'','line_number':1831,'multiline':False]['text':' $3: value for variable 'server_port'','line_number':1832,'multiline':False]['text':' $4: value for variable 'cpulimit'','line_number':1833,'multiline':False]['text':' $5: pod name, which should be either etcd or etcd-events','line_number':1834,'multiline':False]['text':' mTLS should only be enabled for etcd server but not etcd-events. if $1 suffix is empty, it's etcd server.','line_number':1877,'multiline':False]['text':' Get default storage backend from manifest file.','line_number':1909,'multiline':False]['text':' Replace the volume host path.','line_number':1945,'multiline':False]['text':' Replace the run as user and run as group','line_number':1947,'multiline':False]['text':' Starts etcd server pod (and etcd-events pod if needed).','line_number':1956,'multiline':False]['text':' More specifically, it prepares dirs and files, sets the variable value','line_number':1957,'multiline':False]['text':' in the manifests, and copies them to /etc/kubernetes/manifests.','line_number':1958,'multiline':False]['text':' Replaces the variables in the konnectivity-server manifest file with the real values, and then','line_number':1983,'multiline':False]['text':' copy the file to the manifest dir','line_number':1984,'multiline':False]['text':' $1: value for variable "agent_port"','line_number':1985,'multiline':False]['text':' $2: value for variable "health_port"','line_number':1986,'multiline':False]['text':' $3: value for variable "admin_port"','line_number':1987,'multiline':False]['text':' HTTP-CONNECT can work with either UDS or mTLS.','line_number':1998,'multiline':False]['text':' Linking them here to make sure we get good coverage with two test configurations.','line_number':1999,'multiline':False]['text':' GRPC can work with either UDS or mTLS.','line_number':2016,'multiline':False]['text':' Need to fix ANP code to allow kubeconfig to be set with mtls.','line_number':2022,'multiline':False]['text':' Starts konnectivity server pod.','line_number':2069,'multiline':False]['text':' More specifically, it prepares dirs and files, sets the variable value','line_number':2070,'multiline':False]['text':' in the manifests, and copies them to /etc/kubernetes/manifests.','line_number':2071,'multiline':False]['text':' Calculates the following variables based on env variables, which will be used','line_number':2078,'multiline':False]['text':' by the manifests of several kube-master components.','line_number':2079,'multiline':False]['text':'   CLOUD_CONFIG_OPT','line_number':2080,'multiline':False]['text':'   CLOUD_CONFIG_VOLUME','line_number':2081,'multiline':False]['text':'   CLOUD_CONFIG_MOUNT','line_number':2082,'multiline':False]['text':'   DOCKER_REGISTRY','line_number':2083,'multiline':False]['text':'   FLEXVOLUME_HOSTPATH_MOUNT','line_number':2084,'multiline':False]['text':'   FLEXVOLUME_HOSTPATH_VOLUME','line_number':2085,'multiline':False]['text':'   INSECURE_PORT_MAPPING','line_number':2086,'multiline':False]['text':' INSECURE_PORT_MAPPING is used by sed','line_number':2110,'multiline':False]['text':' shellcheck disable=SC2089','line_number':2111,'multiline':False]['text':' shellcheck disable=SC2090','line_number':2114,'multiline':False]['text':' A helper function that bind mounts kubelet dirs for running mount in a chroot','line_number':2118,'multiline':False]['text':' Updates node labels used by addons.','line_number':2131,'multiline':False]['text':' need kube-apiserver to be ready','line_number':2133,'multiline':False]['text':' A helper function for labeling all nodes matching a given selector.','line_number':2142,'multiline':False]['text':' Runs: kubectl label --overwrite nodes -l "${1}" "${2}"','line_number':2143,'multiline':False]['text':' Retries on failure','line_number':2144,'multiline':False]['text':'','line_number':2145,'multiline':False]['text':' $1: label selector of nodes','line_number':2146,'multiline':False]['text':' $2: label to apply','line_number':2147,'multiline':False]['text':' Starts kubernetes controller manager.','line_number':2161,'multiline':False]['text':' It prepares the log file, loads the docker image, calculates variables, sets them','line_number':2162,'multiline':False]['text':' in the manifest file, and then copies the manifest file to /etc/kubernetes/manifests.','line_number':2163,'multiline':False]['text':'','line_number':2164,'multiline':False]['text':' Assumed vars (which are calculated in function compute-master-manifest-variables)','line_number':2165,'multiline':False]['text':'   CLOUD_CONFIG_OPT','line_number':2166,'multiline':False]['text':'   CLOUD_CONFIG_VOLUME','line_number':2167,'multiline':False]['text':'   CLOUD_CONFIG_MOUNT','line_number':2168,'multiline':False]['text':'   DOCKER_REGISTRY','line_number':2169,'multiline':False]['text':' Calculate variables and assemble the command line.','line_number':2180,'multiline':False]['text':' Evaluate variables.','line_number':2255,'multiline':False]['text':' Starts cloud controller manager.','line_number':2283,'multiline':False]['text':' It prepares the log file, loads the docker image, calculates variables, sets them','line_number':2284,'multiline':False]['text':' in the manifest file, and then copies the manifest file to /etc/kubernetes/manifests.','line_number':2285,'multiline':False]['text':'','line_number':2286,'multiline':False]['text':' Assumed vars (which are calculated in function compute-master-manifest-variables)','line_number':2287,'multiline':False]['text':'   CLOUD_CONFIG_OPT','line_number':2288,'multiline':False]['text':'   CLOUD_CONFIG_VOLUME','line_number':2289,'multiline':False]['text':'   CLOUD_CONFIG_MOUNT','line_number':2290,'multiline':False]['text':'   DOCKER_REGISTRY','line_number':2291,'multiline':False]['text':' Calculate variables and assemble the command line.','line_number':2299,'multiline':False]['text':' remove non-GCP feature gates, since the CCM will early exit','line_number':2326,'multiline':False]['text':' if given a feature gate it doesn't recognize','line_number':2327,'multiline':False]['text':' Evaluate variables.','line_number':2368,'multiline':False]['text':'run-cloud-controller-manager-as-non-root','line_number':2383,'multiline':False]['text':' Starts kubernetes scheduler.','line_number':2400,'multiline':False]['text':' It prepares the log file, loads the docker image, calculates variables, sets them','line_number':2401,'multiline':False]['text':' in the manifest file, and then copies the manifest file to /etc/kubernetes/manifests.','line_number':2402,'multiline':False]['text':'','line_number':2403,'multiline':False]['text':' Assumed vars (which are calculated in compute-master-manifest-variables)','line_number':2404,'multiline':False]['text':'   DOCKER_REGISTRY','line_number':2405,'multiline':False]['text':' User and group should never contain characters that need to be quoted','line_number':2415,'multiline':False]['text':' shellcheck disable=SC2086','line_number':2416,'multiline':False]['text':' Calculate variables and set them in the manifest.','line_number':2419,'multiline':False]['text':' Scheduler Component Config takes precedence over some flags.','line_number':2425,'multiline':False]['text':' Remove salt comments and replace variables with values.','line_number':2446,'multiline':False]['text':' Starts cluster autoscaler.','line_number':2458,'multiline':False]['text':' Assumed vars (which are calculated in function compute-master-manifest-variables)','line_number':2459,'multiline':False]['text':'   CLOUD_CONFIG_OPT','line_number':2460,'multiline':False]['text':'   CLOUD_CONFIG_VOLUME','line_number':2461,'multiline':False]['text':'   CLOUD_CONFIG_MOUNT','line_number':2462,'multiline':False]['text':' Remove salt comments and replace variables with values','line_number':2470,'multiline':False]['text':' split the params into separate arguments passed to binary','line_number':2478,'multiline':False]['text':' A helper function for setting up addon manifests.','line_number':2492,'multiline':False]['text':'','line_number':2493,'multiline':False]['text':' $1: addon category under /etc/kubernetes','line_number':2494,'multiline':False]['text':' $2: manifest source dir','line_number':2495,'multiline':False]['text':' $3: (optional) auxiliary manifest source dir','line_number':2496,'multiline':False]['text':' A function that downloads extra addons from a URL and puts them in the GCI','line_number':2504,'multiline':False]['text':' manifests directory.','line_number':2505,'multiline':False]['text':' shellcheck disable=SC2206','line_number':2511,'multiline':False]['text':' A function that fetches a GCE metadata value and echoes it out.','line_number':2525,'multiline':False]['text':' Args:','line_number':2526,'multiline':False]['text':'   $1 : URL path after /computeMetadata/v1/ (without heading slash).','line_number':2527,'multiline':False]['text':'   $2 : An optional default value to echo out if the fetch fails.','line_number':2528,'multiline':False]['text':'','line_number':2529,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':2530,'multiline':False]['text':' duplicated there as well.','line_number':2531,'multiline':False]['text':' shellcheck disable=SC2086','line_number':2536,'multiline':False]['text':' A helper function for copying manifests and setting dir/files','line_number':2550,'multiline':False]['text':' permissions.','line_number':2551,'multiline':False]['text':'','line_number':2552,'multiline':False]['text':' $1: absolute source dir','line_number':2553,'multiline':False]['text':' $2: absolute destination dir','line_number':2554,'multiline':False]['text':' Fluentd resources are modified using ScalingPolicy CR, which may not be','line_number':2575,'multiline':False]['text':' available at this point. Run this as a background process.','line_number':2576,'multiline':False]['text':' Nothing to do here.','line_number':2589,'multiline':False]['text':' Wait until ScalingPolicy CRD is in place.','line_number':2593,'multiline':False]['text':' Single-shot, not managed by addon manager. Can be later modified or removed','line_number':2599,'multiline':False]['text':' at will.','line_number':2600,'multiline':False]['text':' Trigger background process that will ultimately update fluentd resource','line_number':2622,'multiline':False]['text':' requirements.','line_number':2623,'multiline':False]['text':' VolumeSnapshot CRDs and controller are installed by cluster addon manager,','line_number':2628,'multiline':False]['text':' which may not be available at this point. Run this as a background process.','line_number':2629,'multiline':False]['text':' Wait until volumesnapshot CRDs and controller are in place.','line_number':2631,'multiline':False]['text':' Trigger background process that will wait for volumesnapshot CRDs','line_number':2661,'multiline':False]['text':' and snapshot-controller to be installed','line_number':2662,'multiline':False]['text':' Update {{ fluentd_container_runtime_service }} with actual container runtime name,','line_number':2667,'multiline':False]['text':' and {{ container_runtime_endpoint }} with actual container runtime','line_number':2668,'multiline':False]['text':' endpoint.','line_number':2669,'multiline':False]['text':' Remove configuration in yaml file if node journal is not enabled.','line_number':2679,'multiline':False]['text':' Removes all lines between two patterns (throws away node-journal)','line_number':2683,'multiline':False]['text':' Updates parameters in yaml file for prometheus-to-sd configuration, or','line_number':2688,'multiline':False]['text':' removes component if it is disabled.','line_number':2689,'multiline':False]['text':' Removes all lines between two patterns (throws away prometheus-to-sd)','line_number':2695,'multiline':False]['text':' Updates parameters in yaml file for prometheus-to-sd configuration in daemon sets, or','line_number':2700,'multiline':False]['text':' removes component if it is disabled.','line_number':2701,'multiline':False]['text':' Removes all lines between two patterns (throws away prometheus-to-sd)','line_number':2704,'multiline':False]['text':' Updates parameters in yaml file for event-exporter configuration','line_number':2711,'multiline':False]['text':' Sets up the manifests of coreDNS for k8s addons.','line_number':2718,'multiline':False]['text':' Replace the salt configurations with variable values.','line_number':2723,'multiline':False]['text':' Sets up the manifests of Fluentd configmap and yamls for k8s addons.','line_number':2736,'multiline':False]['text':' Ingest logs against new resources like "k8s_container" and "k8s_node" if','line_number':2741,'multiline':False]['text':' LOGGING_STACKDRIVER_RESOURCE_TYPES is "new".','line_number':2742,'multiline':False]['text':' Ingest logs against old resources like "gke_container" and "gce_instance" if','line_number':2743,'multiline':False]['text':' LOGGING_STACKDRIVER_RESOURCE_TYPES is "old".','line_number':2744,'multiline':False]['text':' Sets up the manifests of kube-dns for k8s addons.','line_number':2764,'multiline':False]['text':' Replace with custom GKE kube-dns deployment.','line_number':2770,'multiline':False]['text':' Replace the salt configurations with variable values.','line_number':2776,'multiline':False]['text':' Sets up the manifests of local dns cache agent for k8s addons.','line_number':2788,'multiline':False]['text':' eventually all the __PILLAR__ stuff will be gone, but theyre still in nodelocaldns for backward compat.','line_number':2793,'multiline':False]['text':' Sets up the manifests of netd for k8s addons.','line_number':2799,'multiline':False]['text':' Replace with custom GCP netd deployment.','line_number':2805,'multiline':False]['text':' A helper function to set up a custom yaml for a k8s addon.','line_number':2812,'multiline':False]['text':'','line_number':2813,'multiline':False]['text':' $1: addon category under /etc/kubernetes','line_number':2814,'multiline':False]['text':' $2: manifest source dir','line_number':2815,'multiline':False]['text':' $3: manifest file','line_number':2816,'multiline':False]['text':' $4: custom yaml','line_number':2817,'multiline':False]['text':' Replace with custom manifest.','line_number':2822,'multiline':False]['text':' Prepares the manifests of k8s addons, and starts the addon manager.','line_number':2829,'multiline':False]['text':' Vars assumed:','line_number':2830,'multiline':False]['text':'   CLUSTER_NAME','line_number':2831,'multiline':False]['text':' User and group should never contain characters that need to be quoted','line_number':2838,'multiline':False]['text':' shellcheck disable=SC2086','line_number':2839,'multiline':False]['text':' prep addition kube-up specific rbac objects','line_number':2842,'multiline':False]['text':' Set up manifests of other addons.','line_number':2851,'multiline':False]['text':' Replace with custom GKE kube proxy.','line_number':2854,'multiline':False]['text':' Setting up the konnectivity-agent daemonset','line_number':2899,'multiline':False]['text':' Create a new directory for the DNS addon and prepend a "0" on the name.','line_number':2905,'multiline':False]['text':' Prepending "0" to the directory ensures that add-on manager','line_number':2906,'multiline':False]['text':' creates the dns service first. This ensures no other add-on','line_number':2907,'multiline':False]['text':' can "steal" the designated DNS clusterIP.','line_number':2908,'multiline':False]['text':' Setup role binding(s) for standalone node problem detector.','line_number':2944,'multiline':False]['text':' Configure Calico CNI directory.','line_number':2960,'multiline':False]['text':' Place addon manager pod manifest.','line_number':2993,'multiline':False]['text':' Setups manifests for ingress controller and gce-specific policies for service controller.','line_number':3021,'multiline':False]['text':' Starts a l7 loadbalancing controller for ingress.','line_number':3025,'multiline':False]['text':' Override the glbc image if GCE_GLBC_IMAGE is specified.','line_number':3042,'multiline':False]['text':' Setup working directory for kubelet.','line_number':3049,'multiline':False]['text':' TODO(#60123): The kubelet should create the cert-dir directory if it doesn't exist','line_number':3055,'multiline':False]['text':' Mount /var/lib/kubelet/pki on a tmpfs so it doesn't persist across','line_number':3058,'multiline':False]['text':' reboots. This can help avoid some rare instances of corrupt cert files','line_number':3059,'multiline':False]['text':' (e.g. created but not written during a shutdown). Kubelet crash-loops','line_number':3060,'multiline':False]['text':' in these cases. Do this after above mount calls so it isn't overwritten.','line_number':3061,'multiline':False]['text':' Override for GKE custom master setup scripts (no-op outside of GKE).','line_number':3066,'multiline':False]['text':' kubelet is installed both on the master and nodes, and the version is easy to parse (unlike kubectl)','line_number':3080,'multiline':False]['text':' This logic grabs either a release tag (v1.2.1 or v1.2.1-alpha.1),','line_number':3082,'multiline':False]['text':' or the git hash that's in the build info.','line_number':3083,'multiline':False]['text':' source the file explicitly otherwise we have','line_number':3120,'multiline':False]['text':' issues on a ubuntu OS image finding the kubectl','line_number':3121,'multiline':False]['text':' shellcheck disable=SC1091','line_number':3122,'multiline':False]['text':' Add ${KUBE_HOME}/bin into sudoer secure path.','line_number':3125,'multiline':False]['text':'PATH=}','line_number':3129,'multiline':False]['text':' fixup the alternate registry if specified','line_number':3175,'multiline':False]['text':' By default, `kubectl` uses http://localhost:8080','line_number':3188,'multiline':False]['text':' If the insecure port is disabled, kubectl will need to use an admin-authenticated kubeconfig.','line_number':3189,'multiline':False]['text':' Use Kubernetes cni daemonset on node if network policy provider is specified','line_number':3230,'multiline':False]['text':' or netd is enabled.','line_number':3231,'multiline':False]['text':' Use systemd cgroup driver when running on cgroupv2','line_number':3236,'multiline':False]['text':' Kubernetes requires the cri plugin.','line_number':3244,'multiline':False]['text':' Kubernetes doesn't use containerd restart manager.','line_number':3246,'multiline':False]['text':' Enable registry.k8s.io as the primary mirror for k8s.gcr.io','line_number':3267,'multiline':False]['text':' See: https://github.com/kubernetes/k8s.io/issues/3411','line_number':3268,'multiline':False]['text':' Setup a runtime with the magic name ("test-handler") used for Kubernetes','line_number':3277,'multiline':False]['text':' runtime class tests ...','line_number':3278,'multiline':False]['text':' Reuse docker group for containerd.','line_number':3284,'multiline':False]['text':' reuse id of the docker group','line_number':3288,'multiline':False]['text':' This function detects the platform/arch of the machine where the script runs,','line_number':3299,'multiline':False]['text':' and sets the HOST_PLATFORM and HOST_ARCH environment variables accordingly.','line_number':3300,'multiline':False]['text':' Callers can specify HOST_PLATFORM_OVERRIDE and HOST_ARCH_OVERRIDE to skip the detection.','line_number':3301,'multiline':False]['text':' This function is adapted from the detect_client_info function in cluster/get-kube-binaries.sh','line_number':3302,'multiline':False]['text':' and kube::util::host_os, kube::util::host_arch functions in hack/lib/util.sh','line_number':3303,'multiline':False]['text':' This function should be synced with detect_host_info in ./configure.sh','line_number':3304,'multiline':False]['text':' Initializes variables used by the log-* functions.','line_number':3335,'multiline':False]['text':'','line_number':3336,'multiline':False]['text':' get-metadata-value must be defined before calling this function.','line_number':3337,'multiline':False]['text':'','line_number':3338,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3339,'multiline':False]['text':' duplicated there as well.','line_number':3340,'multiline':False]['text':' Used by log-* functions.','line_number':3342,'multiline':False]['text':' Sets an EXIT trap.','line_number':3354,'multiline':False]['text':' Args:','line_number':3355,'multiline':False]['text':'   $1:... : the trap command.','line_number':3356,'multiline':False]['text':'','line_number':3357,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3358,'multiline':False]['text':' duplicated there as well.','line_number':3359,'multiline':False]['text':' shellcheck disable=2064','line_number':3363,'multiline':False]['text':' Removes and restores an EXIT trap.','line_number':3367,'multiline':False]['text':'','line_number':3368,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3369,'multiline':False]['text':' duplicated there as well.','line_number':3370,'multiline':False]['text':' Remove current trap.','line_number':3372,'multiline':False]['text':' Restore previous trap.','line_number':3375,'multiline':False]['text':'LOG_TRAP_STACK[@]} -ne 0 ]; then','line_number':3376,'multiline':False]['text':' shellcheck disable=2064','line_number':3378,'multiline':False]['text':' If no traps in stack, clear.','line_number':3381,'multiline':False]['text':' Logs the end of a bootstrap step that errored.','line_number':3386,'multiline':False]['text':' Args:','line_number':3387,'multiline':False]['text':'  $1 : bootstrap step name.','line_number':3388,'multiline':False]['text':'','line_number':3389,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3390,'multiline':False]['text':' duplicated there as well.','line_number':3391,'multiline':False]['text':' Wraps a command with bootstrap logging.','line_number':3398,'multiline':False]['text':' Args:','line_number':3399,'multiline':False]['text':'   $1    : bootstrap step name.','line_number':3400,'multiline':False]['text':'   $2... : the command to run.','line_number':3401,'multiline':False]['text':'','line_number':3402,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3403,'multiline':False]['text':' duplicated there as well.','line_number':3404,'multiline':False]['text':' Logs a bootstrap step start. Prefer log-wrap.','line_number':3416,'multiline':False]['text':' Args:','line_number':3417,'multiline':False]['text':'   $1 : bootstrap step name.','line_number':3418,'multiline':False]['text':'','line_number':3419,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3420,'multiline':False]['text':' duplicated there as well.','line_number':3421,'multiline':False]['text':' Logs a bootstrap step end. Prefer log-wrap.','line_number':3429,'multiline':False]['text':' Args:','line_number':3430,'multiline':False]['text':'   $1 : bootstrap step name.','line_number':3431,'multiline':False]['text':'','line_number':3432,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3433,'multiline':False]['text':' duplicated there as well.','line_number':3434,'multiline':False]['text':' Writes a log proto to stdout.','line_number':3442,'multiline':False]['text':' Args:','line_number':3443,'multiline':False]['text':'   $1: bootstrap step name.','line_number':3444,'multiline':False]['text':'   $2: status. Either 'STARTED', 'COMPLETED', or 'ERROR'.','line_number':3445,'multiline':False]['text':'   $3: optional status reason.','line_number':3446,'multiline':False]['text':'','line_number':3447,'multiline':False]['text':' NOTE: this function is duplicated in configure.sh, any changes here should be','line_number':3448,'multiline':False]['text':' duplicated there as well.','line_number':3449,'multiline':False]['text':' Get current time.','line_number':3455,'multiline':False]['text':' ...formatted as UTC RFC 3339.','line_number':3458,'multiline':False]['text':' Calculate latency.','line_number':3462,'multiline':False]['text':' Bash cannot do non-integer math, shell out to awk.','line_number':3470,'multiline':False]['text':' The default latency is null which cannot be wrapped as a string so we must','line_number':3473,'multiline':False]['text':' do it here instead of the printf.','line_number':3474,'multiline':False]['text':'########## Main Function ###########','line_number':3482,'multiline':False]['text':' Resource requests of master components.','line_number':3492,'multiline':False]['text':' We still need to configure docker so it wouldn't reserver the 172.17.0/16 subnet','line_number':3587,'multiline':False]['text':' And if somebody will start docker to build or pull something, logging will also be set up','line_number':3588,'multiline':False]['text':' stop docker if it is present as we want to use just containerd','line_number':3590,'multiline':False]['text':' Note prepare-mounter-rootfs must be called before the kubelet starts, as','line_number':3608,'multiline':False]['text':' kubelet startup updates its nameserver.','line_number':3609,'multiline':False]['text':' Wait for all background jobs to finish.','line_number':3644,'multiline':False]['text':' Give kube-bootstrap-logs-forwarder.service some time to write all logs.','line_number':3654,'multiline':False]