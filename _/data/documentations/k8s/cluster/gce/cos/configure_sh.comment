['text':'!/usr/bin/env bash','line_number':1,'multiline':False]['text':' Copyright 2016 The Kubernetes Authors.','line_number':3,'multiline':False]['text':'','line_number':4,'multiline':False]['text':' Licensed under the Apache License, Version 2.0 (the "License");','line_number':5,'multiline':False]['text':' you may not use this file except in compliance with the License.','line_number':6,'multiline':False]['text':' You may obtain a copy of the License at','line_number':7,'multiline':False]['text':'','line_number':8,'multiline':False]['text':'     http://www.apache.org/licenses/LICENSE-2.0','line_number':9,'multiline':False]['text':'','line_number':10,'multiline':False]['text':' Unless required by applicable law or agreed to in writing, software','line_number':11,'multiline':False]['text':' distributed under the License is distributed on an "AS IS" BASIS,','line_number':12,'multiline':False]['text':' WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.','line_number':13,'multiline':False]['text':' See the License for the specific language governing permissions and','line_number':14,'multiline':False]['text':' limitations under the License.','line_number':15,'multiline':False]['text':' Due to the GCE custom metadata size limit, we split the entire script into two','line_number':17,'multiline':False]['text':' files configure.sh and configure-helper.sh. The functionality of downloading','line_number':18,'multiline':False]['text':' kubernetes configuration, manifests, docker images, and binary files are','line_number':19,'multiline':False]['text':' put in configure.sh, which is uploaded via GCE custom metadata.','line_number':20,'multiline':False]['text':'## Hardcoded constants','line_number':26,'multiline':False]['text':'##','line_number':38,'multiline':False]['text':' Standard curl flags.','line_number':40,'multiline':False]['text':' A function that fetches a GCE metadata value and echoes it out.','line_number':58,'multiline':False]['text':' Args:','line_number':59,'multiline':False]['text':'   $1 : URL path after /computeMetadata/v1/ (without heading slash).','line_number':60,'multiline':False]['text':'   $2 : An optional default value to echo out if the fetch fails.','line_number':61,'multiline':False]['text':'','line_number':62,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':63,'multiline':False]['text':' should be duplicated there as well.','line_number':64,'multiline':False]['text':' shellcheck disable=SC2086','line_number':69,'multiline':False]['text':' Fetch kube-env from GCE metadata server.','line_number':84,'multiline':False]['text':' shellcheck disable=SC2086','line_number':88,'multiline':False]['text':' Convert the yaml format file into a shell-style file.','line_number':93,'multiline':False]['text':' Fetch kubelet config file from GCE metadata server.','line_number':107,'multiline':False]['text':' shellcheck disable=SC2086','line_number':111,'multiline':False]['text':' only write to the final location if curl succeeds','line_number':116,'multiline':False]['text':' Fetch kube-env from GCE metadata server.','line_number':122,'multiline':False]['text':' shellcheck disable=SC2086','line_number':126,'multiline':False]['text':' Convert the yaml format file into a shell-style file.','line_number':131,'multiline':False]['text':' Get default service account credentials of the VM.','line_number':154,'multiline':False]['text':' shellcheck disable=SC2086','line_number':157,'multiline':False]['text':' shellcheck disable=SC2086','line_number':165,'multiline':False]['text':' Retry a download until we get it. Takes a hash and a set of URLs.','line_number':172,'multiline':False]['text':'','line_number':173,'multiline':False]['text':' $1 is the sha512/sha1 hash of the URL. Can be "" if the sha512/sha1 hash is unknown.','line_number':174,'multiline':False]['text':' $2+ are the URLs to download.','line_number':175,'multiline':False]['text':' if the url belongs to GCS API we should use oauth2_token in the headers if the VM service account has storage scopes','line_number':184,'multiline':False]['text':' this behavior is preserved for backward compatibility. We want to fail fast if SA is not available','line_number':193,'multiline':False]['text':' and try to download without SA if scope does not exist on SA','line_number':194,'multiline':False]['text':' Install node problem detector binary.','line_number':265,'multiline':False]['text':' no other architectures are supported currently.','line_number':279,'multiline':False]['text':' Assumption is that this script only runs on linux,','line_number':280,'multiline':False]['text':' see cluster/gce/windows/k8s-node-setup.psm1 for windows','line_number':281,'multiline':False]['text':' https://github.com/kubernetes/node-problem-detector/releases/','line_number':282,'multiline':False]['text':' Install crictl binary.','line_number':336,'multiline':False]['text':' Assumptions: HOST_PLATFORM and HOST_ARCH are specified by calling detect_host_info.','line_number':337,'multiline':False]['text':' Create crictl config file.','line_number':360,'multiline':False]['text':' Put kube-system pods manifests in ${KUBE_HOME}/kube-manifests/.','line_number':379,'multiline':False]['text':' A helper function for loading a docker image. It keeps trying up to 5 times.','line_number':422,'multiline':False]['text':'','line_number':423,'multiline':False]['text':' $1: Full path of the docker image','line_number':424,'multiline':False]['text':' Temporarily turn off errexit, because we don't want to exit on first failure.','line_number':428,'multiline':False]['text':' Deliberately word split load_image_command','line_number':441,'multiline':False]['text':' shellcheck disable=SC2086','line_number':442,'multiline':False]['text':' remove the prefix and suffix from the path to get the container name','line_number':454,'multiline':False]['text':'#*/}','line_number':455,'multiline':False]['text':' find the right one for which we will need an additional tag','line_number':457,'multiline':False]['text':' Re-enable errexit.','line_number':461,'multiline':False]['text':' Loads kube-system docker images. It is better to do it before starting kubelet,','line_number':465,'multiline':False]['text':' as kubelet will restart docker daemon, which may interfere with loading images.','line_number':466,'multiline':False]['text':' If we are on ubuntu we can try to install containerd','line_number':479,'multiline':False]['text':' bailout if we are not on ubuntu','line_number':481,'multiline':False]['text':' Install dependencies, some of these are already installed in the image but','line_number':487,'multiline':False]['text':' that's fine since they won't re-install and we can reuse the code below','line_number':488,'multiline':False]['text':' for another image someday.','line_number':489,'multiline':False]['text':' Add the Docker apt-repository (as we install containerd from there)','line_number':502,'multiline':False]['text':' shellcheck disable=SC2086','line_number':503,'multiline':False]['text':' Install containerd from Docker repo','line_number':512,'multiline':False]['text':' Override to latest versions of containerd and runc','line_number':517,'multiline':False]['text':' containerd versions have slightly different url(s), so try both','line_number':520,'multiline':False]['text':' shellcheck disable=SC2086','line_number':521,'multiline':False]['text':' shellcheck disable=SC2086','line_number':531,'multiline':False]['text':' Install containerd/runc if requested','line_number':581,'multiline':False]['text':' Fall back to installing distro specific containerd, if not found','line_number':586,'multiline':False]['text':' when custom containerd version is installed sourcing containerd_env.sh will add all tools like ctr to the PATH','line_number':603,'multiline':False]['text':' Verify presence and print versions of ctr, containerd, runc','line_number':608,'multiline':False]['text':'TODO: Add crio support','line_number':631,'multiline':False]['text':' Downloads kubernetes binaries and kube-system manifest tarball, unpacks them,','line_number':639,'multiline':False]['text':' and places them into suitable directories. Files are placed in /home/kubernetes.','line_number':640,'multiline':False]['text':' Copy docker_tag and image files to ${KUBE_HOME}/kube-docker-files.','line_number':662,'multiline':False]['text':' Some older images have LICENSES baked-in as a file. Presumably they will','line_number':679,'multiline':False]['text':' have the directory baked-in eventually.','line_number':680,'multiline':False]['text':' Put kube-system pods manifests in ${KUBE_HOME}/kube-manifests/.','line_number':696,'multiline':False]['text':' Install gci mounter related artifacts to allow mounting storage volumes in GCI','line_number':700,'multiline':False]['text':' Remount the Flexvolume directory with the "exec" option, if needed.','line_number':703,'multiline':False]['text':' When ENABLE_AUTH_PROVIDER_GCP is set, following flags for out-of-tree credential provider for GCP','line_number':708,'multiline':False]['text':' are presented to kubelet:','line_number':709,'multiline':False]['text':' --image-credential-provider-config=${path-to-config}','line_number':710,'multiline':False]['text':' --image-credential-provider-bin-dir=${path-to-auth-provider-binary}','line_number':711,'multiline':False]['text':' Also, it is required that DisableKubeletCloudCredentialProviders','line_number':712,'multiline':False]['text':' feature gate is set to true for kubelet to use external credential provider.','line_number':713,'multiline':False]['text':' Install out-of-tree auth-provider-gcp binary to enable kubelet to dynamically','line_number':715,'multiline':False]['text':' retrieve credentials for a container image registry.','line_number':716,'multiline':False]['text':' Install crictl on each node.','line_number':719,'multiline':False]['text':' Clean up.','line_number':722,'multiline':False]['text':' This function detects the platform/arch of the machine where the script runs,','line_number':729,'multiline':False]['text':' and sets the HOST_PLATFORM and HOST_ARCH environment variables accordingly.','line_number':730,'multiline':False]['text':' Callers can specify HOST_PLATFORM_OVERRIDE and HOST_ARCH_OVERRIDE to skip the detection.','line_number':731,'multiline':False]['text':' This function is adapted from the detect_client_info function in cluster/get-kube-binaries.sh','line_number':732,'multiline':False]['text':' and kube::util::host_os, kube::util::host_arch functions in hack/lib/util.sh','line_number':733,'multiline':False]['text':' This function should be synced with detect_host_info in ./configure-helper.sh','line_number':734,'multiline':False]['text':' Retries a command forever with a delay between retries.','line_number':765,'multiline':False]['text':' Args:','line_number':766,'multiline':False]['text':'  $1    : delay between retries, in seconds.','line_number':767,'multiline':False]['text':'  $2... : the command to run.','line_number':768,'multiline':False]['text':' Initializes variables used by the log-* functions.','line_number':779,'multiline':False]['text':'','line_number':780,'multiline':False]['text':' get-metadata-value must be defined before calling this function.','line_number':781,'multiline':False]['text':'','line_number':782,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':783,'multiline':False]['text':' should be duplicated there as well.','line_number':784,'multiline':False]['text':' Used by log-* functions.','line_number':786,'multiline':False]['text':' Sets an EXIT trap.','line_number':798,'multiline':False]['text':' Args:','line_number':799,'multiline':False]['text':'   $1:... : the trap command.','line_number':800,'multiline':False]['text':'','line_number':801,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':802,'multiline':False]['text':' should be duplicated there as well.','line_number':803,'multiline':False]['text':' shellcheck disable=2064','line_number':807,'multiline':False]['text':' Removes and restores an EXIT trap.','line_number':811,'multiline':False]['text':'','line_number':812,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':813,'multiline':False]['text':' should be duplicated there as well.','line_number':814,'multiline':False]['text':' Remove current trap.','line_number':816,'multiline':False]['text':' Restore previous trap.','line_number':819,'multiline':False]['text':'LOG_TRAP_STACK[@]} -ne 0 ]; then','line_number':820,'multiline':False]['text':' shellcheck disable=2064','line_number':822,'multiline':False]['text':' If no traps in stack, clear.','line_number':825,'multiline':False]['text':' Logs the end of a bootstrap step that errored.','line_number':830,'multiline':False]['text':' Args:','line_number':831,'multiline':False]['text':'  $1 : bootstrap step name.','line_number':832,'multiline':False]['text':'','line_number':833,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':834,'multiline':False]['text':' should be duplicated there as well.','line_number':835,'multiline':False]['text':' Wraps a command with bootstrap logging.','line_number':842,'multiline':False]['text':' Args:','line_number':843,'multiline':False]['text':'   $1    : bootstrap step name.','line_number':844,'multiline':False]['text':'   $2... : the command to run.','line_number':845,'multiline':False]['text':'','line_number':846,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':847,'multiline':False]['text':' should be duplicated there as well.','line_number':848,'multiline':False]['text':' Logs a bootstrap step start. Prefer log-wrap.','line_number':860,'multiline':False]['text':' Args:','line_number':861,'multiline':False]['text':'   $1 : bootstrap step name.','line_number':862,'multiline':False]['text':'','line_number':863,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':864,'multiline':False]['text':' should be duplicated there as well.','line_number':865,'multiline':False]['text':' Logs a bootstrap step end. Prefer log-wrap.','line_number':873,'multiline':False]['text':' Args:','line_number':874,'multiline':False]['text':'   $1 : bootstrap step name.','line_number':875,'multiline':False]['text':'','line_number':876,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':877,'multiline':False]['text':' should be duplicated there as well.','line_number':878,'multiline':False]['text':' Writes a log proto to stdout.','line_number':886,'multiline':False]['text':' Args:','line_number':887,'multiline':False]['text':'   $1: bootstrap step name.','line_number':888,'multiline':False]['text':'   $2: status. Either 'STARTED', 'COMPLETED', or 'ERROR'.','line_number':889,'multiline':False]['text':'   $3: optional status reason.','line_number':890,'multiline':False]['text':'','line_number':891,'multiline':False]['text':' NOTE: this function is duplicated in configure-helper.sh, any changes here','line_number':892,'multiline':False]['text':' should be duplicated there as well.','line_number':893,'multiline':False]['text':' Get current time.','line_number':899,'multiline':False]['text':' ...formatted as UTC RFC 3339.','line_number':902,'multiline':False]['text':' Calculate latency.','line_number':906,'multiline':False]['text':' Bash cannot do non-integer math, shell out to awk.','line_number':914,'multiline':False]['text':' The default latency is null which cannot be wrapped as a string so we must','line_number':917,'multiline':False]['text':' do it here instead of the printf.','line_number':918,'multiline':False]['text':'######## Main Function ##########','line_number':926,'multiline':False]['text':' if install fails, message-of-the-day (motd) will warn at login shell','line_number':932,'multiline':False]['text':' download and source kube-env','line_number':938,'multiline':False]['text':' master certs','line_number':944,'multiline':False]['text':' ensure chosen container runtime is present','line_number':949,'multiline':False]['text':' binaries and kube-system manifests','line_number':952,'multiline':False]