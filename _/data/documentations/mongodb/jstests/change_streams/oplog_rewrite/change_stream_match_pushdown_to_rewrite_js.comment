['text':' Test that a pipeline of the form [{$changeStream: {}}, {$match: ...}] can rewrite the 'to' and','line_number':1,'multiline':False]['text':' apply it to oplog-format documents in order to filter out results as early as possible.','line_number':2,'multiline':False]['text':' @tags: [','line_number':3,'multiline':False]['text':'   requires_fcv_51,','line_number':4,'multiline':False]['text':'   requires_pipeline_optimization,','line_number':5,'multiline':False]['text':'   requires_sharding,','line_number':6,'multiline':False]['text':'   uses_change_streams,','line_number':7,'multiline':False]['text':'   change_stream_does_not_expect_txns,','line_number':8,'multiline':False]['text':'   assumes_unsharded_collection,','line_number':9,'multiline':False]['text':'   assumes_read_preference_unchanged','line_number':10,'multiline':False]['text':' ]','line_number':11,'multiline':False]['text':' Enable a failpoint that will prevent $expr match expressions from generating $_internalExprEq','line_number':28,'multiline':False]['text':' or similar expressions. This ensures that the following test-cases only exercise the $expr','line_number':29,'multiline':False]['text':' rewrites.','line_number':30,'multiline':False]['text':' Create some new collections to ensure that test cases has sufficient namespaces to verify that','line_number':38,'multiline':False]['text':' the filtering on the 'to' field is working correctly.','line_number':39,'multiline':False]['text':' shardKey ','line_number':40,'multiline':True]['text':' splitAt ','line_number':40,'multiline':True]['text':' shardKey ','line_number':41,'multiline':True]['text':' splitAt ','line_number':41,'multiline':True]['text':' Open a change stream and store the resume token. This resume token will be used to replay the','line_number':46,'multiline':False]['text':' stream after this point.','line_number':47,'multiline':False]['text':' A helper that opens a change stream on the whole cluster with the user supplied match expression','line_number':51,'multiline':False]['text':' 'userMatchExpr' and validates that:','line_number':52,'multiline':False]['text':' 1. for each shard, the events are seen in that order as specified in 'expectedResult'','line_number':53,'multiline':False]['text':' 2. the filtering is been done at oplog level','line_number':54,'multiline':False]['text':' 3. the number of docs returned by the oplog cursor on each shard matches what we expect','line_number':55,'multiline':False]['text':'    as specified in 'expectedOplogRetDocsForEachShard'.','line_number':56,'multiline':False]['text':' The inserted documents purposely contain field name 'o.to' to match with that of oplog's 'to'','line_number':69,'multiline':False]['text':' field. These fields should not interfere with the rewritten predicate and only expected documents','line_number':70,'multiline':False]['text':' should be returned at the oplog level.','line_number':71,'multiline':False]['text':' This group of tests ensures that the '$match' on the 'to' object and equivalent '$expr'','line_number':83,'multiline':False]['text':' expression only sees its documents and only required document(s) are returned at the oplog for','line_number':84,'multiline':False]['text':' each shard.','line_number':85,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':88,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':91,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':94,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':97,'multiline':True]['text':' Ensure that the '$match' on the 'to' object and equivalent '$expr' expression with only db','line_number':99,'multiline':False]['text':' component should not emit any document and the oplog should not return any documents.','line_number':100,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':101,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':103,'multiline':True]['text':' Ensure that the 'to' object and equivalent '$expr' expression with 'unknown' collection does not','line_number':105,'multiline':False]['text':' exists and the oplog cursor returns 0 document.','line_number':106,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':108,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':111,'multiline':True]['text':' Ensure that the 'to' object and equivalent '$expr' expression with flipped fields does not match','line_number':113,'multiline':False]['text':' and the oplog cursor returns 0 document.','line_number':114,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':116,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':119,'multiline':True]['text':' Ensure that the 'to' object and equivalent '$expr' expression with extra fields does not match','line_number':121,'multiline':False]['text':' and the oplog cursor returns 0 document.','line_number':122,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':125,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':129,'multiline':True]['text':' Ensure that the empty 'to' object does not match and the oplog cursor returns 0 document.','line_number':131,'multiline':False]['text':' Ensure the '$match' on the db field path and equivalent '$expr' expression should only return','line_number':134,'multiline':False]['text':' documents with rename op type for all collections and oplog should also return same for each','line_number':135,'multiline':False]['text':' shard.','line_number':136,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':139,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':142,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':145,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':149,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':152,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':157,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':160,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':170,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':173,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':181,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':184,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':191,'multiline':True]['text':' Ensure that the '$match' on non-existing db and equivalent '$expr' expression should not return','line_number':193,'multiline':False]['text':' any document and oplog should not return any document for each shard.','line_number':194,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':195,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':197,'multiline':True]['text':' Ensure that the '$match' on empty db and equivalent '$expr' expression should not return any','line_number':199,'multiline':False]['text':' document and oplog should not return any document for each shard.','line_number':200,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':201,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':203,'multiline':True]['text':' Ensure that the '$match' on sub field of db and equivalent '$expr' expression should not return','line_number':205,'multiline':False]['text':' any document and oplog should not return any document for each shard.','line_number':206,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':208,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':211,'multiline':True]['text':' This group of tests ensures that the '$match' on collection field path and equivalent '$expr'','line_number':213,'multiline':False]['text':' expression should emit only the required documents and oplog should return only required','line_number':214,'multiline':False]['text':' document(s) for each shard.','line_number':215,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':218,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':221,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':224,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':227,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':230,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':233,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':236,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':239,'multiline':True]['text':' This group of tests ensures that the '$match' on the regex matching all collections and','line_number':241,'multiline':False]['text':' equivalent '$expr' expression should return documents with rename op type and oplog should also','line_number':242,'multiline':False]['text':' return same for each shard.','line_number':243,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':246,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':249,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':252,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':256,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':259,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':263,'multiline':True]['text':' Ensure that the '$match' on the regex to exclude 'coll1' and equivalent '$expr' expression should','line_number':265,'multiline':False]['text':' return only documents from 'coll2' and oplog should return required documents for each shard.','line_number':266,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':269,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':272,'multiline':True]['text':' Ensure that the '$match' on non-existing collection and equivalent '$expr' expression should not','line_number':274,'multiline':False]['text':' return any document and oplog should not return any document for each shard.','line_number':275,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':276,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':278,'multiline':True]['text':' Ensure that the '$match' on empty collection and equivalent '$expr' expression should not return','line_number':280,'multiline':False]['text':' any document and oplog should not return any document for each shard.','line_number':281,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':282,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':284,'multiline':True]['text':' Ensure that the '$match' on sub field of collection and equivalent '$expr' expression should not','line_number':286,'multiline':False]['text':' return any document and oplog should not return any document for each shard.','line_number':287,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':289,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':292,'multiline':True]['text':' Ensure that '$in' on db and equivalent '$expr' expression should return all documents with rename','line_number':294,'multiline':False]['text':' op type and oplog should also return same each shard.','line_number':295,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':298,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':301,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':304,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':316,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':319,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':331,'multiline':True]['text':' Ensure that an empty '$in' on db path and equivalent '$expr' expression should not match any','line_number':333,'multiline':False]['text':' collection and oplog should not return any document for each shard.','line_number':334,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':335,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':337,'multiline':True]['text':' Ensure that '$in' with invalid db cannot be rewritten and oplog should return all documents for','line_number':339,'multiline':False]['text':' each shard.','line_number':340,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':343,'multiline':True]['text':' Ensure that '$expr' with '$in' with one valid and one invalid db should return required documents','line_number':345,'multiline':False]['text':' at oplog for each shard.','line_number':346,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':349,'multiline':True]['text':' Ensure that '$in' on db path with mix of string and regex and equivalent '$expr' expression can','line_number':351,'multiline':False]['text':' be rewritten and oplog should return '0' document for each shard.','line_number':352,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':355,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':367,'multiline':True]['text':' Ensure that '$in' on multiple collections and equivalent '$expr' expression should return the','line_number':369,'multiline':False]['text':' required documents and oplog should return required documents for each shard.','line_number':370,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':374,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':380,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':383,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':386,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':389,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':401,'multiline':True]['text':' This group of tests ensures that '$in' on regex of matching all collections and equivalent','line_number':403,'multiline':False]['text':' '$expr' expression should return all documents with rename op type and oplog should also return','line_number':404,'multiline':False]['text':' same for each shard.','line_number':405,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':408,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':420,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':423,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':435,'multiline':True]['text':' Ensure that an empty '$in' should not match any collection and oplog should not return any','line_number':437,'multiline':False]['text':' document for each shard.','line_number':438,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':439,'multiline':True]['text':' Ensure that '$in' with invalid collection cannot be rewritten and oplog should return all','line_number':441,'multiline':False]['text':' documents for each shard.','line_number':442,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':445,'multiline':True]['text':' Ensure that '$expr' with '$in' with one valid and one invalid collection should return only','line_number':447,'multiline':False]['text':' required documents at the oplog for each shard.','line_number':448,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':451,'multiline':True]['text':' Ensure that '$in' with mix of string and regex matching collections and equivalent '$expr'','line_number':453,'multiline':False]['text':' expression can be rewritten and oplog should return required documents for each shard.','line_number':454,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':457,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':469,'multiline':True]['text':' Ensure that '$in' with mix of string and regex and equivalent '$expr' expression can be rewritten','line_number':471,'multiline':False]['text':' and oplog should return '0' document for each shard.','line_number':472,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':475,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':487,'multiline':True]['text':' This group of tests ensure that '$nin' on db path and equivalent '$expr' expression should return','line_number':489,'multiline':False]['text':' all documents and oplog should return all documents for each shard.','line_number':490,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':496,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':502,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':508,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':514,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':520,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':537,'multiline':True]['text':' These group of tests ensure that '$nin' on matching db name and equivalent '$expr' expression','line_number':539,'multiline':False]['text':' should not return any documents with rename op type and oplog should also return same each shard.','line_number':540,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':543,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':546,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':550,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':567,'multiline':True]['text':' Ensure that '$nin' on a collection and equivalent '$expr' expression should return the documents','line_number':569,'multiline':False]['text':' with only insert op type for that collection and oplog should also return same for each shard.','line_number':570,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':575,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':579,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':584,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':600,'multiline':True]['text':' Ensure that '$nin' on regex of matching all collections and equivalent '$expr' expression should','line_number':602,'multiline':False]['text':' only return documents with op type insert and oplog should also return same for each shard.','line_number':603,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':606,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':620,'multiline':True]['text':' Ensure that an empty '$nin' should match all collections and oplog should return all documents','line_number':622,'multiline':False]['text':' for each shard.','line_number':623,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':629,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':635,'multiline':True]['text':' Ensure that '$nin' with invalid collection cannot be rewritten and oplog should return all','line_number':637,'multiline':False]['text':' documents for each shard.','line_number':638,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':643,'multiline':True]['text':' Ensure that '$expr' with '$nin' with one valid and one invalid collection should return required','line_number':645,'multiline':False]['text':' documents at the oplog for each shard.','line_number':646,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':651,'multiline':True]['text':' Ensure that '$nin' with mix of string and regex and equivalent '$expr' expression can be','line_number':653,'multiline':False]['text':' rewritten and oplog should return required documents for each shard.','line_number':654,'multiline':False]['text':' expectedOplogRetDocsForEachShard','line_number':657,'multiline':True]['text':' expectedOplogRetDocsForEachShard','line_number':671,'multiline':True]