['text':' Test that sharded $lookup can resolve sharded views correctly.','line_number':1,'multiline':False]['text':' @tags: [requires_sharding, requires_fcv_51]','line_number':2,'multiline':False]['text':' Drop the 'profile' tables and then enable profiling on all shards.','line_number':17,'multiline':False]['text':' Create 'local' collection which will be backed by shard 1 from which we will run aggregations.','line_number':24,'multiline':False]['text':' Create first 'foreign' collection which will be backed by shard 2.','line_number':36,'multiline':False]['text':' Create second 'otherForeign' collection which will be backed by shard 3.','line_number':48,'multiline':False]['text':' To resolve view 'view1' defined on view 'view2' defined on collection 'coll', we would get a','line_number':61,'multiline':False]['text':' dependency chain of the form [view1, view2, coll] in the 'resolvedViews' field of the','line_number':62,'multiline':False]['text':' system.profile entry. This function combines all namespaces listed in the dependency chains of an','line_number':63,'multiline':False]['text':' aggregation's resolved views to produce a map counting how many times each namesapce was seen,','line_number':64,'multiline':False]['text':' e.g.: {"test.view1": 1, "test.view2": 1, "test.coll": 1}','line_number':65,'multiline':False]['text':' Count how many CommandOnShardedViewNotSupported exceptions we get and verify that they','line_number':90,'multiline':False]['text':' match the number we were expecting.','line_number':91,'multiline':False]['text':' In order to trigger CommandOnShardedViewNotSupportedOnMongod exceptions where a shard cannot','line_number':116,'multiline':False]['text':' resolve a view definition, ensure that:','line_number':117,'multiline':False]['text':' - 'local' is backed only by shard 1','line_number':118,'multiline':False]['text':' - 'foreign' is backed only by shard 2','line_number':119,'multiline':False]['text':' - 'otherForeign' is backed only by shard 3','line_number':120,'multiline':False]['text':' Create a view with an empty pipeline on 'local'.','line_number':125,'multiline':False]['text':' Create a view with an empty pipeline on 'foreign'.','line_number':129,'multiline':False]['text':' Create a view with an empty pipeline on 'otherForeign'.','line_number':133,'multiline':False]['text':' Create a view with a pipeline containing only a $match stage on 'foreign'.','line_number':137,'multiline':False]['text':' Create a view with a slightly more interesting pipeline on 'foreign'.','line_number':143,'multiline':False]['text':' Create a view on 'foreign' whose pipeline contains a $lookup on collection 'local'.','line_number':153,'multiline':False]['text':' Create a view whose pipeline contains a $lookup on a sharded view with fields to join on.','line_number':199,'multiline':False]['text':' Verify that we can resolve views containing a top-level $lookup targeted to other non-primary','line_number':222,'multiline':False]['text':' shards.','line_number':223,'multiline':False]['text':' Verify that we can resolve views containing nested $lookups targeted to other non-primary shards.','line_number':246,'multiline':False]['text':' TODO: SERVER-59911. After SERVER-59501, in the following queries the $lookup is sent to the','line_number':277,'multiline':False]['text':' primary, which can resolve the foreign views without triggering sharded view exceptions. If it is','line_number':278,'multiline':False]['text':' possible to parallelize $lookup when the foreign is a sharded view, the below queries should','line_number':279,'multiline':False]['text':' trigger a non-zero number of exceptions.','line_number':280,'multiline':False]['text':' Test that sharded view resolution works correctly with empty pipelines.','line_number':282,'multiline':False]['text':' Test that sharded view resolution works correctly with empty pipelines and a join field.','line_number':311,'multiline':False]['text':' Test that sharded view resolution works correctly with a simple view and a join field.','line_number':331,'multiline':False]['text':' Test that sharded view resolution works correctly with a simple view.','line_number':349,'multiline':False]['text':' Test that sharded view resolution works correctly with a view pipeline containing a $lookup with','line_number':475,'multiline':False]['text':' a join field.','line_number':476,'multiline':False]['text':' Test that sharded view resolution works correctly with a view pipeline containing a $lookup and a','line_number':499,'multiline':False]['text':' join field.','line_number':500,'multiline':False]['text':' Test that sharded view resolution works correctly with a $lookup on a view whose pipeline','line_number':521,'multiline':False]['text':' contains another $lookup.','line_number':522,'multiline':False]['text':' Test that $lookup with a subpipeline containing a non-correlated pipeline prefix can still use','line_number':542,'multiline':False]['text':' the cache after sharded view resolution.','line_number':543,'multiline':False]['text':' Add a chunk of the 'foreign' collection to shard1 (the rest is on shard2) to force a merge.','line_number':550,'multiline':False]['text':' The subpipeline only executes once on each of the shards containing the 'foreign' collection.','line_number':573,'multiline':False]['text':' For the StaleConfig error that resulted from moveChunk.','line_number':580,'multiline':False]['text':' For the StaleConfig error that resulted from moveChunk.','line_number':590,'multiline':False]