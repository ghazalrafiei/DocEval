['text':'
 * Tests that applyOps commands work correctly when the replica set endpoint is used.
 *
 * @tags: [
 *   requires_fcv_73,
 *   featureFlagEmbeddedRouter,
 *   featureFlagSecurityToken,
 *   requires_persistence
 * ]
 ','line_number':1,'multiline':True]['text':' Verify that applyOps works correctly on shard0.','line_number':31,'multiline':False]['text':' applyOps command is not supported in multitenancy mode.','line_number':35,'multiline':False]['text':' Currently, sharding isn't supported in serverless. So the cluster cannot become','line_number':45,'multiline':False]['text':' multi-shard.','line_number':46,'multiline':False]['text':' Add a second shard to the cluster.','line_number':51,'multiline':False]['text':' Run the addShard command against shard0's primary mongod instead to verify that','line_number':60,'multiline':False]['text':' replica set endpoint supports router commands.','line_number':61,'multiline':False]['text':' TODO (SERVER-83380): Connect to the router port on a shardsvr mongod instead.','line_number':69,'multiline':False]['text':' applyOps command is not supported on a router.','line_number':71,'multiline':False]['text':' Verify that applyOps works correctly on shard0 and shard1.','line_number':77,'multiline':False]['text':' shard0 has two documents for the test collection.','line_number':84,'multiline':False]['text':' shard1 has one document for the test collection.','line_number':89,'multiline':False]['text':' Remove the second shard (shard1) from the cluster. Note that on shard1 the test collection','line_number':93,'multiline':False]['text':' was created directly via the applyOps command above, i.e. without going through the router,','line_number':94,'multiline':False]['text':' so the config server doesn't know about the presence of the test collection on shard1 so','line_number':95,'multiline':False]['text':' the shard can be removed shard1 without draining those documents.','line_number':96,'multiline':False]['text':' Verify that applyOps works correctly on shard0.','line_number':105,'multiline':False]['text':' Add the second shard back but convert the config shard to dedicated config server.','line_number':114,'multiline':False]['text':' Drop the test collection from the shard since it is illegal to add a shard with a collection','line_number':115,'multiline':False]['text':' that already exists in the cluster (the removeShard command would fail with an','line_number':116,'multiline':False]['text':' OperationFailed error as verified below).','line_number':117,'multiline':False]['text':' Verify that applyOps works correctly on shard1.','line_number':129,'multiline':False]['text':' shard1 has one document for the test collection.','line_number':134,'multiline':False]['text':' shard0Primary ','line_number':151,'multiline':True]['text':' shard0Primary ','line_number':172,'multiline':True]['text':' TODO (SERVER-81968): Re-enable single-shard cluster test cases once config shards support','line_number':175,'multiline':False]['text':' embedded routers.','line_number':176,'multiline':False]['text':' {','line_number':177,'multiline':False]['text':'     jsTest.log("Running tests for a single-shard cluster");','line_number':178,'multiline':False]['text':'     const st = new ShardingTest({','line_number':179,'multiline':False]['text':'         shards: 1,','line_number':180,'multiline':False]['text':'         rs: {nodes: 2, setParameter: {featureFlagReplicaSetEndpoint: true}},','line_number':181,'multiline':False]['text':'         configShard: true,','line_number':182,'multiline':False]['text':'     });','line_number':183,'multiline':False]['text':'     const tearDownFunc = () => st.stop();','line_number':184,'multiline':False]['text':'     runTests(st.rs0.getPrimary() /* shard0Primary */, tearDownFunc);','line_number':186,'multiline':False]['text':' }','line_number':187,'multiline':False]['text':' For serverless, command against user collections require the "$tenant" field and auth.','line_number':191,'multiline':False]['text':' shard0Primary ','line_number':231,'multiline':True]['text':' isMultitenant ','line_number':231,'multiline':True]