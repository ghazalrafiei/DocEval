['text':'*
 * Test fixture which exposes several methods to test different pre-image truncate behaviors after
 * shutdown.
 *
 * After an unclean shutdown, all expired pre-images must be truncated on startup. This is because
 * WiredTiger truncate cannot guarantee a consistent view of previously truncated data on
 * unreplicated, untimestamped ranges after a crash. Unlike the oplog, which also does
 * untimestamped, unreplicated truncates, the pre-images collection is not logged and it's possible
 * that previously truncated documents can resurface after unclean shutdown.
 *
 * On an unclean shutdown, no preemptive truncation is necessary.
 *
 * Example Usage:
 *      const truncateAfterShutdownTest = new PreImageTruncateAfterShutdownTest(jsTestName());
 *      truncateAfterShutdownTest.setup();
 *      truncateAfterShutdownTest.testTruncateByExpireAfterSeconds({
 *          runAsPrimary: <>,
 *          numExpiredPreImages: <>,
 *          numUnexpiredPreImages: <>,
 *          cleanShutdown: <>,
 *      });
 *      ...
 *      truncateAfterShutdownTest.teardown();
 ','line_number':1,'multiline':True]['text':' The @private JSDoc comments cause VS Code to not display the corresponding properties and','line_number':39,'multiline':False]['text':' methods in its autocomplete list. This makes it simpler for test authors to know what the','line_number':40,'multiline':False]['text':' public interface of the ReshardingTest class is.','line_number':41,'multiline':False]['text':'* @private ','line_number':43,'multiline':True]['text':'* @private ','line_number':45,'multiline':True]['text':' Disable the 'ChangeStreamExpiredPreImagesRemover' to isolate the truncate','line_number':49,'multiline':False]['text':' after','line_number':50,'multiline':False]['text':' startup behavior from the periodic remover behavior.','line_number':51,'multiline':False]['text':' Oplog can be truncated each "sync" cycle. Increase its frequency to once per','line_number':54,'multiline':False]['text':' every 5 seconds to speed up tests which rely on oldest oplog timestamp expiry.','line_number':55,'multiline':False]['text':' Property set by setup().','line_number':60,'multiline':False]['text':'* @private ','line_number':61,'multiline':True]['text':'* 1MB ','line_number':67,'multiline':True]['text':' Allow test cases to have complete control over which node is primary.','line_number':70,'multiline':False]['text':'* @private ','line_number':78,'multiline':True]['text':' Inserts are replicated while truncates are not. If 'conn' is a secondary, await','line_number':80,'multiline':False]['text':' replication in case there were inserts.','line_number':81,'multiline':False]['text':' Checks if the oplog has been rolled over from the timestamp of 'lastOplogEntryTsToBeRemoved',','line_number':91,'multiline':False]['text':' ie. the timestamp of the first entry in the oplog is greater than the','line_number':92,'multiline':False]['text':' 'lastOplogEntryTsToBeRemoved' on each node of the replica set.','line_number':93,'multiline':False]['text':'* @private ','line_number':94,'multiline':True]['text':'* @private ','line_number':101,'multiline':True]['text':' Pre-images expire independently on each node. Expiration by oldest oplog timestamp','line_number':103,'multiline':False]['text':' depends on the oldest oplog timestamp of the 'nodeToRollover'.','line_number':104,'multiline':False]['text':' Oplog is rolled over by inserting many writes. Writes still must be done on the primary.','line_number':107,'multiline':False]['text':' Insert a base amount of documents to speed things up.','line_number':112,'multiline':False]['text':'* @private ','line_number':124,'multiline':True]['text':' Only after an unclean shutdown should preemptive truncation of pre-images happen.','line_number':132,'multiline':False]['text':' Pre-populates 2 pre-image enabled collections. The total number of pre-images adds up to','line_number':138,'multiline':False]['text':' 'numUnexpiredPreImages' unexpired pre-images and 'numExpiredPreImages' expired pre-images.','line_number':139,'multiline':False]['text':' 'expiryFn' is responsible simulating the expiration of all pre-images inserted at the time of','line_number':140,'multiline':False]['text':' it's execution.','line_number':141,'multiline':False]['text':'* @private ','line_number':142,'multiline':True]['text':' Do initial insert, then update to create a pre-image.','line_number':172,'multiline':False]['text':' Do initial insert, then update to create a pre-image.','line_number':185,'multiline':False]['text':' After shutdown, gets 'conn' to it's original state pre-shutdown and verifies the correct','line_number':192,'multiline':False]['text':' pre-images exist after shutdown.','line_number':193,'multiline':False]['text':'* @private ','line_number':194,'multiline':True]['text':' The pre-images collection cannot be checked until the restarted node starts accepting','line_number':202,'multiline':False]['text':' reads.','line_number':203,'multiline':False]['text':' The 'checkPreImageCollection' check relies on there being a writable primary.','line_number':211,'multiline':False]['text':'* @private ','line_number':226,'multiline':True]['text':'* @private ','line_number':238,'multiline':True]['text':' Common logic for testing truncate behavior of pre-images expired by the oldest oplog entry.','line_number':252,'multiline':False]['text':'','line_number':253,'multiline':False]['text':' 'restartFn': Shuts down the node tied to the original 'conn' and returns the new 'conn' of','line_number':254,'multiline':False]['text':' the node restarted in the replica set. If restarting under --repair mode, the return value','line_number':255,'multiline':False]['text':' will be ignored.','line_number':256,'multiline':False]['text':'* @private ','line_number':257,'multiline':True]['text':'* @private ','line_number':291,'multiline':True]['text':'* @private ','line_number':298,'multiline':True]['text':' Tests pre-image truncate behavior on 'conn' after shutdown when pre-image expiration is based','line_number':309,'multiline':False]['text':' on 'expireAfterSeconds'.','line_number':310,'multiline':False]['text':'','line_number':311,'multiline':False]['text':' 'runAsPrimary': Whether to test truncate behavior on the primary or the secondary.','line_number':312,'multiline':False]['text':' 'cleanShutdown': Whether the truncate behavior is tested after a clean or unclean shutdown.','line_number':313,'multiline':False]['text':' To ensure there are no inconsistent ranges after unclean shutdown, all pre-images within','line_number':335,'multiline':False]['text':' 10 seconds of expiry according to 'expireAfterSeconds' are also truncated after unlcean','line_number':336,'multiline':False]['text':' shutdown.','line_number':337,'multiline':False]['text':' Upon startup, the current time 'conn' uses to determine which pre-images to truncate, if','line_number':340,'multiline':False]['text':' any.','line_number':341,'multiline':False]['text':' Returns the 'operationTime' of the most recent pre-image, if there are any inserted.','line_number':344,'multiline':False]['text':' Otherwise, returns the 'operationTime' of a no-op ping.','line_number':345,'multiline':False]['text':' In the case of unclean shutdown, startup expands the truncate range to include','line_number':358,'multiline':False]['text':' all pre-images expired by 'expireAfterSeconds' along with more recent pre-images','line_number':359,'multiline':False]['text':' which were created within 'truncateAfterUncleanShutdownBufferSecs' of pre-images','line_number':360,'multiline':False]['text':' expired by 'expireAfterSeconds'.','line_number':361,'multiline':False]['text':'','line_number':362,'multiline':False]['text':' Fix the 'currentTimeToUseAfterStartup' so the current pre-images fall into the','line_number':363,'multiline':False]['text':' truncate range of startup after an unclean shutdown.','line_number':364,'multiline':False]['text':' Sleep 2 seconds to ensure any rounding done to convert the expiration date to a','line_number':369,'multiline':False]['text':' 'Timestamp' for range truncation doesn't include upcoming pre-image inserts.','line_number':370,'multiline':False]['text':' restart ','line_number':389,'multiline':True]['text':' Tests pre-image truncate behavior when pre-images expire according to the oldest oplog entry','line_number':402,'multiline':False]['text':' timestamp and a node is both shutdown and brought back up as a member of the replica set.','line_number':403,'multiline':False]['text':' 'recoverToOplogTimestamp' is only compatible when 'queryableBackupMode' is set.','line_number':440,'multiline':False]['text':' 'queryableBackupMode' isn't compatible with 'recoverFromOplogAsStandalone'.','line_number':443,'multiline':False]['text':' --repair is incompatible with all other options.','line_number':445,'multiline':False]['text':' --repair is not compatible with the rest of options.','line_number':458,'multiline':False]['text':' Finalize the restart options for standalone before shutting down in case  a timestamp is','line_number':462,'multiline':False]['text':' needed for 'recoverFromOplogAsStandalone'.','line_number':463,'multiline':False]['text':' Tests pre-image truncate behavior when a node in a replica set is shutdown, brought back up','line_number':480,'multiline':False]['text':' as a standalone, then rejoined as a replica set member.','line_number':481,'multiline':False]['text':'','line_number':482,'multiline':False]['text':' 'runAsPrimary': Whether to test truncate behavior on the primary or the secondary.','line_number':483,'multiline':False]['text':' 'cleanShutdown': Whether the truncate behavior is tested after a clean or unclean shutdown.','line_number':484,'multiline':False]['text':' 'restartWithQueryableBackup': Whether to restart node in standalone with','line_number':485,'multiline':False]['text':'/                             'queryableBackupMode'.','line_number':486,'multiline':False]['text':' 'restartWithRecoverToOplogTimestamp': Only applicable when 'restartWithQueryableBackup' is','line_number':487,'multiline':False]['text':'                              true. Indicates 'queryableBackupMode' should startup with a set','line_number':488,'multiline':False]['text':'                              'recoverToOplogTimestamp'.','line_number':489,'multiline':False]['text':' 'restartWithRecoverFromOplogAsStandalone': Whether to restart 'conn' in standalone with','line_number':490,'multiline':False]['text':'                              'recoverFromOplogAsStandalone' set to true.','line_number':491,'multiline':False]['text':' 'restartWithRepair': Whether to restart the node with --repair set. This option is not','line_number':492,'multiline':False]['text':'                              compatible with the others since the node will automatically','line_number':493,'multiline':False]['text':'                              shutdown once it is repaired.','line_number':494,'multiline':False]['text':' Restarts the node in standalone according to the specified restart parameters.','line_number':516,'multiline':False]['text':' Re-connects the node to the replica set before returning a new "conn".','line_number':517,'multiline':False]['text':' Start node up in standalone.','line_number':531,'multiline':False]['text':' --repair will shutdown the server after starting up. As a result, start it again but','line_number':536,'multiline':False]['text':' assuming a clean shutdown state.','line_number':537,'multiline':False]['text':' 'expireAfterSeconds' is incompatible with standalone mode because it requires using','line_number':560,'multiline':False]['text':' 'setClusterParameter'. Thus, all tests over restarting in standalone must rely on','line_number':561,'multiline':False]['text':' pre-images expiring by the oldest oplog timestamp.','line_number':562,'multiline':False]