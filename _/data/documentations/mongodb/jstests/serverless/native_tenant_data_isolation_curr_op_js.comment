['text':' Test that currentOp works as expected in a multitenant environment.','line_number':1,'multiline':False]['text':' @tags: [requires_fcv_62]','line_number':2,'multiline':False]['text':' Check for the 'insert' op(s) in the currOp output for 'tenantId' when issuing '$currentOp' in','line_number':13,'multiline':False]['text':' aggregation pipeline with a security token.','line_number':14,'multiline':False]['text':' Security token users are not allowed to pass "allUsers: true" because it requires having the','line_number':16,'multiline':False]['text':' "inprog" action type, which is only available to the "clusterMonitor" role. Security token','line_number':17,'multiline':False]['text':' users should not be allowed this role.','line_number':18,'multiline':False]['text':' Check for the 'insert' op(s) in the currOp output for 'tenantId' when issuing '$currentOp' in','line_number':28,'multiline':False]['text':' aggregation pipeline and passing '$tenant' to it.','line_number':29,'multiline':False]['text':' We pass "allUsers: true" in order to see ops run by other users, including the security token','line_number':31,'multiline':False]['text':' user. Passing $tenant will filter for only ops which belong to this tenant.','line_number':32,'multiline':False]['text':' Check for the 'insert' op(s) in the currOp output for 'tenantId' when issuing the currentOp','line_number':43,'multiline':False]['text':' command with a security token.','line_number':44,'multiline':False]['text':' Check for the 'insert' op in the currOp output for 'tenantId' when issuing the currentOp','line_number':55,'multiline':False]['text':' command with $tenant.','line_number':56,'multiline':False]['text':' Must be authenticated as a user with ActionType::useTenant in order to use $tenant.','line_number':91,'multiline':False]['text':' Create a non-privileged user for later use.','line_number':97,'multiline':False]['text':' Set the security token for kTenant on the connection to start.','line_number':117,'multiline':False]['text':' Run an insert for kTenant using a security token that will implicitly create a collection. We','line_number':121,'multiline':False]['text':' force the collection creation to hang so that we'll capture the insert in the currentOp output.','line_number':122,'multiline':False]['text':' Check that the 'insert' op shows up in the currOp output for 'kTenant' when issuing','line_number':134,'multiline':False]['text':' '$currentOp' in aggregation pipeline using both a security token and $tenant.','line_number':135,'multiline':False]['text':' expectedBatchSize ','line_number':136,'multiline':True]['text':' expectedBatchSize ','line_number':137,'multiline':True]['text':' Check that the 'insert' op shows up in the currOp output for 'kTenant' when issuing','line_number':139,'multiline':False]['text':' the currentOp command using both a security token and $tenant.','line_number':140,'multiline':False]['text':' expectedBatchSize ','line_number':141,'multiline':True]['text':' expectedBatchSize ','line_number':142,'multiline':True]['text':' Check that the other tenant does not see the op in any currentOp output.','line_number':144,'multiline':False]['text':' expectedBatchSize ','line_number':146,'multiline':True]['text':' expectedBatchSize ','line_number':147,'multiline':True]['text':' expectedBatchSize ','line_number':149,'multiline':True]['text':' expectedBatchSize ','line_number':151,'multiline':True]['text':' Drop the collection so we can re-create it below.','line_number':156,'multiline':False]['text':' Now, run an insert for kTenant using $tenant. It will also implicitly create a collection, and we','line_number':161,'multiline':False]['text':' similarly force the collection creation to hang so that we'll capture the insert in the currentOp','line_number':162,'multiline':False]['text':' output.','line_number':163,'multiline':False]['text':' Check that the 'insert' op does NOT show up in the currOp output for 'kTenant' when issuing','line_number':177,'multiline':False]['text':' '$currentOp' in aggregation pipeline using a security token. A security token user is not','line_number':178,'multiline':False]['text':' authorized to pass ""allUsers: true", so it can only see ops that it has actually run itself.','line_number':179,'multiline':False]['text':' In this case, the insert was issued by the "admin" user.','line_number':180,'multiline':False]['text':' expectedBatchSize ','line_number':181,'multiline':True]['text':' Check that the 'insert' op shows up in the currOp output for 'kTenant' when issuing','line_number':183,'multiline':False]['text':' '$currentOp' in aggregation pipeline using $tenant.','line_number':184,'multiline':False]['text':' expectedBatchSize ','line_number':185,'multiline':True]['text':' Check that the 'insert' op also does NOT show up in the currOp output for 'kTenant' when','line_number':187,'multiline':False]['text':' issuing the currentOp command, for the same reason as above.','line_number':188,'multiline':False]['text':' expectedBatchSize ','line_number':189,'multiline':True]['text':' Check that the 'insert' op shows up in the currOp output for 'kTenant' when issuing','line_number':191,'multiline':False]['text':' the currentOp command using $tenant.','line_number':192,'multiline':False]['text':' expectedBatchSize ','line_number':193,'multiline':True]['text':' Now, check that the other tenant does not see the op in any currentOp output.','line_number':195,'multiline':False]['text':' expectedBatchSize ','line_number':197,'multiline':True]['text':' expectedBatchSize ','line_number':198,'multiline':True]['text':' expectedBatchSize ','line_number':200,'multiline':True]['text':' expectedBatchSize ','line_number':202,'multiline':True]['text':' Now check that a privileged user can see this op using both $currentOp and the currentOp','line_number':204,'multiline':False]['text':' command when no tenantId is provided. The user currently authenticated on the adminDb','line_number':205,'multiline':False]['text':' connection has the "root" role.','line_number':206,'multiline':False]['text':' Check that a user without required privileges, i.e. not associated with kTenant, is not','line_number':219,'multiline':False]['text':' authorized to issue '$currentOp' for other users.','line_number':220,'multiline':False]['text':' Check that a user without required privileges, i.e. not associated with kTenant, is not','line_number':231,'multiline':False]['text':' authorized to issue the currentOp command for other users.','line_number':232,'multiline':False]['text':' Turn the failpoint off and wait for the create to finish.','line_number':237,'multiline':False]