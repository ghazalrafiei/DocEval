['text':'*
 * Tests that the on sharded clusters the analyzeShardKey command returns read and write
 * distribution metrics, but on replica sets it does not since query sampling is only supported on
 * sharded clusters at this point.
 *
 * @tags: [requires_fcv_71]
 ','line_number':1,'multiline':True]['text':' Generate commands and populate the expected metrics.','line_number':146,'multiline':False]['text':' Below are reads targeting a single shard.','line_number':177,'multiline':False]['text':' Below are reads targeting a variable number of shards.','line_number':241,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':248,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':264,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':276,'multiline':False]['text':' Below are reads targeting all shards.','line_number':283,'multiline':False]['text':' Below are writes targeting a single shard.','line_number':303,'multiline':False]['text':' This is a shard key update.','line_number':333,'multiline':False]['text':' Below are writes targeting a variable number of shards.','line_number':346,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':356,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':372,'multiline':False]['text':' For hashed sharding, range queries on the shard key target all shards.','line_number':389,'multiline':False]['text':' Below are writes targeting all shards.','line_number':397,'multiline':False]['text':'*
 * Repeatedly runs the analyzeShardKey command until the sample size expected by the test case is
 * reached, and returns the last metrics returned.
 ','line_number':410,'multiline':True]['text':' Make the database have two collections, one with query sampling enabled and one without.','line_number':451,'multiline':False]['text':' The sampled collection is used for testing the analyzeShardKey metrics. The non-sampled','line_number':452,'multiline':False]['text':' collection is used as the local collection when running aggregate commands with $lookup','line_number':453,'multiline':False]['text':' against the sampled collection.','line_number':454,'multiline':False]['text':' Verify that the analyzeShardKey command fails while calculating the read and write','line_number':468,'multiline':False]['text':' distribution if the cardinality of the shard key is lower than analyzeShardKeyNumRanges.','line_number':469,'multiline':False]['text':' Insert documents into the sampled collection. The range of values is selected such that the','line_number':474,'multiline':False]['text':' documents will be distributed across all the shards if the collection is sharded.','line_number':475,'multiline':False]['text':' Verify that the analyzeShardKey command returns zeros for the read and write sample size','line_number':486,'multiline':False]['text':' when there are no sampled queries.','line_number':487,'multiline':False]['text':' Turn on query sampling and wait for sampling to become active.','line_number':492,'multiline':False]['text':' Create and run test queries.','line_number':497,'multiline':False]['text':' Turn off query sampling and wait for sampling to become inactive. The wait is necessary for','line_number':503,'multiline':False]['text':' preventing the internal aggregate commands run by the analyzeShardKey commands below from','line_number':504,'multiline':False]['text':' getting sampled.','line_number':505,'multiline':False]['text':' Verify that the metrics are as expected.','line_number':511,'multiline':False]['text':' Drop the sampled collection without removing its config.sampledQueries and','line_number':515,'multiline':False]['text':' config.sampledQueriesDiff documents to get test coverage for analyzing shard keys for a','line_number':516,'multiline':False]['text':' collection that has gone through multiple incarnations. That is, if the analyzeShardKey','line_number':517,'multiline':False]['text':' command filters those documents by ns instead of collection uuid, it would return','line_number':518,'multiline':False]['text':' incorrect metrics.','line_number':519,'multiline':False]['text':' Make the periodic jobs for refreshing sample rates and writing sampled queries and diffs have a','line_number':523,'multiline':False]['text':' period of 1 second to speed up the test.','line_number':524,'multiline':False]['text':' To speed up the test, make the split point documents expire right away. To prevent the split','line_number':536,'multiline':False]['text':' point documents from being deleted while the analyzeShardKey command is still running, make','line_number':537,'multiline':False]['text':' the TTL monitor have a large sleep interval at first and then lower it at the end of the test','line_number':538,'multiline':False]['text':' when verifying that the documents do get deleted by the TTL monitor.','line_number':539,'multiline':False]['text':' Test sampling on multiple mongoses.','line_number':552,'multiline':False]['text':' This test expects every query to get sampled regardless of which mongos or mongod routes it.','line_number':562,'multiline':False]['text':' Set up the sharded collection. Make it have three chunks:','line_number':576,'multiline':False]['text':' shard0: [MinKey, -1000]','line_number':577,'multiline':False]['text':' shard1: [-1000, 1000]','line_number':578,'multiline':False]['text':' shard2: [1000, MaxKey]','line_number':579,'multiline':False]['text':' Note that {x: 1} is the current shard key for the sharded collection being tested.','line_number':606,'multiline':False]['text':' Verify the split point documents are eventually deleted by the TTL monitor.','line_number':612,'multiline':False]['text':' TODO: SERVER-80318 Remove block','line_number':622,'multiline':False]['text':' This test expects every query to get sampled regardless of which mongod it runs against.','line_number':631,'multiline':False]['text':' No setup is needed.','line_number':639,'multiline':False]['text':' Verify the split point documents are eventually deleted by the TTL monitor.','line_number':658,'multiline':False]