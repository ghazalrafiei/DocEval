['text':'*
 * Tests to validate the functionality of update command in the presence of a compound shard key.
 *
 * @tags: [
 *   uses_multi_shard_transaction,
 *   uses_transactions,
 * ]
 ','line_number':1,'multiline':True]['text':' Make sure that shard0, shard1 and shard2 has _id 0,1 and 2 documents respectively.','line_number':38,'multiline':False]['text':' Skip find based validation for pipleline update.','line_number':58,'multiline':False]['text':' Make sure that the update modified the document with the given _id.','line_number':64,'multiline':False]['text':'*
 * For upserts this will insert a new document, for non-upserts it will be a no-op.
 ','line_number':69,'multiline':True]['text':' Skip find based validation for pipleline update or when inside a transaction.','line_number':80,'multiline':False]['text':' Make sure that the upsert inserted the correct document or update did not insert','line_number':84,'multiline':False]['text':' anything.','line_number':85,'multiline':False]['text':'*
 * Updates to a document's shard key that would change the document's owning shard will succeed if
 * the updateDocumentShardKeyUsingTransactionApi feature flag is enabled.
 ','line_number':90,'multiline':True]['text':'','line_number':106,'multiline':False]['text':' Update Type Replacement-style.','line_number':107,'multiline':False]['text':'','line_number':108,'multiline':False]['text':' Test behaviours common to update and upsert.','line_number':110,'multiline':False]['text':' Full shard key in query matches the update document.','line_number':114,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in the','line_number':118,'multiline':False]['text':' same shard as the targeted shard. For non-upserts, it will be a no-op.','line_number':119,'multiline':False]['text':'','line_number':124,'multiline':False]['text':' Test behaviours specific to non-upsert updates.','line_number':125,'multiline':False]['text':'','line_number':126,'multiline':False]['text':' Partial shard key in query can target a single shard, and shard key of existing document is','line_number':128,'multiline':False]['text':' the same as the replacement's.','line_number':129,'multiline':False]['text':' Parital shard key in the query, update succeeds with no op when there is no matching document','line_number':133,'multiline':False]['text':' for the query.','line_number':134,'multiline':False]['text':' Shard key field modifications do not have to specify full shard key.','line_number':139,'multiline':False]['text':' Partial shard key in query can target a single shard, but fails while attempting to','line_number':141,'multiline':False]['text':' modify shard key value.','line_number':142,'multiline':False]['text':' Full shard key in query, matches no document.','line_number':152,'multiline':False]['text':' Partial shard key in query, but can still target a single shard.','line_number':155,'multiline':False]['text':' Partial shard key in query cannot target a single shard, targeting happens using update','line_number':158,'multiline':False]['text':' document.','line_number':159,'multiline':False]['text':' When query doesn't match any doc.','line_number':161,'multiline':False]['text':' When query matches a doc and updates sucessfully.','line_number':165,'multiline':False]['text':' Shard key field modifications do not have to specify full shard key.','line_number':169,'multiline':False]['text':' Shard testColl on {x:1}, split it at {x:0}, and move chunk {x:1} to shard1. This collection','line_number':174,'multiline':False]['text':' is used to for the update below which would use the write without shard key protocol, but','line_number':175,'multiline':False]['text':' since the query is unspecified, any 1 random document could be modified. In order to not','line_number':176,'multiline':False]['text':' break the state of the original test collection, 'testColl' is used specifically for the','line_number':177,'multiline':False]['text':' single update below.','line_number':178,'multiline':False]['text':' TODO: SERVER-67429 Remove this try/catch since we can run in all configurations.','line_number':184,'multiline':False]['text':' If we have a WouldChangeOwningShard update and we aren't running as a retryable','line_number':185,'multiline':False]['text':' write or in a transaction, then this is an acceptable error.','line_number':186,'multiline':False]['text':' If a WouldChangeOwningShard update is performed not as a retryable write or in a','line_number':195,'multiline':False]['text':' transaction, expect an error.','line_number':196,'multiline':False]['text':' When query matches a doc and fails to update because shard key needs to be updated.','line_number':204,'multiline':False]['text':'','line_number':212,'multiline':False]['text':' Test upsert-specific behaviours.','line_number':213,'multiline':False]['text':'','line_number':214,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in a shard','line_number':216,'multiline':False]['text':' other than the one targeted by the update. These upserts can only succeed when the','line_number':217,'multiline':False]['text':' updateDocumentShardKeyUsingTransactionApi feature flag is enabled or if not enabled, when the','line_number':218,'multiline':False]['text':' upsert is run in a multi-statement transaction or with retryWrites: true.','line_number':219,'multiline':False]['text':'isUpsert','line_number':237,'multiline':True]['text':'inTransaction','line_number':237,'multiline':True]['text':' Shard key field modifications do not have to specify full shard key.','line_number':241,'multiline':False]['text':' Query on partial shard key.','line_number':243,'multiline':False]['text':' isUpsert ','line_number':246,'multiline':True]['text':' inTransaction ','line_number':247,'multiline':True]['text':' isUpsert ','line_number':250,'multiline':True]['text':' inTransaction ','line_number':251,'multiline':True]['text':' Query on partial shard key with _id.','line_number':253,'multiline':False]['text':' isUpsert ','line_number':256,'multiline':True]['text':' inTransaction ','line_number':257,'multiline':True]['text':' isUpsert ','line_number':260,'multiline':True]['text':' inTransaction ','line_number':261,'multiline':True]['text':' Query on only _id.','line_number':263,'multiline':False]['text':' isUpsert ','line_number':265,'multiline':True]['text':' inTransaction ','line_number':265,'multiline':True]['text':' isUpsert ','line_number':268,'multiline':True]['text':' inTransaction ','line_number':269,'multiline':True]['text':' Full shard key not specified in query.','line_number':271,'multiline':False]['text':' Query on partial shard key.','line_number':273,'multiline':False]['text':' Query on partial shard key with _id.','line_number':283,'multiline':False]['text':' Query on only _id.','line_number':294,'multiline':False]['text':'','line_number':304,'multiline':False]['text':' Update Type Op-style.','line_number':305,'multiline':False]['text':'','line_number':306,'multiline':False]['text':' Test behaviours common to update and upsert.','line_number':308,'multiline':False]['text':' Full shard key in query.','line_number':312,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in the','line_number':316,'multiline':False]['text':' same shard as the targetted shard. For non-upserts, it will be a no op.','line_number':317,'multiline':False]['text':' Test behaviours specific to non-upsert updates.','line_number':322,'multiline':False]['text':' Full shard key in query, matches no document.','line_number':324,'multiline':False]['text':' Partial shard key in query, but can still target a single shard.','line_number':328,'multiline':False]['text':' Query on _id works for update.','line_number':332,'multiline':False]['text':' Parital shard key in the query targets single shard. Update succeeds with no op when there is','line_number':336,'multiline':False]['text':' no matching document for the query.','line_number':337,'multiline':False]['text':' Partial shard key in query can target a single shard and doesn't try to update shard key','line_number':343,'multiline':False]['text':' value.','line_number':344,'multiline':False]['text':' Shard key field modifications do not have to specify full shard key.','line_number':348,'multiline':False]['text':' Partial shard key in query can target a single shard, but fails while attempting to modify','line_number':354,'multiline':False]['text':' shard key value.','line_number':355,'multiline':False]['text':' Test upsert-specific behaviours.','line_number':366,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in a shard','line_number':368,'multiline':False]['text':' other than the one targeted by the update. These upserts can only succeed when the','line_number':369,'multiline':False]['text':' updateDocumentShardKeyUsingTransactionApi feature flag is enabled or if not enabled, when the','line_number':370,'multiline':False]['text':' upsert is run in a multi-statement transaction or with retryWrites: true.','line_number':371,'multiline':False]['text':' Shard key field modifications do not have to specify full shard key.','line_number':390,'multiline':False]['text':' Partial shard key updates are successful.','line_number':392,'multiline':False]['text':' isUpsert ','line_number':394,'multiline':True]['text':' inTransaction ','line_number':394,'multiline':True]['text':' isUpsert ','line_number':397,'multiline':True]['text':' inTransaction ','line_number':398,'multiline':True]['text':' isUpsert ','line_number':400,'multiline':True]['text':' inTransaction ','line_number':400,'multiline':True]['text':' Upserts that match on _id are successful.','line_number':402,'multiline':False]['text':' isUpsert ','line_number':405,'multiline':True]['text':' inTransaction ','line_number':406,'multiline':True]['text':' isUpsert ','line_number':409,'multiline':True]['text':' inTransaction ','line_number':410,'multiline':True]['text':' Partial shard key can target single shard. This style of update can work if SERVER-41243 is','line_number':417,'multiline':False]['text':' implemented.','line_number':418,'multiline':False]['text':' Partial shard key cannot target single shard.','line_number':428,'multiline':False]['text':'','line_number':437,'multiline':False]['text':' Update with pipeline.','line_number':438,'multiline':False]['text':'','line_number':439,'multiline':False]['text':' Test behaviours common to update and upsert.','line_number':441,'multiline':False]['text':' Full shard key in query.','line_number':445,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in the','line_number':465,'multiline':False]['text':' same shard as the targeted shard.','line_number':466,'multiline':False]['text':' Test behaviours specific to non-upsert updates.','line_number':482,'multiline':False]['text':' Full shard key in query, matches no document.','line_number':484,'multiline':False]['text':' Partial shard key in query targets single shard but doesn't match any document on that shard.','line_number':497,'multiline':False]['text':' Partial shard key in query can target a single shard and doesn't try to update shard key','line_number':500,'multiline':False]['text':' value.','line_number':501,'multiline':False]['text':' Shard key field modifications do not have to specify full shard key.','line_number':506,'multiline':False]['text':' Partial shard key in query cannot target a single shard.','line_number':511,'multiline':False]['text':' Test upsert-specific behaviours.','line_number':517,'multiline':False]['text':' Case when upsert needs to insert a new document and the new document should belong in a shard','line_number':519,'multiline':False]['text':' other than the one targeted by the update. These upserts can only succeed when run in a','line_number':520,'multiline':False]['text':' multi-statement transaction or with retryWrites: true or if the','line_number':521,'multiline':False]['text':' updateDocumentShardKeyUsingTransactionApi feature flag is enabled.','line_number':522,'multiline':False]['text':' isUpsert ','line_number':562,'multiline':True]['text':' inTransaction ','line_number':563,'multiline':True]['text':' isUpsert ','line_number':573,'multiline':True]['text':' inTransaction ','line_number':574,'multiline':True]['text':' Full shard key not specified in query.','line_number':576,'multiline':False]