['text':'*
 * Loading this file overrides DB.prototype._runCommandImpl with a function that converts any
 * attempt to run $changeStream on a single collection into a whole-db $changeStream filtered by
 * that namespace. Single-collection $changeStream rules regarding internal collections and views
 * are respected. Explicit whole-db or whole-cluster $changeStreams, as well as non-$changeStream
 * commands and commands which explicitly request to be exempted from modification by setting the
 * 'noPassthrough' flag, are passed through as-is.
 ','line_number':1,'multiline':True]['text':' Helper function which tests can call to explicitly request that the command not be modified by','line_number':13,'multiline':False]['text':' the passthrough code. When defined, ChangeStreamTest will adopt this as its default runCommand','line_number':14,'multiline':False]['text':' implementation to allow individual tests to exempt themselves from modification.','line_number':15,'multiline':False]['text':' Defines a set of functions to validate incoming $changeStream requests and transform','line_number':19,'multiline':False]['text':' single-collection streams into equivalent whole-db streams. Separating these functions allows the','line_number':20,'multiline':False]['text':' runCommand override to generically upconvert $changeStream requests, and the','line_number':21,'multiline':False]['text':' ChangeStreamPassthroughHelpers may themselves be overridden by other passthroughs in order to','line_number':22,'multiline':False]['text':' alter the behaviour of runCommand.','line_number':23,'multiline':False]['text':' Determine whether this command is a valid $changeStream aggregation on a single','line_number':26,'multiline':False]['text':' collection or database.','line_number':27,'multiline':False]['text':' Single-collection and whole-db streams cannot be opened on internal databases.','line_number':33,'multiline':False]['text':' If the client's $changeStream spec already contains everything we intend to modify, pass','line_number':37,'multiline':False]['text':' the command through as-is.','line_number':38,'multiline':False]['text':' The remaining checks are only relevant to single-collection streams. If the 'aggregate'','line_number':45,'multiline':False]['text':' field of the command object is not a string, validate that it is equal to 1.','line_number':46,'multiline':False]['text':' Single-collection streams cannot be opened on internal collections in any database.','line_number':50,'multiline':False]['text':' Single-collection streams cannot be opened on views.','line_number':54,'multiline':False]['text':' This is a well-formed request.','line_number':58,'multiline':False]['text':' All valid single-collection change stream requests are upconvertable in this passthrough.','line_number':61,'multiline':False]['text':' Take a copy of the command object such that the original is not altered.','line_number':85,'multiline':False]['text':' To convert this command into a whole-db stream, we insert a $match stage just after','line_number':88,'multiline':False]['text':' the $changeStream stage that filters by database and collection name, and we update','line_number':89,'multiline':False]['text':' the command's execution 'namespace' to 1.','line_number':90,'multiline':False]['text':' Check whether this command is an upconvertable $changeStream request. If the command is an','line_number':116,'multiline':False]['text':' explain, we check the wrapped command object.','line_number':117,'multiline':False]['text':' If this is an explain, put the upconverted agg back into the explain command.','line_number':127,'multiline':False]['text':' If the command is a getMore, it may be a $changeStream that we upconverted to run','line_number':134,'multiline':False]['text':' whole-db. Ensure that we update the 'collection' field to be the collectionless','line_number':135,'multiline':False]['text':' namespace.','line_number':136,'multiline':False]['text':' Pass the modified command to the original runCommand implementation.','line_number':142,'multiline':False]['text':' Record the upconverted cursor ID so that we can adjust subsequent getMores.','line_number':145,'multiline':False]['text':' Redirect the Collection's 'watch' function to use the whole-DB version. Although calls to the','line_number':153,'multiline':False]['text':' shell helpers will ultimately resolve to the overridden runCommand anyway, we need to','line_number':154,'multiline':False]['text':' override the helpers to ensure that the DB.watch function itself is exercised by the','line_number':155,'multiline':False]['text':' passthrough wherever Collection.watch is called.','line_number':156,'multiline':False]['text':' Override DB.runCommand to use the custom or original _runCommandImpl.','line_number':164,'multiline':False]