['text':'!/usr/bin/env python3','line_number':1,'multiline':False]['text':' The MongoDB names for the architectures we support.','line_number':44,'multiline':False]['text':' Made up names for the flavors of distribution we package for.','line_number':47,'multiline':False]['text':' Commit-triggerd version numbers can be in the form: 3.0.7-pre-, or 3.0.7-5-g3b67ac','line_number':60,'multiline':False]['text':' Patch builds version numbers are in the form: 3.5.5-64-g03945fa-patch-58debcdb3ff1223c9d00005b','line_number':61,'multiline':False]['text':'','line_number':62,'multiline':False]['text':' FIXME: this is wrong, but I'm in a hurry.','line_number':101,'multiline':False]['text':' e.g., "1.8.2" < "1.8.10", "1.8.2" < "1.8.2-rc1"','line_number':102,'multiline':False]['text':' NOTE: This is only called for RPM packages, and only after','line_number':114,'multiline':False]['text':' pversion() below has been called. If you want to change this format','line_number':115,'multiline':False]['text':' and want DEB packages to match, make sure to update pversion()','line_number':116,'multiline':False]['text':' below','line_number':117,'multiline':False]['text':'','line_number':118,'multiline':False]['text':' "N" is either passed in on the command line, or "1"','line_number':119,'multiline':False]['text':' Version suffix for RPM packages:','line_number':125,'multiline':False]['text':' 1) RC's - "0.N.rcX"','line_number':126,'multiline':False]['text':' 2) Nightly (snapshot) - "0.N.latest"','line_number':127,'multiline':False]['text':' 3) Patch builds - "0.N.patch.<patch_id>"','line_number':128,'multiline':False]['text':' 4) Standard release - "N"','line_number':129,'multiline':False]['text':' Note: Debian packages have funny rules about dashes in','line_number':140,'multiline':False]['text':' version numbers, and RPM simply forbids dashes.  pversion','line_number':141,'multiline':False]['text':' will be the package's version number (but we need to know','line_number':142,'multiline':False]['text':' our upstream version too).','line_number':143,'multiline':False]['text':' For RPM packages this just returns X.Y.X because of the','line_number':145,'multiline':False]['text':' aforementioned rules, and prelease (above) adds a suffix later,','line_number':146,'multiline':False]['text':' so detect this case early','line_number':147,'multiline':False]['text':' For DEB packages, this code sets the full version. If you change','line_number':151,'multiline':False]['text':' this format and want RPM packages to match make sure you change','line_number':152,'multiline':False]['text':' prelease above as well','line_number':153,'multiline':False]['text':' noqa: D406,D407,D412,D413','line_number':221,'multiline':False]['text':' Community builds only support amd64','line_number':341,'multiline':False]['text':' Where to do all of our work. Use a randomly-created directory if one','line_number':435,'multiline':False]['text':' is not passed in.','line_number':436,'multiline':False]['text':' Build a package for each distro/spec/arch tuple, and','line_number':444,'multiline':False]['text':' accumulate the repository-layout directories.','line_number':445,'multiline':False]['text':' The setupdir will be a directory containing all inputs to the','line_number':501,'multiline':False]['text':' distro's packaging tools (e.g., package metadata files, init','line_number':502,'multiline':False]['text':' scripts, etc), along with the already-built binaries).  In case','line_number':503,'multiline':False]['text':' the following format string is unclear, an example setupdir','line_number':504,'multiline':False]['text':' would be dst/x86_64/debian-sysvinit/wheezy/mongodb-org-unstable/','line_number':505,'multiline':False]['text':' or dst/x86_64/redhat/rhel55/mongodb-org-unstable/','line_number':506,'multiline':False]['text':' Note: POSIX tar doesn't require support for gtar's "-C" option,','line_number':515,'multiline':False]['text':' and Python's tarfile module prior to Python 2.7 doesn't have the','line_number':516,'multiline':False]['text':' features to make this detail easy.  So we'll just do the dumb','line_number':517,'multiline':False]['text':' thing and chdir into where and run tar there.','line_number':518,'multiline':False]['text':' Note that the RPM packages get their man pages from the debian','line_number':542,'multiline':False]['text':' directory, so the debian directory is needed in all cases (and','line_number':543,'multiline':False]['text':' innocuous in the debianoids' sdirs).','line_number':544,'multiline':False]['text':' FIXME: sh-dash-cee is bad. See if tarfile can do this.','line_number':547,'multiline':False]['text':' Splat the binaries under sdir.  The "build" stages of the','line_number':552,'multiline':False]['text':' packaging infrastructure will move the files to wherever they','line_number':553,'multiline':False]['text':' need to go.','line_number':554,'multiline':False]['text':' I can't remember the details anymore, but the initscript/upstart','line_number':572,'multiline':False]['text':' job files' names must match the package name in some way; and','line_number':573,'multiline':False]['text':' see also the --name flag to dh_installinit in the generated','line_number':574,'multiline':False]['text':' debian/rules file.','line_number':575,'multiline':False]['text':' Rewrite the control and rules files','line_number':595,'multiline':False]['text':' old non-server-package postinst will be hanging around for old versions','line_number':606,'multiline':False]['text':'','line_number':607,'multiline':False]['text':' copy our postinst files','line_number':611,'multiline':False]['text':'','line_number':612,'multiline':False]['text':' Empty for now. This makes it easier to add substvars to packages','line_number':616,'multiline':False]['text':' later on if we need it.','line_number':617,'multiline':False]['text':' Do the packaging.','line_number':624,'multiline':False]['text':' FIXME: see if shutil.copyfile or something can do this without','line_number':633,'multiline':False]['text':' much pain.','line_number':634,'multiline':False]['text':' Note: the Debian repository Packages files must be generated','line_number':641,'multiline':False]['text':' very carefully in order to be usable.','line_number':642,'multiline':False]['text':' Notes: the Release{,.gpg} files must live in a special place,','line_number':659,'multiline':False]['text':' and must be created after all the Packages.gz files have been','line_number':660,'multiline':False]['text':' done.','line_number':661,'multiline':False]['text':' Find all the stuff in src/*, move it to a freshly-created','line_number':687,'multiline':False]['text':' directory beside dst, then play some games with symlinks so that','line_number':688,'multiline':False]['text':' dst is a name the new stuff and dst+".old" names the previous','line_number':689,'multiline':False]['text':' one.  This feels like a lot of hooey for something so trivial.','line_number':690,'multiline':False]['text':' First, make a crispy fresh new directory to put the stuff in.','line_number':692,'multiline':False]['text':' Put the stuff in our new directory.','line_number':708,'multiline':False]['text':' Make a symlink to the new directory; the symlink will be renamed','line_number':712,'multiline':False]['text':' to dst shortly.','line_number':713,'multiline':False]['text':' as exc: # Python >2.5','line_number':720,'multiline':False]['text':' Make a symlink to the old directory; this symlink will be','line_number':728,'multiline':False]['text':' renamed shortly, too.','line_number':729,'multiline':False]['text':' as exc: # Python >2.5','line_number':738,'multiline':False]['text':' get the original HEAD position of repo','line_number':758,'multiline':False]['text':' add and commit the uncommited changes','line_number':761,'multiline':False]['text':' only commit changes if there are any','line_number':764,'multiline':False]['text':' original command to preserve functionality','line_number':770,'multiline':False]['text':' FIXME: make consistent with the rest of the code when we have more packaging testing','line_number':771,'multiline':False]['text':' reset branch to original state','line_number':778,'multiline':False]['text':' If the first line starts with "mongodb", it's not a revision','line_number':784,'multiline':False]['text':' preamble, and so frob the version number.','line_number':785,'multiline':False]['text':' Rewrite every changelog entry starting in mongodb<space>','line_number':788,'multiline':False]['text':' The Debian directory is here for the manpages so we we need to remove the service file','line_number':804,'multiline':False]['text':' from it so that RPM packages don't end up with the Debian file.','line_number':805,'multiline':False]['text':' Swap out systemd files, different systemd spec files, and init scripts as needed based on','line_number':808,'multiline':False]['text':' underlying os version. Arranged so that new distros moving forward automatically use','line_number':809,'multiline':False]['text':' systemd. Note: the SUSE init packages use a different init script than then other RPM','line_number':810,'multiline':False]['text':' distros.','line_number':811,'multiline':False]['text':'','line_number':812,'multiline':False]['text':' Places the RPM Spec file where it's expected for the rpmbuild execution later.','line_number':831,'multiline':False]['text':' Do the build.','line_number':844,'multiline':False]['text':' Versions of RPM after 4.4 ignore our BuildRoot tag so we need to','line_number':857,'multiline':False]['text':' specify it on the command line args to rpmbuild','line_number':858,'multiline':False]['text':' FIXME: see if some combination of shutil.copy<hoohah> and glob','line_number':870,'multiline':False]['text':' can do this without shelling out.','line_number':871,'multiline':False]['text':' as exc: # Python >2.5','line_number':891,'multiline':False]